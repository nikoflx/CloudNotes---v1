<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes v1 (Ultimate)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f0f5;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-hover: rgba(99, 102, 241, 0.2);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #262626;
            --text-primary: #f5f5f5;
            --text-secondary: #9ca3af;
            --accent: #818cf8;
            --accent-hover: #6366f1;
            --accent-light: rgba(129, 140, 248, 0.15);
            --border: #2d2d2d;
            --shadow: rgba(0, 0, 0, 0.4);
            --shadow-hover: rgba(129, 140, 248, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 10px var(--shadow);
        }

        .sidebar-header {
            padding: 30px 24px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent-light), transparent);
        }

        .app-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .app-author {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        /* New 'Why Us?' Button Style */
        .why-us-btn {
            display: block;
            width: 100%;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--accent);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--accent);
            box-shadow: 0 2px 8px var(--shadow-hover);
            text-align: center;
        }

        .why-us-btn:hover {
            background: var(--accent);
            color: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .why-us-btn:active {
            transform: translateY(0);
        }
        /* End New 'Why Us?' Button Style */

        .toolbar {
            padding: 20px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            padding: 10px 14px;
            font-size: 18px;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .folders-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .folders-container::-webkit-scrollbar {
            width: 6px;
        }

        .folders-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .folder-item {
            padding: 14px 18px;
            margin: 6px 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 2px solid transparent;
        }

        .folder-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(6px);
            border-color: var(--accent-light);
        }

        .folder-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateX(6px);
        }

        .folder-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .folder-item:hover .folder-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .folder-name {
            flex: 1;
            font-weight: 600;
            font-size: 15px;
        }

        .folder-count {
            font-size: 13px;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            padding: 20px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-secondary);
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .sort-filter-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 0 20px;
        }
        
        .sort-filter-actions select {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        .theme-toggle {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--accent);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: var(--bg-primary);
        }

        .content-area::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .note-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
            animation: fadeIn 0.4s ease;
            position: relative;
            overflow: hidden;
            
            /* –ù–û–í–û–ï: –î–ª—è –¶–í–ï–¢–û–í–û–ì–û –ö–û–î–ò–†–û–í–ê–ù–ò–Ø */
            border-left: 8px solid var(--border); 
            padding-left: 20px;
        }
        
        /* –ù–û–í–û–ï: –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–æ—Å–∫–∏ —Ü–≤–µ—Ç–∞ –∑–∞–º–µ—Ç–∫–∏ */
        .note-card[data-color] { border-left-color: var(--border); }
        .note-card[data-color="#6366f1"] { border-left-color: #6366f1; }
        .note-card[data-color="#10b981"] { border-left-color: #10b981; }
        .note-card[data-color="#f59e0b"] { border-left-color: #f59e0b; }
        .note-card[data-color="#ef4444"] { border-left-color: #ef4444; }
        .note-card[data-color="#8b5cf6"] { border-left-color: #8b5cf6; }
        .note-card[data-color="#ec4899"] { border-left-color: #ec4899; }
        .note-card[data-color="#06b6d4"] { border-left-color: #06b6d4; }
        .note-card[data-color="#84cc16"] { border-left-color: #84cc16; }

        .note-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px var(--shadow);
            border-color: var(--accent);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .note-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .note-preview {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .note-meta {
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* –ù–û–í–û–ï: –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–≥–æ–≤ */
        .note-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .tag-pill {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .tag-pill:hover {
            background: var(--accent-light);
            color: var(--accent);
        }
        /* –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ò–õ–ï–ô */

        .note-badge {
            background: var(--accent-light);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--accent-light);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--danger);
            border-color: var(--danger);
            transform: scale(1.1) rotate(90deg);
        }

        .modal-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
        
        /* Why Us Section Styles */
        .why-us-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }

        .why-us-card {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
            transition: transform 0.3s;
        }

        .why-us-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .why-us-card h4 {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .why-us-card p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        /* End Why Us Section Styles */


        .editor-toolbar {
            display: flex;
            gap: 12px;
            padding: 18px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            border: 2px solid var(--border);
        }

        .editor-toolbar select,
        .editor-toolbar input[type="number"] {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .editor-toolbar select:focus,
        .editor-toolbar input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .editor-toolbar button {
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .editor-toolbar button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .note-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: 20px;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .note-editor {
            width: 100%;
            min-height: 350px;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.7;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .note-editor:focus,
        .note-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .canvas-container {
            margin: 24px 0;
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px var(--shadow);
        }

        #drawingCanvas {
            display: block;
            width: 100%;
            height: 400px;
            cursor: crosshair;
            background: white;
        }

        .canvas-toolbar {
            padding: 16px;
            background: var(--bg-tertiary);
            display: flex;
            gap: 12px;
            align-items: center;
            border-top: 2px solid var(--border);
        }

        .canvas-toolbar button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .canvas-toolbar input[type="color"] {
            width: 50px;
            height: 40px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }

        .canvas-toolbar input[type="range"] {
            width: 120px;
        }

        .attachments-section {
            margin-top: 28px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .attachment-item {
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
        }

        .attachment-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
            border-color: var(--accent);
        }

        .attachment-icon {
            font-size: 38px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px var(--shadow));
        }

        .attachment-name {
            font-size: 13px;
            word-break: break-all;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.6;
            filter: drop-shadow(0 4px 8px var(--shadow));
        }

        .empty-text {
            font-size: 20px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input[type="file"] {
            display: none;
        }

        .color-picker-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .color-option:hover {
            transform: scale(1.15);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 4px var(--accent-light);
            transform: scale(1.15);
        }

        .stat-item {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 600;
        }

        .bookmark-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            filter: grayscale(1);
        }

        .bookmark-btn.bookmarked {
            filter: grayscale(0);
            transform: scale(1.2);
        }

        .save-indicator {
            padding: 12px 20px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .clipboard-section {
            margin-top: 28px;
            padding: 20px;
            background: var(--accent-light);
            border-radius: 12px;
            border: 2px solid var(--accent);
        }

        .clipboard-preview {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body data-theme="light">
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title">CloudNotes v1</div>
                <div class="app-author">by Niko</div>
                <button class="why-us-btn" onclick="openWhyUsModal()">Why Us?</button>
            </div>
            
            <div class="toolbar">
                <button class="btn" onclick="createFolder()">+ Folder</button>
                <button class="btn btn-icon" onclick="openNewNote()">üìù</button>
                <button class="btn btn-icon btn-warning" onclick="selectFolder('trash')">üóëÔ∏è</button> 
            </div>

            <div class="folders-container" id="foldersContainer">
                </div>
        </div>

        <div class="main-content">
            <div class="topbar">
                <div class="search-bar">
                    <input type="text" placeholder="Search notes..." id="searchInput" oninput="searchNotes()">
                    <span class="search-icon">üîç</span>
                </div>
                <div class="sort-filter-actions">
                    <select id="sortCriteria" onchange="loadNotes(data.currentFolder)">
                        <option value="updatedAt_desc">Latest Edited</option>
                        <option value="createdAt_desc">Newest First</option>
                        <option value="title_asc">Title (A-Z)</option>
                        <option value="color_group">Color Group</option>
                    </select>
                    <button class="btn btn-icon" onclick="alert('Advanced Filter coming soon!')">üîé</button>
                </div>
                <div class="topbar-actions">
                    <div class="stat-item">
                        <span class="stat-value" id="totalNotes">0</span>
                        <div class="stat-label">Total Notes</div>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
                </div>
            </div>

            <div class="content-area" id="contentArea">
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-text">Select a folder or create a new note</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">New Note</div>
                <button class="close-btn" onclick="closeNoteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="noteTitle" placeholder="‚ú® Note title...">
                
                <h3 class="section-title" style="margin-top: 0;">üé® Note Color</h3>
                <div class="color-picker-container" id="noteColorPicker">
                    <div class="color-option selected" style="background: transparent; border: 2px solid var(--border);" data-color="" onclick="selectNoteColor(this)"></div>
                    <div class="color-option" style="background: #6366f1;" data-color="#6366f1" onclick="selectNoteColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectNoteColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectNoteColor(this)"></div>
                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectNoteColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectNoteColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectNoteColor(this)"></div>
                    <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4" onclick="selectNoteColor(this)"></div>
                    <div class="color-option" style="background: #84cc16;" data-color="#84cc16" onclick="selectNoteColor(this)"></div>
                </div>
                <div class="tags-section" style="margin-top: 20px;">
                    <h3 class="section-title"># Tags (e.g., —Å—Ä–æ—á–Ω–æ, —Ä–∞–±–æ—Ç–∞, –∏–¥–µ—è)</h3>
                    <input type="text" class="note-input" id="noteTagsInput" placeholder="Enter tags separated by comma...">
                    <div class="note-tags" id="currentNoteTags"></div>
                </div>
                <div class="editor-toolbar">
                    <select id="fontFamily" onchange="updateEditorStyle()">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Comic Sans MS">Comic Sans MS</option>
                        <option value="Brush Script MT">Brush Script</option>
                        <option value="Trebuchet MS">Trebuchet</option>
                    </select>
                    
                    <input type="number" id="fontSize" value="16" min="10" max="48" onchange="updateEditorStyle()" placeholder="Size">
                    
                    <button onclick="toggleDrawing()">üé® Draw</button>
                    <button onclick="document.getElementById('imageUpload').click()">üñºÔ∏è Image</button>
                    <button onclick="document.getElementById('fileUpload').click()">üìé File</button>
                    <button onclick="pasteFromClipboard()" class="btn-warning">üìã Paste Clipboard</button>
                    <button onclick="toggleBookmark()" id="bookmarkBtn">‚≠ê Bookmark</button>
                    <button onclick="moveToTrash(data.currentNote)" class="btn" style="background: var(--danger);">üóëÔ∏è Delete</button>
                    <button onclick="saveNote()" class="btn btn-success">üíæ Save Note</button>
                </div>

                <textarea class="note-editor" id="noteContent" placeholder="‚úçÔ∏è Start writing your amazing ideas..."></textarea>

                <div class="canvas-container" id="canvasContainer" style="display: none;">
                    <canvas id="drawingCanvas"></canvas>
                    <div class="canvas-toolbar">
                        <button onclick="clearCanvas()" style="background: var(--danger); color: white;">üóëÔ∏è Clear</button>
                        <button onclick="saveDrawing()" class="btn-success" style="background: var(--success); color: white;">üíæ Save Drawing</button>
                        <input type="color" id="drawColor" value="#6366f1">
                        <label style="color: var(--text-secondary); font-size: 13px; font-weight: 600;">Brush Size:</label>
                        <input type="range" id="drawSize" min="1" max="30" value="3">
                        <span id="drawingStatus"></span>
                    </div>
                </div>

                <div class="clipboard-section" id="clipboardSection" style="display: none;">
                    <h3 class="section-title">üìã Clipboard Content</h3>
                    <div class="clipboard-preview" id="clipboardPreview"></div>
                    <button class="btn" style="margin-top: 12px;" onclick="insertClipboard()">‚ú® Insert into Note</button>
                </div>

                <div class="attachments-section">
                    <h3 class="section-title">üìé Attachments</h3>
                    <div class="attachments-grid" id="attachmentsGrid"></div>
                </div>

                <input type="file" id="imageUpload" accept="image/*" onchange="addImage()" multiple>
                <input type="file" id="fileUpload" onchange="addFile()" multiple>
            </div>
        </div>
    </div>

    <div class="modal" id="folderModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">‚ú® New Folder</div>
                <button class="close-btn" onclick="closeFolderModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="folderName" placeholder="üìÅ Folder name...">
                
                <h3 class="section-title">üé® Choose Icon Color</h3>
                <div class="color-picker-container">
                    <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #84cc16;" data-color="#84cc16" onclick="selectColor(this)"></div>
                </div>

                <button class="btn" style="margin-top: 28px; width: 100%;" onclick="saveFolderModal()">‚ú® Create Folder</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="whyUsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">üåü Why Choose CloudNotes v1?</div>
                <button class="close-btn" onclick="closeWhyUsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <h2 style="font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 20px; color: var(--accent);">Your Data. Your Control. Always.</h2>
                <p style="font-size: 16px; text-align: center; color: var(--text-secondary);">We built CloudNotes v1 on a simple principle: <strong>ultimate privacy and simplicity<strong>.</p>
                <div class="why-us-section">
                    
                    <div class="why-us-card">
                        <h4>üîí Absolute Privacy</h4>
                        <p>We <strong>don't track, collect, or sell any of your data<strong>. Everything you write or draw stays <strong>private<strong> on your device's local storage. This is a local-first application.                                                                                                     Big companies (Giants) <strong>sell storage and integration. (your data too!).<strong> <strong>We (CloudeNotes) sell privacy, simplity, and vibe. <strong> Our prices are avalaible for <strong>Everyone<strong> </p>
                    </div>

                    <div class="why-us-card">
                        <h4>üö´ Zero Accounts</h4>
                        <p>No need for email, usernames, or passwords. <strong>No sign-ups<strong>, no log-ins, and no cloud storage required. Just open the app and start noting.</p>
                    </div>

                    <div class="why-us-card">
                        <h4>‚ö°Ô∏è Fast & Reliable</h4>
                        <p>Since your notes are stored <strong>locally<strong> on your browser, loading is instantaneous. You're never dependent on a network connection or server status.</p>
                    </div>

                    <div class="why-us-card">
                        <h4>üìù Feature-Rich Editor</h4>
                        <p>Our editor includes <strong>rich text options<strong>, a full <strong>drawing canvas<strong>, and the ability to add <strong>attachments<strong>, all while keeping your data private and local.</p>
                    </div>

                </div>
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="font-size: 14px; color: var(--text-primary); font-weight: 600;">CloudNotes v1: Simple, powerful, and truly private note-taking.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Data structure
        let data = {
            folders: [
                { id: 1, name: 'Work', color: '#6366f1', notes: [] },
                { id: 2, name: 'Home', color: '#10b981', notes: [] },
                { id: 3, name: 'Fun Projects :)', color: '#f59e0b', notes: [] }
            ],
            // –ù–û–í–´–ô –ú–ê–°–°–ò–í –î–õ–Ø –ö–û–†–ó–ò–ù–´: —Ö—Ä–∞–Ω–∏—Ç –æ–±—ä–µ–∫—Ç—ã { note, deletedDate, originalFolderId }
            trash: [], 
            currentFolder: null,
            currentNote: null,
            nextFolderId: 4,
            nextNoteId: 1,
            // –ù–ê–°–¢–†–û–ô–ö–ò –°–û–†–¢–ò–†–û–í–ö–ò/–§–ò–õ–¨–¢–†–ê–¶–ò–ò
            sortCriteria: 'updatedAt_desc',
            filterCriteria: 'all' 
        };

        let canvas, ctx, isDrawing = false;
        let selectedColor = '#6366f1'; // For folders
        let currentNoteColor = '';    // For notes
        let drawingData = null;
        let currentBookmark = false;
        let clipboardContent = '';

        // Initialize
        function init() {
            loadData();
            cleanupTrash(); // NEW: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–º–µ—Ç–æ–∫ –≤ –∫–æ—Ä–∑–∏–Ω–µ
            renderFolders();
            // Set initial sort criteria (UI)
            document.getElementById('sortCriteria').value = data.sortCriteria;
            
            // Wait for DOM to load before setting up canvas
            document.addEventListener('DOMContentLoaded', () => {
                setupCanvas();
            });
            setupCanvas();
            updateTotalNotes();
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            document.getElementById('themeToggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            saveData();
        }
        
        // NEW FUNCTIONS: Why Us Modal
        function openWhyUsModal() {
            document.getElementById('whyUsModal').classList.add('active');
        }

        function closeWhyUsModal() {
            document.getElementById('whyUsModal').classList.remove('active');
        }
        // END NEW FUNCTIONS

        // Update total notes count
        function updateTotalNotes() {
            let total = 0;
            data.folders.forEach(folder => {
                total += folder.notes.length;
            });
            document.getElementById('totalNotes').textContent = total;
        }

        // Clipboard functions
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    clipboardContent = text;
                    document.getElementById('clipboardSection').style.display = 'block';
                    document.getElementById('clipboardPreview').textContent = text.substring(0, 200) + (text.length > 200 ? '...' : '');
                } else {
                    alert('Clipboard is empty!');
                }
            } catch (err) {
                alert('Could not access clipboard. Please make sure you granted permission.');
            }
        }

        function insertClipboard() {
            const editor = document.getElementById('noteContent');
            // Use innerHTML for rich text editor
            editor.innerHTML += (editor.innerHTML ? '<br><br>' : '') + clipboardContent;
            document.getElementById('clipboardSection').style.display = 'none';
        }

        // Local Storage
        function saveData() {
            localStorage.setItem('cloudNotesData', JSON.stringify({
                folders: data.folders,
                trash: data.trash, // NEW: Save trash
                currentFolder: data.currentFolder,
                nextFolderId: data.nextFolderId,
                nextNoteId: data.nextNoteId,
                theme: document.body.getAttribute('data-theme'),
                sortCriteria: document.getElementById('sortCriteria').value // NEW: Save sort criteria
            }));
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem('cloudNotesData');
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    data.folders = parsed.folders || data.folders;
                    data.currentFolder = parsed.currentFolder;
                    data.nextFolderId = parsed.nextFolderId;
                    data.nextNoteId = parsed.nextNoteId;
                    
                    // NEW: Load new properties, use defaults if not found (for backward compatibility)
                    data.trash = parsed.trash || [];
                    data.sortCriteria = parsed.sortCriteria || 'updatedAt_desc';
                    data.filterCriteria = parsed.filterCriteria || 'all';

                    if (parsed.theme) {
                        document.body.setAttribute('data-theme', parsed.theme);
                        document.getElementById('themeToggle').textContent = 
                            parsed.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                    }
                    
                    console.log('‚úÖ Data loaded from storage!');
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }
        
        // FOLDERS
        function renderFolders() {
            const container = document.getElementById('foldersContainer');
            container.innerHTML = '';
            
            data.folders.forEach(folder => {
                const item = document.createElement('div');
                item.className = 'folder-item';
                if (data.currentFolder === folder.id) item.classList.add('active');
                item.innerHTML = `
                    <div class="folder-icon" style="background: ${folder.color};">üìÅ</div>
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-count">${folder.notes.length}</div>
                `;
                item.onclick = () => selectFolder(folder.id);
                container.appendChild(item);
            });
        }

        function selectFolder(id) {
            data.currentFolder = id;
            data.currentNote = null;
            renderFolders();
            // NEW: Handle trash view
            if (id === 'trash') {
                loadTrash();
            } else {
                loadNotes(id);
            }
            saveData();
        }

        function createFolder() {
            document.getElementById('folderName').value = '';
            // Reset color selection
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            const defaultColor = document.querySelector('.color-picker-container div');
            if (defaultColor) {
                defaultColor.classList.add('selected');
                selectedColor = defaultColor.getAttribute('data-color');
            }
            
            document.getElementById('folderModal').classList.add('active');
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.remove('active');
        }

        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            selectedColor = element.getAttribute('data-color');
        }

        function saveFolderModal() {
            const name = document.getElementById('folderName').value.trim();
            if (!name) {
                alert('Folder name cannot be empty!');
                return;
            }

            const newFolder = {
                id: data.nextFolderId++,
                name: name,
                color: selectedColor,
                notes: []
            };

            data.folders.push(newFolder);
            closeFolderModal();
            renderFolders();
            saveData();
        }
        
        // NOTES
        
        /**
         * Renders the HTML for tags (used on note card)
         */
        function renderTagsDisplayHTML(tags) {
            return (tags || []).map(tag => `<span class="tag-pill">#${tag}</span>`).join('');
        }
        
        /**
         * Displays the tags in the note editor modal (dynamically)
         */
        function renderTagsDisplay(tags) {
            const tagContainer = document.getElementById('currentNoteTags');
            tagContainer.innerHTML = '';
            tags.forEach(tag => {
                const pill = document.createElement('span');
                pill.className = 'tag-pill';
                pill.textContent = `#${tag.trim()}`;
                pill.onclick = (e) => {
                    e.stopPropagation();
                    // Implement filtering logic here later
                    alert(`Filtering by tag: #${tag.trim()}`);
                };
                tagContainer.appendChild(pill);
            });
        }
        
        /**
         * Sets the color for the note in the modal.
         */
        function selectNoteColor(element) {
            document.querySelectorAll('#noteColorPicker .color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            currentNoteColor = element.getAttribute('data-color');
        }

        /**
         * Helper to get attachments from the editor modal
         */
        function getNoteAttachments() {
            const attachments = [];
            const attachmentElements = document.getElementById('attachmentsGrid').children;
            for (let el of attachmentElements) {
                attachments.push({
                    name: el.dataset.name,
                    type: el.dataset.type,
                    dataUrl: el.dataset.data
                });
            }
            return attachments;
        }

        /**
         * Loads and displays notes for the specified folderId.
         * Includes sorting logic.
         * @param {number|string} folderId - The ID of the folder.
         */
        function loadNotes(folderId) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '';
            
            if (folderId === 'trash') {
                loadTrash();
                return;
            }
            
            const folder = data.folders.find(f => f.id === folderId);

            if (!folder) {
                contentArea.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">Folder not found.</div></div>`;
                return;
            }

            let notes = folder.notes;

            if (notes.length === 0) {
                contentArea.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ú®</div><div class="empty-text">No notes yet. Create your first note!</div></div>`;
                return;
            }

            // NEW: –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –°–û–†–¢–ò–†–û–í–ö–ò (The Super-Sort)
            const criteria = document.getElementById('sortCriteria').value;
            notes.sort((a, b) => {
                const aDate = new Date(a.updatedAt || a.createdAt).getTime();
                const bDate = new Date(b.updatedAt || b.createdAt).getTime();
                
                switch (criteria) {
                    case 'updatedAt_desc':
                        return bDate - aDate;
                    case 'createdAt_desc':
                        return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
                    case 'title_asc':
                        return a.title.localeCompare(b.title);
                    case 'color_group':
                        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–≤–µ—Ç—É (None –≤ –Ω–∞—á–∞–ª–æ)
                        const colorA = a.color || '';
                        const colorB = b.color || '';
                        return colorA.localeCompare(colorB);
                    default:
                        return 0;
                }
            });


            const grid = document.createElement('div');
            grid.className = 'notes-grid';

            notes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.setAttribute('data-color', note.color || ''); // NEW: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
                card.onclick = () => editNote(note.id);
                
                // Safely extract text content from rich HTML for preview
                const parser = new DOMParser();
                const doc = parser.parseFromString(note.content, 'text/html');
                const textPreview = doc.body.textContent.substring(0, 100) + (doc.body.textContent.length > 100 ? '...' : '');

                card.innerHTML = `
                    ${note.isBookmarked ? '<button class="bookmark-btn bookmarked" onclick="event.stopPropagation();">üåü</button>' : ''}
                    <div class="note-title">${note.title || 'Untitled'}</div>
                    <div class="note-preview">${textPreview || 'No content...'}</div>
                    <div class="note-tags">${renderTagsDisplayHTML(note.tags || [])}</div> 
                    <div class="note-meta">
                        <span>üìÖ ${new Date(note.updatedAt || note.createdAt).toLocaleDateString()}</span>
                        <span class="note-badge">üìé ${(note.attachments || []).length} files</span>
                    </div>
                `;
                grid.appendChild(card);
            });
            contentArea.appendChild(grid);
        }

        function openNewNote() {
            if (!data.currentFolder || data.currentFolder === 'trash') {
                return alert('Please select a folder first or restore notes from Trash.');
            }
            data.currentNote = null;
            currentBookmark = false;
            drawingData = null;
            clipboardContent = '';
            currentNoteColor = ''; // NEW: Reset color
            
            document.getElementById('modalTitle').textContent = '‚ú® New Note';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').innerHTML = ''; // Use innerHTML for rich text
            document.getElementById('attachmentsGrid').innerHTML = '';
            document.getElementById('canvasContainer').style.display = 'none';
            document.getElementById('clipboardSection').style.display = 'none';
            document.getElementById('bookmarkBtn').innerHTML = '‚≠ê Bookmark';
            
            // NEW: Reset color and tags
            document.querySelectorAll('#noteColorPicker .color-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.getAttribute('data-color') === '') opt.classList.add('selected');
            });
            document.getElementById('noteTagsInput').value = '';
            document.getElementById('currentNoteTags').innerHTML = '';
            
            document.getElementById('noteModal').classList.add('active');
            updateEditorStyle();
        }

        function editNote(noteId) {
            const folder = data.folders.find(f => f.id === data.currentFolder);
            const note = folder.notes.find(n => n.id === noteId);
            
            if (!note) return;
            
            data.currentNote = noteId;
            
            document.getElementById('modalTitle').textContent = note.title;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').innerHTML = note.content;
            
            // NEW: Load color
            currentNoteColor = note.color || '';
            document.querySelectorAll('#noteColorPicker .color-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.getAttribute('data-color') === currentNoteColor) {
                    opt.classList.add('selected');
                }
            });

            // NEW: Load tags
            document.getElementById('noteTagsInput').value = (note.tags || []).join(', ');
            renderTagsDisplay(note.tags || []);
            
            // ... (existing code for font, drawing, etc.)
            document.getElementById('fontFamily').value = note.fontFamily;
            document.getElementById('fontSize').value = note.fontSize; 
            updateEditorStyle();

            drawingData = note.drawing || null;
            currentBookmark = note.isBookmarked || false;
            updateBookmarkButton();
            renderAttachments(note.attachments);
            
            document.getElementById('canvasContainer').style.display = drawingData ? 'block' : 'none';
            if (drawingData) { 
                setTimeout(() => loadDrawing(drawingData), 50); 
            }
            document.getElementById('clipboardSection').style.display = 'none';
            document.getElementById('noteModal').classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            if (data.currentFolder) {
                loadNotes(data.currentFolder);
            }
            data.currentNote = null;
        }

        /**
         * Saves the current note (create or update).
         */
        function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').innerHTML;
            
            const folder = data.folders.find(f => f.id === data.currentFolder);
            
            if (!folder) {
                alert('No folder selected!');
                return;
            }
            if (!title) {
                alert('Title cannot be empty!');
                return;
            }

            // –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–æ–≤
            const tagsInput = document.getElementById('noteTagsInput').value.trim();
            const tagsArray = tagsInput ? tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag) : [];

            // Data object for update/creation
            const now = new Date().toISOString();
            const newNoteData = {
                title,
                content,
                // –ù–û–í–´–ï –ü–û–õ–Ø
                color: currentNoteColor, // Note card color
                tags: tagsArray,         // Array of tags
                
                // –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ü–û–õ–Ø –î–ê–¢–´
                updatedAt: now,
                
                // ... existing properties
                fontFamily: document.getElementById('fontFamily').value,
                fontSize: parseInt(document.getElementById('fontSize').value),
                drawing: drawingData,
                isBookmarked: currentBookmark,
                attachments: getNoteAttachments(),
            };

            if (data.currentNote === null) {
                // New note
                newNoteData.id = data.nextNoteId++;
                newNoteData.createdAt = now; // –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
                newNoteData.history = []; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
                folder.notes.push(newNoteData);
            } else {
                // Edit existing note
                const noteIndex = folder.notes.findIndex(n => n.id === data.currentNote);
                if (noteIndex !== -1) {
                    const existingNote = folder.notes[noteIndex];
                    
                    // –ù–û–í–û–ï: Version History: Save a copy of the old note before update
                    if (!existingNote.history) existingNote.history = [];
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                    existingNote.history.unshift({ 
                        title: existingNote.title, 
                        content: existingNote.content, 
                        updatedAt: existingNote.updatedAt || existingNote.createdAt 
                    });
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ 5 –≤–µ—Ä—Å–∏–π
                    if (existingNote.history.length > 5) {
                        existingNote.history.pop();
                    }

                    // Update with new data, keeping original createdAt
                    folder.notes[noteIndex] = { 
                        ...existingNote, 
                        ...newNoteData,
                        createdAt: existingNote.createdAt // Preserve original creation date
                    };
                }
            }

            saveData();
            updateTotalNotes();
            // Show save indicator
            const saveIndicator = document.createElement('div');
            saveIndicator.className = 'save-indicator';
            saveIndicator.innerHTML = '‚úÖ Saved!';
            saveIndicator.style.position = 'fixed';
            saveIndicator.style.top = '20px';
            saveIndicator.style.right = '20px';
            saveIndicator.style.zIndex = '10000';
            document.body.appendChild(saveIndicator);
            setTimeout(() => saveIndicator.remove(), 1500);

            closeNoteModal();
            loadNotes(data.currentFolder); 
        }

        // ATTACHMENTS (existing functions)

        function renderAttachments(attachments) {
            const grid = document.getElementById('attachmentsGrid');
            grid.innerHTML = (attachments || []).map((att, index) => {
                const icon = getAttachmentIcon(att.type);
                return `
                    <div class="attachment-item" data-type="${att.type}" data-name="${att.name}" data-data="${att.dataUrl}">
                        <div class="attachment-icon">${icon}</div>
                        <div class="attachment-name">${att.name}</div>
                        <button style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; margin-top: 8px; cursor: pointer;" onclick="deleteAttachment(${index})">Delete</button>
                    </div>
                `;
            }).join('');
        }

        function getAttachmentIcon(type) {
            if (type.startsWith('image')) return 'üñºÔ∏è';
            if (type.startsWith('audio')) return 'üéµ';
            if (type.startsWith('video')) return 'üé¨';
            if (type.includes('pdf') || type.includes('doc')) return 'üìÑ';
            return 'üìé';
        }

        function addImage() {
            const files = document.getElementById('imageUpload').files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addAttachmentItem(file.name, file.type, e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function addFile() {
            const files = document.getElementById('fileUpload').files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addAttachmentItem(file.name, file.type, e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function addAttachmentItem(name, type, dataUrl) {
            const grid = document.getElementById('attachmentsGrid');
            const icon = getAttachmentIcon(type);
            const item = document.createElement('div');
            item.className = 'attachment-item';
            item.dataset.type = type;
            item.dataset.name = name;
            item.dataset.data = dataUrl;
            
            const index = grid.children.length; // Calculate the new index for the delete button
            
            item.innerHTML = `
                <div class="attachment-icon">${icon}</div>
                <div class="attachment-name">${name}</div>
                <button style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; margin-top: 8px; cursor: pointer;" onclick="deleteAttachment(${index})">Delete</button>
            `;
            // Re-render is safer for dynamic attachment lists
            if (data.currentNote) {
                const folder = data.folders.find(f => f.id === data.currentFolder);
                const note = folder.notes.find(n => n.id === data.currentNote);
                if (note) {
                    note.attachments.push({ name, type, dataUrl });
                    renderAttachments(note.attachments);
                }
            } else {
                grid.appendChild(item);
                // For new notes, attachments are gathered in saveNote()
            }
            
            saveData();
        }

        function deleteAttachment(index) {
            if (!confirm('Are you sure you want to delete this attachment?')) return;
            
            // For existing note
            if (data.currentNote) {
                const folder = data.folders.find(f => f.id === data.currentFolder);
                const note = folder.notes.find(n => n.id === data.currentNote);
                if (note && note.attachments) {
                    note.attachments.splice(index, 1);
                    renderAttachments(note.attachments);
                    saveData();
                }
            } else {
                // For new note, just remove from the DOM and rely on saveNote to capture the rest
                const grid = document.getElementById('attachmentsGrid');
                if (grid.children[index]) {
                    grid.children[index].remove();
                }
            }
        }

        // DRAWING (existing functions)

        function setupCanvas() {
            canvas = document.getElementById('drawingCanvas');
            if (!canvas) return; // Prevent error if canvas isn't visible yet
            ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = 400;

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseout', stopDrawing); // Stop drawing when mouse leaves

            // Touch events
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
        }
        
        function toggleDrawing() {
            const container = document.getElementById('canvasContainer');
            if (container.style.display === 'block') {
                container.style.display = 'none';
                saveDrawing(); // Save before hiding
            } else {
                container.style.display = 'block';
                // Reset size/color on open
                document.getElementById('drawColor').value = '#6366f1';
                document.getElementById('drawSize').value = 3;
                
                // Set canvas size correctly on display
                canvas.width = canvas.offsetWidth;
                canvas.height = 400; 

                loadDrawing(drawingData);
            }
        }
        
        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(
                e.offsetX || (e.clientX - canvas.getBoundingClientRect().left),
                e.offsetY || (e.clientY - canvas.getBoundingClientRect().top)
            );
            document.getElementById('drawingStatus').textContent = 'Drawing...';
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
            document.getElementById('drawingStatus').textContent = 'Ready';
        }

        function draw(e) {
            if (!isDrawing) return;
            
            ctx.lineWidth = document.getElementById('drawSize').value;
            ctx.lineCap = 'round';
            ctx.strokeStyle = document.getElementById('drawColor').value;

            ctx.lineTo(
                e.offsetX || (e.clientX - canvas.getBoundingClientRect().left),
                e.offsetY || (e.clientY - canvas.getBoundingClientRect().top)
            );
            ctx.stroke();
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingData = null;
        }

        function saveDrawing() {
            drawingData = canvas.toDataURL();
            document.getElementById('drawingStatus').textContent = 'Drawing Saved!';
        }
        
        function loadDrawing(dataUrl) {
            if (!dataUrl) {
                clearCanvas();
                return;
            }
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                document.getElementById('drawingStatus').textContent = 'Drawing Loaded';
            };
            img.src = dataUrl;
        }

        // BOOKMARK
        function toggleBookmark() {
            currentBookmark = !currentBookmark;
            updateBookmarkButton();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            if (currentBookmark) {
                btn.classList.add('bookmarked');
                btn.innerHTML = 'üåü Bookmarked';
                btn.style.background = 'var(--warning)';
                btn.style.color = 'white';
            } else {
                btn.classList.remove('bookmarked');
                btn.innerHTML = '‚≠ê Bookmark';
                btn.style.background = 'var(--bg-secondary)';
                btn.style.color = 'var(--text-primary)';
            }
        }
        
        // UTILS
        function updateEditorStyle() {
            const editor = document.getElementById('noteContent');
            editor.style.fontFamily = document.getElementById('fontFamily').value;
            editor.style.fontSize = document.getElementById('fontSize').value + 'px';
        }
        
        
        // NEW: TRASH & CLEANUP FUNCTIONS
        
        /**
         * Permanently removes notes from trash that are older than 30 days.
         */
        function cleanupTrash() {
            const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
            const now = Date.now();
            
            const initialTrashCount = data.trash.length;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ —É–¥–∞–ª–µ–Ω—ã –º–µ–Ω–µ–µ 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
            data.trash = data.trash.filter(item => {
                const deletedTime = new Date(item.deletedDate).getTime();
                return (now - deletedTime) < thirtyDaysInMs;
            });
            
            if (initialTrashCount > data.trash.length) {
                console.log(`üóëÔ∏è Cleared ${initialTrashCount - data.trash.length} old notes from trash.`);
                saveData();
                updateTotalNotes();
            }
        }
        
        /**
         * Moves a note from a folder to the trash array.
         * @param {number} noteId - ID of the note to delete.
         */
        function moveToTrash(noteId) {
            if (!noteId) {
                return alert('Please save the note before deleting.');
            }
            if (!confirm('Are you sure you want to delete this note? It will be moved to the Trash for 30 days.')) return;
            
            let noteToMove = null;
            let folderId = null;
            
            // Find the note and its folder
            for (let folder of data.folders) {
                const noteIndex = folder.notes.findIndex(n => n.id === noteId);
                if (noteIndex !== -1) {
                    noteToMove = folder.notes.splice(noteIndex, 1)[0]; // Remove and get the note
                    folderId = folder.id;
                    break;
                }
            }

            if (noteToMove && folderId !== null) {
                // Store the note in trash with deletion date and original folder ID
                data.trash.unshift({
                    note: noteToMove,
                    deletedDate: new Date().toISOString(),
                    originalFolderId: folderId
                });
                
                saveData();
                closeNoteModal(); // Close modal after deletion
                updateTotalNotes();
                loadNotes(data.currentFolder); // Re-render current folder
            } else {
                alert('Note not found or already deleted!');
            }
        }

        /**
         * Loads and displays notes currently in the trash.
         */
        function loadTrash() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '';
            
            if (data.trash.length === 0) {
                contentArea.innerHTML = `<div class="empty-state"><div class="empty-icon">üóëÔ∏è</div><div class="empty-text">Trash is empty.</div></div>`;
                return;
            }
            
            const grid = document.createElement('div');
            grid.className = 'notes-grid';
            
            data.trash.forEach(item => {
                const note = item.note;
                const deletedDate = new Date(item.deletedDate);
                const daysLeft = Math.ceil((deletedDate.getTime() + (30 * 24 * 60 * 60 * 1000) - Date.now()) / (24 * 60 * 60 * 1000));
                
                // Safely extract text content from rich HTML for preview
                const parser = new DOMParser();
                const doc = parser.parseFromString(note.content, 'text/html');
                const textPreview = doc.body.textContent.substring(0, 100) + (doc.body.textContent.length > 100 ? '...' : '');

                const card = document.createElement('div');
                card.className = 'note-card';
                card.setAttribute('data-color', note.color || '');
                // Trash cards are NOT clickable to open the editor
                
                card.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-preview">${textPreview || 'No content...'}</div>
                    <div class="note-tags">${renderTagsDisplayHTML(note.tags || [])}</div>
                    <div class="note-meta" style="flex-direction: column; align-items: flex-start;">
                        <span style="font-weight: 600; color: var(--danger);">üõë Deletion in ${daysLeft} days</span>
                        <span>üóëÔ∏è Deleted: ${deletedDate.toLocaleDateString()}</span>
                        <button class="btn btn-success" style="margin-top: 10px; padding: 6px 12px;" onclick="restoreFromTrash(${note.id}, ${item.originalFolderId})">‚Ü©Ô∏è Restore</button>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            contentArea.appendChild(grid);
            // Add button to empty trash
            const emptyBtn = document.createElement('button');
            emptyBtn.className = 'btn btn-danger';
            emptyBtn.textContent = 'Permanently Empty Trash';
            emptyBtn.onclick = emptyTrash;
            emptyBtn.style.marginTop = '20px';
            contentArea.appendChild(emptyBtn);
        }

        /**
         * Restores a note from trash back to its original folder.
         * @param {number} noteId - ID of the note to restore.
         * @param {number} originalFolderId - ID of the folder to restore to.
         */
        function restoreFromTrash(noteId, originalFolderId) {
            // Find the trash item
            const trashIndex = data.trash.findIndex(item => item.note.id === noteId);
            if (trashIndex === -1) return alert('Note not found in trash!');
            
            const trashItem = data.trash.splice(trashIndex, 1)[0];
            const noteToRestore = trashItem.note;
            
            // Find the original folder
            const targetFolder = data.folders.find(f => f.id === originalFolderId);
            
            if (targetFolder) {
                targetFolder.notes.push(noteToRestore);
                alert(`Note "${noteToRestore.title}" restored to folder "${targetFolder.name}".`);
            } else {
                // If original folder not found, restore to the first available folder
                const activeFolder = data.folders[0];
                if (activeFolder) {
                    activeFolder.notes.push(noteToRestore);
                    alert(`Note restored to first folder "${activeFolder.name}" (Original folder not found).`);
                } else {
                    data.trash.push(trashItem); 
                    return alert('Could not find any folder to restore to!');
                }
            }
            
            saveData();
            updateTotalNotes();
            loadTrash(); // Re-render trash view
            renderFolders(); // Update folder counts
        }

        /**
         * Permanently removes all notes from the trash array.
         */
        function emptyTrash() {
            if (!confirm('WARNING: Are you sure you want to permanently delete ALL notes in the trash? This action cannot be undone.')) return;
            
            data.trash = [];
            saveData();
            loadTrash();
            alert('Trash has been permanently emptied.');
        }

        // Initialize app
        init();
    </script>
</body>
</html>

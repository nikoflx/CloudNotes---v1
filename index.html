<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes v1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f0f5;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-hover: rgba(99, 102, 241, 0.2);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #262626;
            --text-primary: #f5f5f5;
            --text-secondary: #9ca3af;
            --accent: #818cf8;
            --accent-hover: #6366f1;
            --accent-light: rgba(129, 140, 248, 0.15);
            --border: #2d2d2d;
            --shadow: rgba(0, 0, 0, 0.4);
            --shadow-hover: rgba(129, 140, 248, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 10px var(--shadow);
        }

        .sidebar-header {
            padding: 30px 24px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent-light), transparent);
        }

        .app-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .app-author {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 15px; /* Added margin for new button */
        }
        
        /* New 'Why Us?' Button Style */
        .why-us-btn {
            display: block;
            width: 100%;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--accent);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--accent);
            box-shadow: 0 2px 8px var(--shadow-hover);
            text-align: center;
        }

        .why-us-btn:hover {
            background: var(--accent);
            color: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .why-us-btn:active {
            transform: translateY(0);
        }
        /* End New 'Why Us?' Button Style */

        .toolbar {
            padding: 20px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            padding: 10px 14px;
            font-size: 18px;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .folders-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .folders-container::-webkit-scrollbar {
            width: 6px;
        }

        .folders-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .folder-item {
            padding: 14px 18px;
            margin: 6px 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 2px solid transparent;
        }

        .folder-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(6px);
            border-color: var(--accent-light);
        }

        .folder-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateX(6px);
        }

        .folder-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .folder-item:hover .folder-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .folder-name {
            flex: 1;
            font-weight: 600;
            font-size: 15px;
        }

        .folder-count {
            font-size: 13px;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            padding: 20px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-secondary);
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        /* START New Language Switcher Style */
        .language-switcher {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px; 
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .language-switcher:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }
        /* END New Language Switcher Style */

        .theme-toggle {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--accent);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: var(--bg-primary);
        }

        .content-area::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .note-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
            animation: fadeIn 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .note-card:hover::before {
            transform: scaleX(1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .note-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px var(--shadow);
            border-color: var(--accent);
        }

        .note-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .note-preview {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .note-meta {
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-badge {
            background: var(--accent-light);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--accent-light);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--danger);
            border-color: var(--danger);
            transform: scale(1.1) rotate(90deg);
        }

        .modal-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
        
        /* Why Us Section Styles */
        .why-us-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }

        .why-us-card {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
            transition: transform 0.3s;
        }

        .why-us-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .why-us-card h4 {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .why-us-card p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        /* End Why Us Section Styles */


        .editor-toolbar {
            display: flex;
            gap: 12px;
            padding: 18px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            border: 2px solid var(--border);
        }

        .editor-toolbar select,
        .editor-toolbar input[type="number"] {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .editor-toolbar select:focus,
        .editor-toolbar input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .editor-toolbar button {
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .editor-toolbar button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .editor-toolbar button:active {
             transform: translateY(0);
        }

        .note-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: 20px;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .note-editor {
            width: 100%;
            min-height: 350px;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.7;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .note-editor:focus,
        .note-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .canvas-container {
            margin: 24px 0;
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px var(--shadow);
        }

        #drawingCanvas {
            display: block;
            width: 100%;
            height: 400px;
            cursor: crosshair;
            background: white;
        }

        .canvas-toolbar {
            padding: 16px;
            background: var(--bg-tertiary);
            display: flex;
            gap: 12px;
            align-items: center;
            border-top: 2px solid var(--border);
        }

        .canvas-toolbar button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .canvas-toolbar input[type="color"] {
            width: 50px;
            height: 40px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }

        .canvas-toolbar input[type="range"] {
            width: 120px;
        }

        .attachments-section {
            margin-top: 28px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .attachment-item {
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
        }

        .attachment-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
            border-color: var(--accent);
        }

        .attachment-icon {
            font-size: 38px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px var(--shadow));
        }

        .attachment-name {
            font-size: 13px;
            word-break: break-all;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.6;
            filter: drop-shadow(0 4px 8px var(--shadow));
        }

        .empty-text {
            font-size: 20px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input[type="file"] {
            display: none;
        }

        .color-picker-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .color-option:hover {
            transform: scale(1.15);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 4px var(--accent-light);
            transform: scale(1.15);
        }

        .stat-item {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 600;
        }

        .bookmark-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            filter: grayscale(1);
        }

        .bookmark-btn.bookmarked {
            filter: grayscale(0);
            transform: scale(1.2);
        }

        .save-indicator {
            padding: 12px 20px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: fixed; /* Added to make it visible */
            bottom: 20px; /* Added to make it visible */
            right: 20px; /* Added to make it visible */
            z-index: 1001; /* Added to make it visible */
        }

        .clipboard-section {
            margin-top: 28px;
            padding: 20px;
            background: var(--accent-light);
            border-radius: 12px;
            border: 2px solid var(--accent);
        }

        .clipboard-preview {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body data-theme="light">
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title">CloudNotes v1</div>
                <div class="app-author">by Niko</div>
                <button class="why-us-btn" onclick="openWhyUsModal()" id="whyUsBtn">Why Us?</button>
            </div>
            
            <div class="toolbar">
                <button class="btn" onclick="createFolder()" id="newFolderBtn">+ Folder</button>
                <button class="btn btn-icon" onclick="openNewNote()" id="newNoteIconBtn">üìù</button>
            </div>

            <div class="folders-container" id="foldersContainer">
                </div>
        </div>

        <div class="main-content">
            <div class="topbar">
                <div class="search-bar">
                    <input type="text" placeholder="Search notes..." id="searchInput" oninput="searchNotes()">
                    <span class="search-icon">üîç</span>
                </div>
                <div class="topbar-actions">
                    <select id="language-switcher" class="language-switcher" onchange="setLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    </select>
                    <div class="stat-item">
                        <span class="stat-value" id="totalNotes">0</span>
                        <div class="stat-label" id="totalNotesLabel">Total Notes</div>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
                </div>
            </div>

            <div class="content-area" id="contentArea">
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-text" id="initialEmptyStateText">Select a folder or create a new note</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">New Note</div>
                <button class="close-btn" onclick="closeNoteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="noteTitle" placeholder="‚ú® Note title...">
                
                <div class="editor-toolbar">
                    <select id="fontFamily" onchange="updateEditorStyle()">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Comic Sans MS">Comic Sans MS</option>
                        <option value="Brush Script MT">Brush Script</option>
                        <option value="Trebuchet MS">Trebuchet</option>
                    </select>
                    
                    <input type="number" id="fontSize" value="16" min="10" max="48" onchange="updateEditorStyle()" placeholder="Size">
                    
                    <button onclick="toggleDrawing()" id="drawBtn">üé® Draw</button>
                    <button onclick="document.getElementById('imageUpload').click()" id="imageBtn">üñºÔ∏è Image</button>
                    <button onclick="document.getElementById('fileUpload').click()" id="fileBtn">üìé File</button>
                    <button onclick="pasteFromClipboard()" class="btn-warning" id="pasteBtn">üìã Paste Clipboard</button>
                    <button onclick="toggleBookmark()" id="bookmarkBtn">‚≠ê Bookmark</button>
                    <button onclick="saveNote()" class="btn btn-success" id="saveNoteBtn">üíæ Save Note</button>
                </div>

                <textarea class="note-editor" id="noteContent" placeholder="‚úçÔ∏è Start writing your amazing ideas..."></textarea>

                <div class="canvas-container" id="canvasContainer" style="display: none;">
                    <canvas id="drawingCanvas"></canvas>
                    <div class="canvas-toolbar">
                         <button onclick="clearCanvas()" style="background: var(--danger); color: white;" id="clearCanvasBtn">üóëÔ∏è Clear</button>
                        <button onclick="saveDrawing()" class="btn-success" style="background: var(--success); color: white;" id="saveDrawingBtn">üíæ Save Drawing</button>
                        <input type="color" id="drawColor" value="#6366f1">
                        <label style="color: var(--text-secondary); font-size: 13px; font-weight: 600;" id="brushSizeLabel">Brush Size:</label>
                        <input type="range" id="drawSize" min="1" max="30" value="3">
                        <span id="drawingStatus"></span>
                    </div>
                </div>

                <div class="clipboard-section" id="clipboardSection" style="display: none;">
                    <h3 class="section-title" id="clipboardTitle">üìã Clipboard Content</h3>
                    <div class="clipboard-preview" id="clipboardPreview"></div>
                    <button class="btn" style="margin-top: 12px;" onclick="insertClipboard()" id="insertClipboardBtn">‚ú® Insert into Note</button>
                </div>

                <div class="attachments-section">
                    <h3 class="section-title" id="attachmentsTitle">üìé Attachments</h3>
                    <div class="attachments-grid" id="attachmentsGrid"></div>
                </div>

                <input type="file" id="imageUpload" accept="image/*" onchange="addImage()" multiple>
                <input type="file" id="fileUpload" onchange="addFile()" multiple>
            </div>
        </div>
    </div>

    <div class="modal" id="folderModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title" id="newFolderTitle">‚ú® New Folder</div>
                <button class="close-btn" onclick="closeFolderModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="folderName" placeholder="üìÅ Folder name...">
                
                 <h3 class="section-title" id="chooseColorTitle">üé® Choose Icon Color</h3>
                <div class="color-picker-container">
                    <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #84cc16;" data-color="#84cc16" onclick="selectColor(this)"></div>
                </div>

                <button class="btn" style="margin-top: 28px; width: 100%;" onclick="saveFolderModal()" id="createFolderBtn">‚ú® Create Folder</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="whyUsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title" id="whyUsModalTitle">üåü Why Choose CloudNotes v1?</div>
                <button class="close-btn" onclick="closeWhyUsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <h2 style="font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 20px; color: var(--accent);" id="whyUsSubtitle">Your Data. Your Control. Always.</h2>
                <p style="font-size: 16px; text-align: center; color: var(--text-secondary);" id="whyUsIntro">We built CloudNotes v1 on a simple principle: <strong>ultimate privacy and simplicity<strong>.</p>
                <div class="why-us-section">
                    
                    <div class="why-us-card">
                        <h4 id="privacyTitle">üîí Absolute Privacy</h4>
                        <p id="privacyText">We <strong>don't track, collect, or sell any of your data<strong>. Everything you write or draw stays <strong>private<strong> on your device's local storage. This is a local-first application.                                                                                                     Big companies (Giants) <strong>sell storage and integration. (your data too!).<strong> <strong>We (CloudeNotes) sell privacy, simplity, and vibe. <strong> Our prices are avalaible for <strong>Everyone<strong> </p>
                    </div>

                    <div class="why-us-card">
                        <h4 id="accountsTitle">üö´ Zero Accounts</h4>
                        <p id="accountsText">No need for email, usernames, or passwords. <strong>No sign-ups<strong>, no log-ins, and no cloud storage required. Just open the app and start noting.</p>
                    </div>

                    <div class="why-us-card">
                        <h4 id="fastTitle">‚ö°Ô∏è Fast & Reliable</h4>
                        <p id="fastText">Since your notes are stored <strong>locally<strong> on your browser, loading is instantaneous. You're never dependent on a network connection or server status.</p>
                    </div>

                    <div class="why-us-card">
                        <h4 id="featuresTitle">üìù Feature-Rich Editor</h4>
                        <p id="featuresText">Our editor includes <strong>rich text options<strong>, a full <strong>drawing canvas<strong>, and the ability to add <strong>attachments<strong>, all while keeping your data private and local.</p>
                    </div>

                </div>
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="font-size: 14px; color: var(--text-primary); font-weight: 600;" id="whyUsFooter">CloudNotes v1: Simple, powerful, and truly private note-taking.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Data structure
        let data = {
            folders: [
                { id: 1, name: 'Work', color: '#6366f1', notes: [] },
                { id: 2, name: 'Home', color: '#10b981', notes: [] },
                { id: 3, name: 'Fun Projects :)', color: '#f59e0b', notes: [] }
            ],
            currentFolder: null,
            currentNote: null,
            nextFolderId: 4,
            nextNoteId: 1
        };

        let canvas, ctx, isDrawing = false;
        let selectedColor = '#6366f1';
        let drawingData = null;
        let currentBookmark = false;
        let clipboardContent = '';
        let currentLang = 'en'; // NEW: Default language is English

        // NEW: Translation Data
        const translations = {
            en: {
                // UI Elements
                whyUsBtn: "Why Us?",
                newFolder: "+ Folder",
                newNoteIcon: "üìù",
                searchPlaceholder: "Search notes...",
                totalNotes: "Total Notes",
                brushSize: "Brush Size:",
                saveNote: "üíæ Save Note",
                
                // Note Modal
                newNoteTitle: "New Note",
                noteTitlePlaceholder: "‚ú® Note title...",
                editorPlaceholder: "‚úçÔ∏è Start writing your amazing ideas...",
                drawBtn: "üé® Draw",
                imageBtn: "üñºÔ∏è Image",
                fileBtn: "üìé File",
                pasteBtn: "üìã Paste Clipboard",
                bookmarkBtn: "‚≠ê Bookmark",
                bookmarkedBtn: "üåü Bookmarked",
                canvasClear: "üóëÔ∏è Clear",
                canvasSave: "üíæ Save Drawing",
                clipboardTitle: "üìã Clipboard Content",
                clipboardInsert: "‚ú® Insert into Note",
                attachmentsTitle: "üìé Attachments",
                
                // Folder Modal
                newFolderTitle: "‚ú® New Folder",
                folderNamePlaceholder: "üìÅ Folder name...",
                chooseColor: "üé® Choose Icon Color",
                createFolder: "‚ú® Create Folder",
                
                // Why Us Modal
                whyUsModalTitle: "üåü Why Choose CloudNotes v1?",
                whyUsSubtitle: "Your Data. Your Control. Always.",
                whyUsIntro: "We built CloudNotes v1 on a simple principle: <strong>ultimate privacy and simplicity<strong>.",
                privacyTitle: "üîí Absolute Privacy",
                privacyText: "We <strong>don't track, collect, or sell any of your data<strong>. Everything you write or draw stays <strong>private<strong> on your device's local storage. This is a local-first application. Big companies (Giants) <strong>sell storage and integration. (your data too!).<strong> <strong>We (CloudeNotes) sell privacy, simplity, and vibe. <strong> Our prices are avalaible for <strong>Everyone<strong> ",
                accountsTitle: "üö´ Zero Accounts",
                accountsText: "No need for email, usernames, or passwords. <strong>No sign-ups<strong>, no log-ins, and no cloud storage required. Just open the app and start noting.",
                fastTitle: "‚ö°Ô∏è Fast & Reliable",
                fastText: "Since your notes are stored <strong>locally<strong> on your browser, loading is instantaneous. You're never dependent on a network connection or server status.",
                featuresTitle: "üìù Feature-Rich Editor",
                featuresText: "Our editor includes <strong>rich text options<strong>, a full <strong>drawing canvas<strong>, and the ability to add <strong>attachments<strong>, all while keeping your data private and local.",
                whyUsFooter: "CloudNotes v1: Simple, powerful, and truly private note-taking.",

                // Dynamic/Alerts
                emptyState: "Select a folder or create a new note",
                noNotes: "No notes yet. Create your first note!",
                folderNotFound: "Folder not found.",
                noNotesFound: (term) => `No notes found matching "${term}"`,
                noteBadge: "Note",
                bookmarkedBadge: "‚≠ê Bookmarked",
                alertEmptyFolder: "Folder name cannot be empty!",
                alertEmptyTitle: "Title cannot be empty!",
                alertNoFolder: "No folder selected!",
                alertClipboard: "Could not access clipboard. Please make sure you granted permission.",
                alertEmptyClipboard: "Clipboard is empty!",
                alertDeleteAttachment: "Are you sure you want to delete this attachment?",
                alertLoadingData: "‚úÖ Data loaded from storage!",
                alertSaving: "‚úÖ Saved!",
            },
            ru: {
                // UI Elements
                whyUsBtn: "–ü–æ—á–µ–º—É –º—ã?",
                newFolder: "+ –ü–∞–ø–∫–∞",
                newNoteIcon: "üìù",
                searchPlaceholder: "–ü–æ–∏—Å–∫ –∑–∞–º–µ—Ç–æ–∫...",
                totalNotes: "–í—Å–µ–≥–æ –∑–∞–º–µ—Ç–æ–∫",
                brushSize: "–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏:",
                saveNote: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å",

                // Note Modal
                newNoteTitle: "–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞",
                noteTitlePlaceholder: "‚ú® –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏...",
                editorPlaceholder: "‚úçÔ∏è –ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–µ –∏–¥–µ–∏...",
                drawBtn: "üé® –†–∏—Å–æ–≤–∞—Ç—å",
                imageBtn: "üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
                fileBtn: "üìé –§–∞–π–ª",
                pasteBtn: "üìã –í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞",
                bookmarkBtn: "‚≠ê –í –∑–∞–∫–ª–∞–¥–∫–∏",
                bookmarkedBtn: "üåü –í –∑–∞–∫–ª–∞–¥–∫–∞—Ö",
                canvasClear: "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å",
                canvasSave: "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫",
                clipboardTitle: "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É—Ñ–µ—Ä–∞",
                clipboardInsert: "‚ú® –í—Å—Ç–∞–≤–∏—Ç—å –≤ –∑–∞–º–µ—Ç–∫—É",
                attachmentsTitle: "üìé –í–ª–æ–∂–µ–Ω–∏—è",
                
                // Folder Modal
                newFolderTitle: "‚ú® –ù–æ–≤–∞—è –ø–∞–ø–∫–∞",
                folderNamePlaceholder: "üìÅ –ò–º—è –ø–∞–ø–∫–∏...",
                chooseColor: "üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∑–Ω–∞—á–∫–∞",
                createFolder: "‚ú® –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É",

                // Why Us Modal
                whyUsModalTitle: "üåü –ü–æ—á–µ–º—É CloudNotes v1?",
                whyUsSubtitle: "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. –í–∞—à –∫–æ–Ω—Ç—Ä–æ–ª—å. –í—Å–µ–≥–¥–∞.",
                whyUsIntro: "–ú—ã —Å–æ–∑–¥–∞–ª–∏ CloudNotes v1 –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞: <strong>–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç–∞<strong>.",
                privacyTitle: "üîí –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å",
                privacyText: "–ú—ã <strong>–Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º, –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º –∏ –Ω–µ –ø—Ä–æ–¥–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ<strong>. –í—Å–µ, —á—Ç–æ –≤—ã –ø–∏—à–µ—Ç–µ –∏–ª–∏ —Ä–∏—Å—É–µ—Ç–µ, –æ—Å—Ç–∞–µ—Ç—Å—è <strong>–ø—Ä–∏–≤–∞—Ç–Ω—ã–º<strong> –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ. –ö—Ä—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–ì–∏–≥–∞–Ω—Ç—ã) <strong>–ø—Ä–æ–¥–∞—é—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é. (–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ç–æ–∂–µ!).<strong> <strong>–ú—ã (CloudNotes) –ø—Ä–æ–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç—É –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.<strong> –ù–∞—à–∏ —Ü–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è <strong>–í—Å–µ—Ö<strong> ",
                accountsTitle: "üö´ –ù–æ–ª—å —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π",
                accountsText: "–ù–µ –Ω—É–∂–Ω—ã —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞, –∏–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ –ø–∞—Ä–æ–ª–∏. <strong>–ù–∏–∫–∞–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏<strong>, –≤—Ö–æ–¥–∞ –∏ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ –¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏.",
                fastTitle: "‚ö°Ô∏è –ë—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ",
                fastText: "–ü–æ—Å–∫–æ–ª—å–∫—É –≤–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è <strong>–ª–æ–∫–∞–ª—å–Ω–æ<strong> –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ, –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç–µ –æ—Ç —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞.",
                featuresTitle: "üìù –ë–æ–≥–∞—Ç—ã–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä",
                featuresText: "–ù–∞—à —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤–∫–ª—é—á–∞–µ—Ç <strong>—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø—Ü–∏–∏<strong>, –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π <strong>—Ö–æ–ª—Å—Ç –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è<strong> –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è <strong>–≤–ª–æ–∂–µ–Ω–∏–π<strong>, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º–∏ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–º–∏.",
                whyUsFooter: "CloudNotes v1: –ü—Ä–æ—Å—Ç–æ–µ, –º–æ—â–Ω–æ–µ –∏ –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫.",
                
                // Dynamic/Alerts
                emptyState: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É",
                noNotes: "–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–º–µ—Ç–∫—É!",
                folderNotFound: "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",
                noNotesFound: (term) => `–ó–∞–º–µ—Ç–∫–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ "${term}", –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`,
                noteBadge: "–ó–∞–º–µ—Ç–∫–∞",
                bookmarkedBadge: "‚≠ê –í –∑–∞–∫–ª–∞–¥–∫–∞—Ö",
                alertEmptyFolder: "–ò–º—è –ø–∞–ø–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!",
                alertEmptyTitle: "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!",
                alertNoFolder: "–ü–∞–ø–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞!",
                alertClipboard: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±—É—Ñ–µ—Ä—É –æ–±–º–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.",
                alertEmptyClipboard: "–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –ø—É—Å—Ç!",
                alertDeleteAttachment: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –≤–ª–æ–∂–µ–Ω–∏–µ?",
                alertLoadingData: "‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞!",
                alertSaving: "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!",
            }
        };

        // NEW: Translation helper function
        function getTranslation(key, ...args) {
            const lang = translations[currentLang] || translations['en'];
            const text = lang[key] || translations['en'][key];
            if (typeof text === 'function') {
                return text(...args);
            }
            return text;
        }

        // Initialize
        function init() {
            loadData();
            setLanguage(currentLang, false); // Initialize UI with currentLang
            renderFolders();
            updateTotalNotes();
        }

        // NEW: Function to update all static UI text
        function updateStaticUI() {
            // Sidebar Header
            document.getElementById('whyUsBtn').textContent = getTranslation('whyUsBtn');
            // Toolbar
            document.getElementById('newFolderBtn').textContent = getTranslation('newFolder');
            document.getElementById('newNoteIconBtn').textContent = getTranslation('newNoteIcon');
            // Topbar
            document.getElementById('searchInput').placeholder = getTranslation('searchPlaceholder');
            document.getElementById('totalNotesLabel').textContent = getTranslation('totalNotes');
            // Initial Empty State
            document.getElementById('initialEmptyStateText').textContent = getTranslation('emptyState');
            
            // Note Modal
            document.getElementById('modalTitle').textContent = getTranslation('newNoteTitle');
            document.getElementById('noteTitle').placeholder = getTranslation('noteTitlePlaceholder');
            document.getElementById('noteContent').placeholder = getTranslation('editorPlaceholder');
            document.getElementById('drawBtn').textContent = getTranslation('drawBtn');
            document.getElementById('imageBtn').textContent = getTranslation('imageBtn');
            document.getElementById('fileBtn').textContent = getTranslation('fileBtn');
            document.getElementById('pasteBtn').textContent = getTranslation('pasteBtn');
            document.getElementById('saveNoteBtn').textContent = getTranslation('saveNote');
            document.getElementById('clearCanvasBtn').textContent = getTranslation('canvasClear');
            document.getElementById('saveDrawingBtn').textContent = getTranslation('canvasSave');
            document.getElementById('brushSizeLabel').textContent = getTranslation('brushSize');
            document.getElementById('clipboardTitle').textContent = getTranslation('clipboardTitle');
            document.getElementById('insertClipboardBtn').textContent = getTranslation('clipboardInsert');
            document.getElementById('attachmentsTitle').textContent = getTranslation('attachmentsTitle');
            
            // Folder Modal
            document.getElementById('newFolderTitle').textContent = getTranslation('newFolderTitle');
            document.getElementById('folderName').placeholder = getTranslation('folderNamePlaceholder');
            document.getElementById('chooseColorTitle').textContent = getTranslation('chooseColor');
            document.getElementById('createFolderBtn').textContent = getTranslation('createFolder');

            // Why Us Modal
            document.getElementById('whyUsModalTitle').textContent = getTranslation('whyUsModalTitle');
            document.getElementById('whyUsSubtitle').textContent = getTranslation('whyUsSubtitle');
            document.getElementById('whyUsIntro').innerHTML = getTranslation('whyUsIntro');
            document.getElementById('privacyTitle').textContent = getTranslation('privacyTitle');
            document.getElementById('privacyText').innerHTML = getTranslation('privacyText');
            document.getElementById('accountsTitle').textContent = getTranslation('accountsTitle');
            document.getElementById('accountsText').textContent = getTranslation('accountsText');
            document.getElementById('fastTitle').textContent = getTranslation('fastTitle');
            document.getElementById('fastText').textContent = getTranslation('fastText');
            document.getElementById('featuresTitle').textContent = getTranslation('featuresTitle');
            document.getElementById('featuresText').textContent = getTranslation('featuresText');
            document.getElementById('whyUsFooter').textContent = getTranslation('whyUsFooter');

            // Set switcher value
            document.getElementById('language-switcher').value = currentLang;
        }

        // NEW: Function to set and apply language
        function setLanguage(langCode, shouldSave = true) {
            currentLang = langCode;
            updateStaticUI();
            
            // Re-render dynamic elements
            renderFolders();
            if (data.currentFolder) {
                renderNotes(data.currentFolder);
            } else {
                // Re-render the initial empty state (handled by updateStaticUI, but keep this for clarity)
                document.getElementById('contentArea').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div class="empty-text">${getTranslation('emptyState')}</div>
                    </div>
                `;
            }

            if (shouldSave) {
                saveData(); 
            }
        }


        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            document.getElementById('themeToggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            saveData();
        }
        
        // NEW FUNCTIONS: Why Us Modal
        function openWhyUsModal() {
            updateStaticUI(); // Ensure translations are fresh when opening
            document.getElementById('whyUsModal').classList.add('active');
        }

        function closeWhyUsModal() {
            document.getElementById('whyUsModal').classList.remove('active');
        }
        // END NEW FUNCTIONS

        // Update total notes count
        function updateTotalNotes() {
            let total = 0;
            data.folders.forEach(folder => {
                total += folder.notes.length;
            });
            document.getElementById('totalNotes').textContent = total;
        }

        // Clipboard functions
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    clipboardContent = text;
                    document.getElementById('clipboardSection').style.display = 'block';
                    document.getElementById('clipboardPreview').textContent = text.substring(0, 200) + (text.length > 200 ? '...' : '');
                } else {
                    alert(getTranslation('alertEmptyClipboard')); // Translated alert
                }
            } catch (err) {
                alert(getTranslation('alertClipboard')); // Translated alert
            }
        }

        function insertClipboard() {
            const editor = document.getElementById('noteContent');
            const currentContent = editor.value;
            editor.value = currentContent + (currentContent ? '\n\n' : '') + clipboardContent;
            document.getElementById('clipboardSection').style.display = 'none';
        }

        // Folders
        function renderFolders() {
            const container = document.getElementById('foldersContainer');
            container.innerHTML = '';
            
            data.folders.forEach(folder => {
                const item = document.createElement('div');
                item.className = 'folder-item';
                if (data.currentFolder === folder.id) item.classList.add('active');
                item.innerHTML = `
                    <div class="folder-icon" style="background: ${folder.color};">üìÅ</div>
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-count">${folder.notes.length}</div>
                `;
                item.onclick = () => selectFolder(folder.id);
                container.appendChild(item);
            });
        }

        function selectFolder(id) {
            data.currentFolder = id;
            data.currentNote = null;
            renderFolders();
            renderNotes(id);
            saveData();
        }

        function createFolder() {
            document.getElementById('folderName').value = '';
            // Reset color selection
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            const defaultColor = document.querySelector('.color-picker-container div');
            defaultColor.classList.add('selected');
            selectedColor = defaultColor.getAttribute('data-color');
            
            updateStaticUI(); // Ensure translations are fresh before opening
            document.getElementById('folderModal').classList.add('active');
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.remove('active');
        }

        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            selectedColor = element.getAttribute('data-color');
        }

        function saveFolderModal() {
            const name = document.getElementById('folderName').value.trim();
            if (!name) {
                alert(getTranslation('alertEmptyFolder')); // Translated alert
                return;
            }

            const newFolder = {
                id: data.nextFolderId++,
                name: name,
                color: selectedColor,
                notes: []
            };

            data.folders.push(newFolder);
            closeFolderModal();
            renderFolders();
            saveData();
        }

        // Notes
        function renderNotes(folderId) {
            const contentArea = document.getElementById('contentArea');
            const folder = data.folders.find(f => f.id === folderId);

            if (!folder) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-text">${getTranslation('folderNotFound')}</div>
                    </div>
                `;
                return;
            }
            
            if (folder.notes.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚ú®</div>
                        <div class="empty-text">${getTranslation('noNotes')}</div>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'notes-grid';

            folder.notes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                
                const noteTitle = note.title || getTranslation('newNoteTitle');
                const noteContent = note.content || getTranslation('editorPlaceholder');

                card.innerHTML = `
                    ${note.isBookmarked ? `<button class="bookmark-btn bookmarked" onclick="event.stopPropagation();">‚≠ê</button>` : ''}
                    <h3 class="note-title">${noteTitle}</h3>
                    <p class="note-preview">${noteContent.substring(0, 100)}...</p>
                    <div class="note-meta">
                        <span>üìÖ ${new Date(note.updatedAt).toLocaleDateString()}</span>
                        <span class="note-badge" style="background: ${folder.color}1A; color: ${folder.color};">
                            ${note.isBookmarked ? getTranslation('bookmarkedBadge') : getTranslation('noteBadge')}
                        </span>
                    </div>
                `;
                card.onclick = () => openNoteModal(note.id);
                grid.appendChild(card);
            });

            contentArea.innerHTML = '';
            contentArea.appendChild(grid);
        }

        function openNewNote() {
            data.currentNote = null;
            openNoteModal();
        }

        function openNoteModal(noteId = null) {
            if (data.currentFolder === null) {
                alert(getTranslation('alertNoFolder')); // Translated alert
                return;
            }

            const isNew = noteId === null;
            data.currentNote = noteId;

            updateStaticUI(); // Ensure all static text is translated

            let note = {
                title: '',
                content: '',
                fontFamily: 'Arial',
                fontSize: 16,
                isBookmarked: false,
                drawing: null,
                attachments: []
            };

            if (!isNew) {
                const folder = data.folders.find(f => f.id === data.currentFolder);
                note = folder.notes.find(n => n.id === noteId);
                if (!note) return; // Should not happen
            }

            document.getElementById('modalTitle').textContent = isNew ? getTranslation('newNoteTitle') : note.title || getTranslation('newNoteTitle');
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('fontFamily').value = note.fontFamily;
            document.getElementById('fontSize').value = note.fontSize;
            drawingData = note.drawing || null;
            currentBookmark = note.isBookmarked || false;
            
            updateBookmarkButton();
            renderAttachments(note.attachments);
            
            document.getElementById('canvasContainer').style.display = drawingData ? 'block' : 'none';
            if (drawingData) {
                setTimeout(() => loadDrawing(drawingData), 50); // Small delay for canvas to be visible
            }
            document.getElementById('clipboardSection').style.display = 'none';
            document.getElementById('noteModal').classList.add('active');
            updateEditorStyle(); // Apply font styles
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            // Re-render notes to show changes if any (e.g., if a note was saved)
            if (data.currentFolder) {
                renderNotes(data.currentFolder);
            }
            data.currentNote = null;
        }

        function updateEditorStyle() {
            const editor = document.getElementById('noteContent');
            const fontFamily = document.getElementById('fontFamily').value;
            const fontSize = document.getElementById('fontSize').value + 'px';
            
            editor.style.fontFamily = fontFamily;
            editor.style.fontSize = fontSize;
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const fontFamily = document.getElementById('fontFamily').value;
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const folder = data.folders.find(f => f.id === data.currentFolder);

            if (!folder) {
                alert(getTranslation('alertNoFolder')); // Translated alert
                return;
            }
            if (!title) {
                alert(getTranslation('alertEmptyTitle')); // Translated alert
                return;
            }

            // Get current attachments from the grid (they might have been added in the modal)
            const attachmentsGrid = document.getElementById('attachmentsGrid');
            const currentAttachments = Array.from(attachmentsGrid.children).map(item => ({
                name: item.querySelector('.attachment-name').textContent,
                type: item.dataset.type,
                dataUrl: item.dataset.data
            }));


            const newNoteData = {
                title,
                content,
                fontFamily,
                fontSize,
                drawing: drawingData,
                isBookmarked: currentBookmark,
                attachments: currentAttachments, // Use the gathered attachments
                updatedAt: new Date().toISOString()
            };

            if (data.currentNote === null) {
                // New note
                newNoteData.id = data.nextNoteId++;
                newNoteData.createdAt = newNoteData.updatedAt;
                folder.notes.push(newNoteData);
            } else {
                // Edit existing note
                const noteIndex = folder.notes.findIndex(n => n.id === data.currentNote);
                if (noteIndex !== -1) {
                    folder.notes[noteIndex] = { ...folder.notes[noteIndex], ...newNoteData };
                }
            }
            
            saveData();
            updateTotalNotes();

            // Show save indicator (using translated text)
            const saveIndicator = document.createElement('div');
            saveIndicator.className = 'save-indicator';
            saveIndicator.innerHTML = `‚úÖ ${getTranslation('alertSaving')}`;
            document.body.appendChild(saveIndicator);
            setTimeout(() => saveIndicator.remove(), 1500);

            closeNoteModal();
        }

        // Bookmark function
        function toggleBookmark() {
            currentBookmark = !currentBookmark;
            updateBookmarkButton();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            if (currentBookmark) {
                btn.classList.add('bookmarked');
                btn.innerHTML = getTranslation('bookmarkedBtn'); // Translated
            } else {
                btn.classList.remove('bookmarked');
                btn.innerHTML = getTranslation('bookmarkBtn'); // Translated
            }
        }

        // Attachments
        function addImage() {
            const files = document.getElementById('imageUpload').files;
            const note = data.currentNote !== null ? 
                data.folders.find(f => f.id === data.currentFolder).notes.find(n => n.id === data.currentNote) :
                { attachments: [] }; // Mock note for a new note, attachments will be saved on saveNote

            if (!note) return;

            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addAttachment(file.name, 'image', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function addFile() {
            const files = document.getElementById('fileUpload').files;
            const note = data.currentNote !== null ? 
                data.folders.find(f => f.id === data.currentFolder).notes.find(n => n.id === data.currentNote) :
                { attachments: [] }; // Mock note for a new note, attachments will be saved on saveNote

            if (!note) return;

            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    addAttachment(file.name, getFileType(file.name), e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(ext)) return 'image';
            if (['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) return 'audio';
            if (['mp4', 'avi', 'mov', 'webm', 'mkv'].includes(ext)) return 'video';
            if (['exe', 'msi', 'app'].includes(ext)) return 'executable';
            if (['pdf', 'doc', 'docx', 'txt', 'rtf'].includes(ext)) return 'document';
            if (['zip', 'rar', '7z', 'tar'].includes(ext)) return 'archive';
            return 'file';
        }

        function getAttachmentIcon(type) {
            const icons = {
                image: 'üñºÔ∏è',
                audio: 'üéµ',
                video: 'üé¨',
                document: 'üìÑ',
                archive: 'üì¶',
                executable: '‚öôÔ∏è',
                file: 'üìé'
            };
            return icons[type] || 'üìé';
        }


        function addAttachment(name, type, dataUrl) {
            const grid = document.getElementById('attachmentsGrid');

            const item = document.createElement('div');
            item.className = 'attachment-item';
            item.dataset.type = type;
            item.dataset.data = dataUrl;
            
            const icon = getAttachmentIcon(type);
            
            // Allow deletion directly in the modal for unsaved/new notes as well
            item.innerHTML = `
                <div style="position: relative;">
                    <button onclick="event.stopPropagation(); deleteAttachmentElement(this)" style="position: absolute; top: -10px; right: -10px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                    <div class="attachment-icon">${icon}</div>
                </div>
                <div class="attachment-name">${name}</div>
            `;
            item.onclick = () => viewAttachment(dataUrl, name, type);
            grid.appendChild(item);

            // If the note is already saved, update the in-memory data immediately
            if (data.currentNote !== null) {
                const folder = data.folders.find(f => f.id === data.currentFolder);
                const note = folder.notes.find(n => n.id === data.currentNote);
                if (note) {
                    note.attachments.push({ name, type, dataUrl });
                    saveData();
                }
            }
        }

        function deleteAttachmentElement(button) {
            if (!confirm(getTranslation('alertDeleteAttachment'))) return; // Translated confirm
            const item = button.closest('.attachment-item');
            const grid = item.parentNode;
            const index = Array.from(grid.children).indexOf(item);

            // Remove from the DOM
            item.remove();

            // If the note is already saved, also remove from the in-memory data
            if (data.currentNote !== null) {
                const folder = data.folders.find(f => f.id === data.currentFolder);
                const note = folder.notes.find(n => n.id === data.currentNote);
                if (note && note.attachments) {
                    note.attachments.splice(index, 1);
                    saveData();
                }
            }
        }


        function renderAttachments(attachments) {
            const grid = document.getElementById('attachmentsGrid');
            grid.innerHTML = attachments.map((att, index) => `
                <div class="attachment-item" data-type="${att.type}" data-data="${att.dataUrl}" onclick="viewAttachment('${att.dataUrl}', '${att.name}', '${att.type}')">
                    <div style="position: relative;">
                        <button onclick="event.stopPropagation(); deleteAttachmentElement(this)" style="position: absolute; top: -10px; right: -10px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">√ó</button>
                        <div class="attachment-icon">${getAttachmentIcon(att.type)}</div>
                    </div>
                    <div class="attachment-name">${att.name}</div>
                </div>
            `).join('');
        }

        function viewAttachment(dataUrl, name, type) {
            if (type.startsWith('image')) {
                const newWindow = window.open();
                newWindow.document.write(`<img src="${dataUrl}" alt="${name}" style="max-width: 100%; display: block;">`);
            } else {
                // For other files, you can just download them
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Drawing Canvas functions (no translation needed here except for the status/toolbar)
        function setupCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            // Set initial canvas dimensions
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            // Touch events
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
            
            // Color and Size listeners
            document.getElementById('drawColor').addEventListener('input', (e) => ctx.strokeStyle = e.target.value);
            document.getElementById('drawSize').addEventListener('input', (e) => ctx.lineWidth = e.target.value);
        }

        function toggleDrawing() {
            const container = document.getElementById('canvasContainer');
            if (container.style.display === 'block') {
                container.style.display = 'none';
                drawingData = canvas.toDataURL(); // Save before hiding
            } else {
                container.style.display = 'block';
                // Need to resize canvas on display if it was hidden
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                loadDrawing(drawingData); // Load previous drawing if available
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX || e.clientX - canvas.getBoundingClientRect().left, e.offsetY || e.clientY - canvas.getBoundingClientRect().top);
            ctx.strokeStyle = document.getElementById('drawColor').value;
            ctx.lineWidth = document.getElementById('drawSize').value;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.lineTo(e.offsetX || e.clientX - canvas.getBoundingClientRect().left, e.offsetY || e.clientY - canvas.getBoundingClientRect().top);
            ctx.stroke();
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingData = null;
        }

        function loadDrawing(dataUrl) {
            if (dataUrl) {
                const img = new Image();
                img.onload = function() {
                    // Temporarily set canvas size to image size to avoid distortion during load
                    const originalWidth = canvas.width;
                    const originalHeight = canvas.height;
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    ctx.drawImage(img, 0, 0);
                    
                    // Resize canvas back to its original responsive size
                    canvas.width = originalWidth;
                    canvas.height = originalHeight;
                    // Redraw the image scaled to fit the new canvas size
                    ctx.drawImage(img, 0, 0, originalWidth, originalHeight);

                    // Re-apply drawing styles
                    ctx.strokeStyle = document.getElementById('drawColor').value;
                    ctx.lineWidth = document.getElementById('drawSize').value;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                };
                img.src = dataUrl;
            } else {
                clearCanvas();
            }
        }

        function saveDrawing() {
            drawingData = canvas.toDataURL();
            document.getElementById('drawingStatus').textContent = `(${getTranslation('alertSaving')}!)`; // Translated status
            setTimeout(() => document.getElementById('drawingStatus').textContent = '', 1500);
        }

        // Search function
        function searchNotes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const contentArea = document.getElementById('contentArea');
            let allNotes = [];
            // Collect all notes from all folders
            data.folders.forEach(folder => {
                folder.notes.forEach(note => {
                    allNotes.push({ ...note, folderColor: folder.color, folderId: folder.id });
                });
            });

            const filteredNotes = allNotes.filter(note => 
                note.title.toLowerCase().includes(searchTerm) || 
                note.content.toLowerCase().includes(searchTerm)
            );

            if (searchTerm === '') {
                // If search is empty, show the current folder or empty state
                if (data.currentFolder) {
                    renderNotes(data.currentFolder);
                } else {
                     document.getElementById('contentArea').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìù</div>
                            <div class="empty-text">${getTranslation('emptyState')}</div>
                        </div>
                    `;
                }
                return;
            }

            if (filteredNotes.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-text">${getTranslation('noNotesFound', searchTerm)}</div>
                    </div>
                `;
                return;
            }

            // Render search results
            contentArea.innerHTML = `<div class="notes-grid">${filteredNotes.map(note => `
                <div class="note-card" onclick="selectFolder(${note.folderId}); openNoteModal(${note.id});">
                    ${note.isBookmarked ? '<button class="bookmark-btn bookmarked" onclick="event.stopPropagation();">‚≠ê</button>' : ''}
                    <h3 class="note-title">${note.title}</h3>
                    <p class="note-preview">${note.content.substring(0, 100)}...</p>
                    <div class="note-meta">
                        <span>üìÖ ${new Date(note.updatedAt).toLocaleDateString()}</span>
                        <span class="note-badge" style="background: ${note.folderColor}1A; color: ${note.folderColor};">
                            ${note.isBookmarked ? getTranslation('bookmarkedBadge') : getTranslation('noteBadge')}
                        </span>
                    </div>
                </div>
            `).join('')}</div>`;
        }

        // Local Storage
        function saveData() {
            const saveObject = {
                folders: data.folders,
                currentFolder: data.currentFolder,
                nextFolderId: data.nextFolderId,
                nextNoteId: data.nextNoteId,
                theme: document.body.getAttribute('data-theme'),
                language: currentLang // NEW: Save current language
            };
            localStorage.setItem('cloudNotesData', JSON.stringify(saveObject));
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem('cloudNotesData');
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    data.folders = parsed.folders;
                    data.currentFolder = parsed.currentFolder;
                    data.nextFolderId = parsed.nextFolderId;
                    data.nextNoteId = parsed.nextNoteId;
                    
                    if (parsed.theme) {
                        document.body.setAttribute('data-theme', parsed.theme);
                        document.getElementById('themeToggle').textContent = 
                            parsed.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                    }
                    
                    // NEW: Load and set language
                    if (parsed.language) {
                        currentLang = parsed.language;
                    }

                    console.log(getTranslation('alertLoadingData')); // Translated console message
                } else if (window.appData) {
                    // Fallback to window data
                    data.folders = window.appData.folders;
                    data.currentFolder = window.appData.currentFolder;
                    data.nextFolderId = window.appData.nextFolderId;
                    data.nextNoteId = window.appData.nextNoteId;
                    
                    if (window.appData.theme) {
                        document.body.setAttribute('data-theme', window.appData.theme);
                        document.getElementById('themeToggle').textContent = 
                            window.appData.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                    }
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        // Initialize app
        init();
    </script>
</body>
</html>
                            
                            <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes v2.3 - Ultimate Edition</title>
    
    <style>
        /* CSS Reset and Box Model */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Color Variables (Light & Dark Theme) */
        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f0f5;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-hover: rgba(99, 102, 241, 0.2);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #262626;
            --text-primary: #f5f5f5;
            --text-secondary: #9ca3af;
            --accent: #818cf8;
            --accent-hover: #6366f1;
            --accent-light: rgba(129, 140, 248, 0.15);
            --border: #2d2d2d;
            --shadow: rgba(0, 0, 0, 0.4);
            --shadow-hover: rgba(129, 140, 248, 0.3);
        }

        /* Base Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ===================================== */
        /* SIDEBAR STYLES            */
        /* ===================================== */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 10px var(--shadow);
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 30px 24px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent-light), transparent);
        }

        .app-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .app-author {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .why-us-btn {
            display: block;
            width: 100%;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--accent);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--accent);
            box-shadow: 0 2px 8px var(--shadow-hover);
            text-align: center;
        }

        .why-us-btn:hover {
            background: var(--accent);
            color: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .why-us-btn:active {
            transform: translateY(0);
        }

        /* Toolbar in Sidebar */
        .toolbar {
            padding: 20px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        /* General Button Styles */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
            flex-shrink: 0;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            padding: 10px 14px;
            font-size: 18px;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #d97706;
        }
        
        /* NEW: Trash Folder Styles */
        .folder-item.trash-item {
            border: 2px solid var(--danger) !important;
            background: var(--danger) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4) !important;
        }
        
        .folder-item.trash-item:hover {
            background: #cc3333 !important;
        }
        
        .folder-item.trash-item .folder-icon {
            background: white !important;
            color: var(--danger) !important;
        }
        /* End NEW: Trash Folder Styles */


        /* Folders Container and Scrollbar */
        .folders-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .system-folders {
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .folders-container::-webkit-scrollbar {
            width: 6px;
        }

        .folders-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        /* Folder Item Styling */
        .folder-item {
            padding: 14px 18px;
            margin: 6px 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 2px solid transparent;
        }

        .folder-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(6px);
            border-color: var(--accent-light);
        }

        .folder-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateX(6px);
            border-color: var(--accent);
        }
        
        .folder-item.active:not(.trash-item) .folder-icon {
            background: white !important;
            color: var(--accent) !important;
        }

        .folder-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .folder-item:hover .folder-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .folder-name {
            flex: 1;
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .folder-count {
            font-size: 13px;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* ===================================== */
        /* MAIN CONTENT               */
        /* ===================================== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar (Search, Stats, Theme Toggle) */
        .topbar {
            padding: 20px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow);
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-bar {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-secondary);
        }
        
        /* NEW: Sort Bar Style */
        .sort-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .sort-bar select {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        /* End NEW: Sort Bar Style */

        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-shrink: 0;
        }

        .theme-toggle {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--accent);
        }

        /* Content Area and Note Grid */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: var(--bg-primary);
        }

        .content-area::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        /* Note Card Styling - MODIFIED FOR LEFT COLOR BAR */
        .note-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
            animation: fadeIn 0.4s ease;
            position: relative;
            overflow: hidden;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }
        
        /* NEW: Left Color Indicator Bar */
        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px; /* Width of the color bar */
            height: 100%;
            /* Use a custom CSS property to set the color dynamically */
            background: var(--note-indicator-color, transparent); 
            transition: background 0.3s ease;
            z-index: 5;
            box-shadow: 2px 0 6px var(--shadow); 
        }

        .note-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px var(--shadow);
            /* Border color now based on indicator color or accent */
            border-color: var(--note-indicator-color, var(--accent)); 
        }
        
        /* NEW: Space Theme Style */
        .note-card.space-bg {
            background: #0D0F16 !important; 
            color: #f5f5f5 !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }

        .note-card.space-bg .note-title,
        .note-card.space-bg .note-meta {
            color: #f5f5f5 !important;
        }

        .note-card.space-bg .note-preview {
            color: #a0a0a0 !important;
        }


        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .note-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .note-preview {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 12px;
            flex-grow: 1;
        }
        
        /* NEW: Tags Display on Card */
        .note-tags-display {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .note-tag-display {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
        }
        /* End NEW: Tags Display */

        .note-meta {
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        
        .trash-note-meta {
            justify-content: flex-start;
            gap: 15px;
        }

        .note-badge {
            background: var(--accent-light);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        /* Bookmark Button on Card */
        .bookmark-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            filter: grayscale(1);
            z-index: 10;
        }

        .bookmark-btn.bookmarked {
            filter: grayscale(0);
            transform: scale(1.2);
            color: var(--warning);
        }
        
        /* Save/Action Indicator */
        .save-indicator {
            padding: 12px 20px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }


        /* ===================================== */
        /* MODAL STYLES             */
        /* ===================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transition: background 0.4s, color 0.4s; /* For note color change */
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--accent-light);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .close-btn:hover {
            color: var(--danger);
            border-color: var(--danger);
            transform: scale(1.1) rotate(90deg);
        }

        .modal-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
        
        /* ===================================== */
        /* NOTE EDITOR STYLES         */
        /* ===================================== */
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .modal-content[style*="0D0F16"] .section-title {
            color: #f5f5f5 !important;
        }


        /* NEW: Note Color Picker */
        .note-color-picker {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .note-color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px var(--shadow);
        }
        
        .note-color-option.selected {
            border-color: var(--accent);
            transform: scale(1.1);
            box-shadow: 0 0 0 4px var(--accent-light);
        }
        
        /* NEW: Tags Input & History/Delete Buttons */
        .note-tags-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .note-tags-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
        }
        
        .note-tags-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }
        
        .history-btn-group {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }
        /* End NEW: Tags Input & History/Delete Buttons */


        /* Editor Toolbar */
        .editor-toolbar {
            display: flex;
            gap: 12px;
            padding: 18px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            border: 2px solid var(--border);
        }

        .editor-toolbar select,
        .editor-toolbar input[type="number"] {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .editor-toolbar select:focus,
        .editor-toolbar input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .editor-toolbar button {
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .editor-toolbar button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        /* Title Input */
        .note-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: 20px;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .modal-content[style*="0D0F16"] .note-input {
            background: #262626;
            color: #f5f5f5;
            border-color: #3b82f6;
        }

        /* Content Editor */
        .note-editor {
            width: 100%;
            min-height: 350px;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.7;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        
        .modal-content[style*="0D0F16"] .note-editor {
            background: #262626;
            color: #f5f5f5;
            border-color: #3b82f6;
        }

        .note-editor:focus,
        .note-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        /* Canvas (Drawing) Section */
        .canvas-container {
            margin: 24px 0;
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px var(--shadow);
        }

        #drawingCanvas {
            display: block;
            width: 100%;
            height: 400px;
            cursor: crosshair;
            background: white;
        }

        .canvas-toolbar {
            padding: 16px;
            background: var(--bg-tertiary);
            display: flex;
            gap: 12px;
            align-items: center;
            border-top: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .canvas-toolbar button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .canvas-toolbar input[type="color"] {
            width: 50px;
            height: 40px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }

        .canvas-toolbar input[type="range"] {
            width: 120px;
        }

        /* Attachments Section */
        .attachments-section {
            margin-top: 28px;
        }

        .attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .attachment-item {
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
            position: relative;
        }
        
        .modal-content[style*="0D0F16"] .attachment-item {
            background: #262626;
            color: #f5f5f5;
            border-color: #3b82f6;
        }


        .attachment-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
            border-color: var(--accent);
        }

        .attachment-icon {
            font-size: 38px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px var(--shadow));
        }

        .attachment-name {
            font-size: 13px;
            word-break: break-all;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input[type="file"] {
            display: none;
        }
        
        /* Clipboard Section */
        .clipboard-section {
            margin-top: 28px;
            padding: 20px;
            background: var(--accent-light);
            border-radius: 12px;
            border: 2px solid var(--accent);
        }
        
        .modal-content[style*="0D0F16"] .clipboard-section {
            background: #1e3a8a;
            border-color: #3b82f6;
        }

        .clipboard-preview {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            max-height: 100px;
            overflow-y: auto;
        }
        
        .modal-content[style*="0D0F16"] .clipboard-preview {
            background: #0f0f0f;
            color: #9ca3af;
        }
        
        /* Folder Modal Color Picker */
        .color-picker-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .color-option:hover {
            transform: scale(1.15);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 4px var(--accent-light);
            transform: scale(1.15);
        }

        /* Stats in Topbar */
        .stat-item {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 600;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.6;
            filter: drop-shadow(0 4px 8px var(--shadow));
        }

        .empty-text {
            font-size: 20px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Why Us Section Styles */
        .why-us-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }

        .why-us-card {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
            transition: transform 0.3s;
        }

        .why-us-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .why-us-card h4 {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .why-us-card p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        /* End Why Us Section Styles */

        /* NEW: History Modal Styles */
        .history-list {
            list-style: none;
            padding: 0;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }
        
        .history-item-meta {
            font-size: 14px;
            color: var(--text-secondary);
            flex-grow: 1;
        }
        
        .history-item button {
            margin-left: 15px;
        }
        /* END NEW: History Modal Styles */
        
    </style>
</head>
<body data-theme="light">
    
    <div class="app-container">
        
        <div class="sidebar">
            
            <div class="sidebar-header">
                <div class="app-title">CloudNotes v2.3</div>
                <div class="app-author">by Niko (Improved Note Colors)</div>
                <button class="why-us-btn" onclick="openWhyUsModal()">Why Us?</button>
            </div>
            
            <div class="toolbar">
                <button class="btn" onclick="createFolder()">+ Folder</button>
                <button class="btn btn-icon" onclick="openNewNote()">üìù</button>
                <button class="btn btn-warning" onclick="exportData()">‚¨áÔ∏è Export Data</button>
                <button class="btn btn-success" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Import Data</button>
                <input type="file" id="importFile" accept="application/json" onchange="importData(event)" style="display: none;">
            </div>

            <div class="folders-container" id="foldersContainer">
                </div>
            
        </div>

        <div class="main-content">
            
            <div class="topbar">
                
                <div class="search-bar">
                    <input type="text" placeholder="Search notes..." id="searchInput" oninput="searchNotes()">
                    <span class="search-icon">üîç</span>
                </div>
                
                <div class="sort-bar">
                    <label style="font-size: 14px; color: var(--text-secondary); font-weight: 600; white-space: nowrap;">Sort by:</label>
                    <select id="sortSelect" onchange="data.sortOrder = this.value; renderNotes(data.currentFolder); saveData();">
                        <option value="updatedDesc">Last Updated (Newest)</option>
                        <option value="updatedAsc">Last Updated (Oldest)</option>
                        <option value="createdDesc">Date Created (Newest)</option>
                        <option value="titleAsc">Title (A-Z)</option>
                        <option value="bookmarked">Bookmarked First</option>
                    </select>
                </div>
                
                <div class="topbar-actions">
                    <div class="stat-item">
                        <span class="stat-value" id="totalNotes">0</span>
                        <div class="stat-label">Total Notes</div>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
                </div>
                
            </div>

            <div class="content-area" id="contentArea">
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-text">Select a folder or create a new note</div>
                </div>
            </div>
            
        </div>
        
    </div>

    
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">New Note</div>
                <button class="close-btn" onclick="closeNoteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="noteTitle" placeholder="‚ú® Note title...">
                
                <h3 class="section-title" style="margin-top: 0;">üé® Note Color Indicator</h3>
                <div class="note-color-picker" id="noteColorPicker">
                    <div class="note-color-option selected" style="background: var(--bg-secondary);" data-color="transparent" onclick="selectNoteColor(this)"></div>
                    
                    <div class="note-color-option" style="background: #4ade80;" data-color="#4ade80" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #fb7185;" data-color="#fb7185" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #facc15;" data-color="#facc15" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #60a5fa;" data-color="#60a5fa" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #a855f7;" data-color="#a855f7" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #0D0F16; border: 2px solid #3b82f6;" data-color="space" onclick="selectNoteColor(this)"></div> 
                </div>
                
                <h3 class="section-title">üè∑Ô∏è Tags (comma separated)</h3>
                <div class="note-tags-input-container">
                    <input type="text" class="note-tags-input" id="noteTags" placeholder="e.g., important, idea, v1-bug">
                    <div class="history-btn-group">
                        <button class="btn btn-warning" onclick="openHistoryModal()" id="historyBtn" style="display: none;">‚è≥ History</button>
                        <button class="btn btn-warning" onclick="deleteNote()" id="noteDeleteBtn" style="background: var(--danger); color: white;">üóëÔ∏è Delete</button>
                    </div>
                </div>
                
                <div class="editor-toolbar">
                    <select id="fontFamily" onchange="updateEditorStyle()">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Comic Sans MS">Comic Sans MS</option>
                        <option value="Brush Script MT">Brush Script</option>
                        <option value="Trebuchet MS">Trebuchet</option>
                    </select>
                    
                    <input type="number" id="fontSize" value="16" min="10" max="48" onchange="updateEditorStyle()" placeholder="Size">
                    
                    <button onclick="toggleDrawing()">üé® Draw</button>
                    <button onclick="document.getElementById('imageUpload').click()">üñºÔ∏è Image</button>
                    <button onclick="document.getElementById('fileUpload').click()">üìé File</button>
                    <button onclick="pasteFromClipboard()" class="btn-warning">üìã Paste Clipboard</button>
                    <button onclick="toggleBookmark()" id="bookmarkBtn">‚≠ê Bookmark</button>
                    <button onclick="saveNote()" class="btn btn-success">üíæ Save Note</button>
                </div>

                <textarea class="note-editor" id="noteContent" placeholder="‚úçÔ∏è Start writing your amazing ideas..."></textarea>

                <div class="canvas-container" id="canvasContainer" style="display: none;">
                    <canvas id="drawingCanvas"></canvas>
                    <div class="canvas-toolbar">
                        <button onclick="clearCanvas()" style="background: var(--danger); color: white;">üóëÔ∏è Clear</button>
                        <button onclick="saveDrawing()" class="btn-success" style="background: var(--success); color: white;">üíæ Save Drawing</button>
                        <input type="color" id="drawColor" value="#6366f1">
                        <label style="color: var(--text-secondary); font-size: 13px; font-weight: 600;">Brush Size:</label>
                        <input type="range" id="drawSize" min="1" max="30" value="3">
                        <span id="drawingStatus"></span>
                    </div>
                </div>

                <div class="clipboard-section" id="clipboardSection" style="display: none;">
                    <h3 class="section-title">üìã Clipboard Content</h3>
                    <div class="clipboard-preview" id="clipboardPreview"></div>
                    <button class="btn" style="margin-top: 12px;" onclick="insertClipboard()">‚ú® Insert into Note</button>
                </div>

                <div class="attachments-section">
                    <h3 class="section-title">üìé Attachments</h3>
                    <div class="attachments-grid" id="attachmentsGrid"></div>
                </div>

                <input type="file" id="imageUpload" accept="image/*" onchange="addImage()" multiple>
                <input type="file" id="fileUpload" onchange="addFile()" multiple>
            </div>
        </div>
    </div>

    <div class="modal" id="folderModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">‚ú® New Folder</div>
                <button class="close-btn" onclick="closeFolderModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="folderName" placeholder="üìÅ Folder name...">
                
                <h3 class="section-title">üé® Choose Icon Color</h3>
                <div class="color-picker-container">
                    <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #84cc16;" data-color="#84cc16" onclick="selectColor(this)"></div>
                </div>

                <button class="btn" style="margin-top: 28px; width: 100%;" onclick="saveFolderModal()">‚ú® Create Folder</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="whyUsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">üåü Why Choose CloudNotes v2.3?</div>
                <button class="close-btn" onclick="closeWhyUsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <h2 style="font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 20px; color: var(--accent);">Your Data. Your Control. Always.</h2>
                <p style="font-size: 16px; text-align: center; color: var(--text-secondary);">We built CloudNotes v1 on a simple principle: <strong>ultimate privacy and simplicity</strong>.</p>
                <div class="why-us-section">
                    
                    <div class="why-us-card">
                        <h4>üîí Absolute Privacy</h4>
                        <p>We <strong>don't track, collect, or sell any of your data</strong>. Everything you write or draw stays <strong>private</strong> on your device's local storage. This is a local-first application. Big companies (Giants) <strong>sell storage and integration. (your data too!)</strong>. <strong>We (CloudeNotes) sell privacy, simplity, and vibe.</strong> Our prices are avalaible for <strong>Everyone</strong> </p>
                    </div>

                    <div class="why-us-card">
                        <h4>üö´ Zero Accounts</h4>
                        <p>No need for email, usernames, or passwords. <strong>No sign-ups</strong>, no log-ins, and no cloud storage required. Just open the app and start noting.</p>
                    </div>

                    <div class="why-us-card">
                        <h4>‚ö°Ô∏è Fast & Reliable</h4>
                        <p>Since your notes are stored <strong>locally</strong> on your browser, loading is instantaneous. You're never dependent on a network connection or server status.</p>
                    </div>

                    <div class="why-us-card">
                        <h4>üìù Feature-Rich Editor</h4>
                        <p>Our editor includes <strong>rich text options</strong>, a full <strong>drawing canvas</strong>, and the ability to add <strong>attachments</strong>, all while keeping your data private and local.</p>
                    </div>

                </div>
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="font-size: 14px; color: var(--text-primary); font-weight: 600;">CloudNotes v2.3: Simple, powerful, and truly private note-taking.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">‚è≥ Version History</div>
                <button class="close-btn" onclick="closeHistoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <ul class="history-list" id="historyList">
                    <p style="text-align: center; color: var(--text-secondary);">Loading history...</p>
                </ul>
                <p style="margin-top: 20px; font-size: 14px; color: var(--danger);">*Restoring a version will overwrite the current note content.</p>
            </div>
        </div>
    </div>
    
    <script>
        
        // --- DATA STRUCTURE ---
        let data = {
            folders: [
                { id: 1, name: 'Work', color: '#6366f1', notes: [] },
                { id: 2, name: 'Home', color: '#10b981', notes: [] },
                { id: 3, name: 'Fun Projects :)', color: '#f59e0b', notes: [] }
            ],
            trash: [], // NEW: Recycling Bin
            TRASH_ID: -1, 
            sortOrder: 'updatedDesc', // NEW: Default sort order
            currentFolder: null,
            currentNote: null,
            nextFolderId: 4,
            nextNoteId: 1
        };

        // --- GLOBAL STATE ---
        let canvas, ctx, isDrawing = false;
        let selectedColor = '#6366f1'; // For folder creation
        let selectedNoteColor = 'transparent'; // For note color
        let drawingData = null;
        let currentBookmark = false;
        let clipboardContent = '';

        
        // --- INITIALIZATION ---
        function init() {
            loadData();
            renderFolders();
            setupCanvas();
            updateTotalNotes();
            
            // Set initial sort order on load
            document.getElementById('sortSelect').value = data.sortOrder;
            
            // Auto-select first folder if none is selected
            if (!data.currentFolder && data.folders.length > 0) {
                 selectFolder(data.folders[0].id);
            } else if (data.currentFolder) {
                // Re-render notes for the last selected folder on load
                selectFolder(data.currentFolder); 
            }
        }

        // --- CORE DATA FUNCTIONS (Save/Load) ---
        function saveData() {
            try {
                // Save the main data structure
                localStorage.setItem('cloudNotesData', JSON.stringify(data));
                // Save the current theme preference
                localStorage.setItem('theme', document.body.getAttribute('data-theme'));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                alert("Error saving data. Your browser storage may be full or disabled.");
            }
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem('cloudNotesData');
                const storedTheme = localStorage.getItem('theme');
                
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    
                    // Restore data object, providing defaults for new fields if they don't exist
                    data.folders = parsed.folders || data.folders;
                    data.trash = parsed.trash || [];
                    data.TRASH_ID = parsed.TRASH_ID || -1;
                    data.currentFolder = parsed.currentFolder;
                    data.nextFolderId = parsed.nextFolderId || data.nextFolderId;
                    data.nextNoteId = parsed.nextNoteId || data.nextNoteId;
                    data.sortOrder = parsed.sortOrder || 'updatedDesc';
                    
                    // IMPORTANT: Ensure all notes have a history array (for new feature compatibility)
                    data.folders.forEach(f => f.notes.forEach(n => n.history = n.history || []));
                    data.trash.forEach(n => n.history = n.history || []);
                    
                    // Check for trash auto-delete on load
                    checkAutoDelete();
                }

                if (storedTheme) {
                    document.body.setAttribute('data-theme', storedTheme);
                    document.getElementById('themeToggle').textContent = 
                        storedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                }
                
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }
        
        // --- RESTORED: EXPORT/IMPORT FUNCTIONS ---
        function exportData() {
            const dataToExport = JSON.stringify(data, null, 2);
            
            const blob = new Blob([dataToExport], { type: 'application/json' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CloudNotes_Backup_${new Date().toISOString().substring(0, 10)}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); 
            
            const indicator = document.createElement('div');
            indicator.className = 'save-indicator';
            indicator.style.background = 'var(--success)';
            indicator.innerHTML = `‚¨áÔ∏è Data Exported Successfully!`;
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 2500);
        }

        function importData(event) {
            if (!confirm('WARNING: Importing data will OVERWRITE your current notes. Are you sure you want to proceed?')) {
                event.target.value = null; 
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.folders || !Array.isArray(importedData.folders)) {
                        alert('Import Failed: The file does not appear to be a valid CloudNotes backup file.');
                        return;
                    }
                    
                    // Overwrite current data in localStorage
                    localStorage.setItem('cloudNotesData', JSON.stringify(importedData));
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'save-indicator';
                    indicator.style.background = 'var(--accent)';
                    indicator.innerHTML = `‚¨ÜÔ∏è Data Imported! Reloading...`;
                    document.body.appendChild(indicator);
                    
                    setTimeout(() => {
                        location.reload(); 
                    }, 2000);
                    
                } catch (error) {
                    alert('Import Failed: Error parsing the JSON file. It may be corrupted.');
                    console.error('Import Error:', error);
                }
            };
            
            reader.readAsText(file);
        }
        // --- END RESTORED: EXPORT/IMPORT FUNCTIONS ---
        
        // --- NEW: Trash Auto-Delete ---
        function checkAutoDelete() {
            const now = Date.now();
            const thirtyDays = 30 * 24 * 60 * 60 * 1000; 

            // Filter out notes in trash that are older than 30 days
            const initialTrashCount = data.trash.length;
            data.trash = data.trash.filter(note => {
                // Keep notes without a deletedAt date for safety
                if (!note.deletedAt) return true; 

                const deletedTime = new Date(note.deletedAt).getTime();
                return (now - deletedTime) < thirtyDays;
            });

            if (data.trash.length !== initialTrashCount) {
                console.log(`üßπ Auto-deleted ${initialTrashCount - data.trash.length} notes from trash.`);
                saveData();
                renderFolders(); 
            }
        }
        
        // --- Theme and Stats ---
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            document.getElementById('themeToggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            saveData();
        }
        
        function updateTotalNotes() {
            let total = 0;
            data.folders.forEach(folder => {
                total += folder.notes.length;
            });
            document.getElementById('totalNotes').textContent = total;
        }

        // --- RESTORED: Clipboard functions ---
        async function pasteFromClipboard() {
            try {
                // Use the modern clipboard API
                const text = await navigator.clipboard.readText();
                if (text) {
                    clipboardContent = text;
                    document.getElementById('clipboardSection').style.display = 'block';
                    document.getElementById('clipboardPreview').textContent = text.substring(0, 200) + (text.length > 200 ? '...' : '');
                } else {
                    alert('Clipboard is empty or access denied!');
                }
            } catch (err) {
                alert('Could not access clipboard. Please make sure you granted permission in browser settings.');
            }
        }

        function insertClipboard() {
            const editor = document.getElementById('noteContent');
            const currentContent = editor.value;
            // Insert the clipboard content, adding newlines for separation
            editor.value = currentContent + (currentContent ? '\n\n' : '') + clipboardContent;
            document.getElementById('clipboardSection').style.display = 'none';
            clipboardContent = ''; // Clear after insertion
        }

        // --- FOLDERS ---
        function renderFolders() {
            const container = document.getElementById('foldersContainer');
            container.innerHTML = '';
            
            // Render main folders
            const folderList = document.createElement('div');
            folderList.className = 'main-folders';
            data.folders.forEach(folder => {
                const item = document.createElement('div');
                item.className = 'folder-item';
                if (data.currentFolder === folder.id) item.classList.add('active');
                item.innerHTML = `
                    <div class="folder-icon" style="background: ${folder.color};">üìÅ</div>
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-count">${folder.notes.length}</div>
                `;
                item.onclick = () => selectFolder(folder.id);
                folderList.appendChild(item);
            });
            container.appendChild(folderList);
            
            // Render system folders (Trash)
            const trashContainer = document.createElement('div');
            trashContainer.className = 'system-folders';
            
            const trashItem = document.createElement('div');
            trashItem.className = 'folder-item trash-item';
            if (data.currentFolder === data.TRASH_ID) trashItem.classList.add('active');
            trashItem.innerHTML = `
                <div class="folder-icon">üóëÔ∏è</div>
                <div class="folder-name">Trash</div>
                <div class="folder-count">${data.trash.length}</div>
            `;
            trashItem.onclick = () => selectFolder(data.TRASH_ID);
            trashContainer.appendChild(trashItem);
            container.appendChild(trashContainer);
        }

        function selectFolder(id) {
            data.currentFolder = id;
            data.currentNote = null;
            renderFolders();
            renderNotes(id);
            saveData();
        }

        function createFolder() {
            // Reset modal inputs and color selection
            document.getElementById('folderName').value = '';
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            const defaultColor = document.querySelector('.color-picker-container div');
            defaultColor.classList.add('selected');
            selectedColor = defaultColor.getAttribute('data-color');
            
            document.getElementById('folderModal').classList.add('active');
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.remove('active');
        }

        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            selectedColor = element.getAttribute('data-color');
        }
        
        // MODIFIED: Logic for handling the 'space' theme preview
        function selectNoteColor(element) {
            document.querySelectorAll('#noteColorPicker .note-color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            selectedNoteColor = element.getAttribute('data-color');
            
            // Apply the color immediately to the modal content
            const modalContent = document.getElementById('noteModal').querySelector('.modal-content');
            
            if (selectedNoteColor === 'space') {
                modalContent.style.background = '#0D0F16'; 
                modalContent.style.color = '#f5f5f5'; // Change text color for dark background
                document.querySelectorAll('.section-title').forEach(el => el.style.color = '#f5f5f5');
            } else {
                modalContent.style.background = 'var(--bg-secondary)'; 
                modalContent.style.color = 'var(--text-primary)'; // Reset text color
                document.querySelectorAll('.section-title').forEach(el => el.style.color = 'var(--text-primary)');
            }
        }

        function saveFolderModal() {
            const name = document.getElementById('folderName').value.trim();
            if (!name) {
                alert('Folder name cannot be empty!');
                return;
            }

            const newFolder = {
                id: data.nextFolderId++,
                name: name,
                color: selectedColor,
                notes: []
            };

            data.folders.push(newFolder);
            closeFolderModal();
            renderFolders();
            saveData();
        }
        
        // --- NOTES RENDERING AND SORTING ---
        function getNoteBadgeText(note) {
            if (note.isBookmarked) return '‚≠ê Bookmarked';
            if (note.attachments && note.attachments.length > 0) return `üìé ${note.attachments.length} files`;
            if (note.tags && note.tags.length > 0) return `üè∑Ô∏è ${note.tags[0]}`;
            return 'Note';
        }
        
        function sortNotes(notes) {
            const sortOrder = data.sortOrder;
            
            return notes.sort((a, b) => {
                // 1. Bookmarked first
                if (sortOrder === 'bookmarked') {
                    if (a.isBookmarked && !b.isBookmarked) return -1;
                    if (!a.isBookmarked && b.isBookmarked) return 1;
                }
                
                // 2. Title sorting
                if (sortOrder === 'titleAsc') {
                    return a.title.localeCompare(b.title);
                }
                
                // 3. Date sorting (updatedAt is preferred for sorting)
                const dateA = new Date(a[sortOrder.includes('created') ? 'createdAt' : 'updatedAt'] || a.createdAt).getTime();
                const dateB = new Date(b[sortOrder.includes('created') ? 'createdAt' : 'updatedAt'] || b.createdAt).getTime();
                
                if (sortOrder.includes('Desc')) {
                    return dateB - dateA;
                }
                
                if (sortOrder.includes('Asc')) {
                    return dateA - dateB;
                }
                
                return 0;
            });
        }

        function renderNotes(folderId) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '';
            
            let notes = [];
            let folderColor = 'var(--accent)';
            let isTrashView = false;
            
            // --- TRASH VIEW LOGIC ---
            if (folderId === data.TRASH_ID) {
                notes = data.trash;
                folderColor = '#ef4444'; // Use danger color for trash
                isTrashView = true;
                contentArea.innerHTML = `
                    <h2 style="color: var(--danger); margin-bottom: 20px;">üóëÔ∏è Trash / Recycling Bin</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 40px;">Notes here are automatically deleted after 30 days from their deletion date. Use the Restore/Delete Forever buttons below.</p>
                `;
            } else {
                // --- REGULAR FOLDER VIEW LOGIC ---
                const folder = data.folders.find(f => f.id === folderId);
                if (!folder) {
                    contentArea.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div class="empty-text">Folder not found.</div>
                        </div>
                    `;
                    return;
                }
                notes = folder.notes;
                folderColor = folder.color;
            }
            
            // Apply sorting to active folders only
            if (!isTrashView) {
                notes = sortNotes(notes);
            }

            if (notes.length === 0) {
                contentArea.innerHTML += `
                    <div class="empty-state">
                        <div class="empty-icon">${isTrashView ? 'üóëÔ∏è' : '‚ú®'}</div>
                        <div class="empty-text">${isTrashView ? 'Trash is empty.' : 'No notes yet. Create your first note!'}</div>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'notes-grid';

            notes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                
                // MODIFIED: Apply Note Color to Indicator Bar and Special Class
                if (note.noteColor === 'space') {
                    card.classList.add('space-bg');
                    card.style.setProperty('--note-indicator-color', '#3b82f6'); // Bright blue indicator for space theme
                } else if (note.noteColor && note.noteColor !== 'transparent') {
                    // Set the CSS variable for the left color bar
                    card.style.setProperty('--note-indicator-color', note.noteColor);
                    // Ensure space-bg is removed if the color changes away from 'space'
                    card.classList.remove('space-bg'); 
                } else {
                    card.style.setProperty('--note-indicator-color', 'transparent'); 
                    card.classList.remove('space-bg'); 
                }
                // END MODIFIED

                card.innerHTML = `
                    ${note.isBookmarked && !isTrashView ? `<button class="bookmark-btn bookmarked" onclick="event.stopPropagation(); toggleBookmarkInCard(${note.id}, ${folderId})">üåü</button>` : ''}
                    <h3 class="note-title">${note.title || 'Untitled'}</h3>
                    
                    ${note.tags && note.tags.length > 0 ? `
                        <div class="note-tags-display">
                            ${note.tags.map(tag => `<span class="note-tag-display">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <p class="note-preview">${note.content || 'No content'}</p>
                    
                    ${isTrashView ? `
                        <div class="note-meta trash-note-meta">
                            <span>üìÖ Deleted: ${new Date(note.deletedAt).toLocaleDateString()}</span>
                            <button class="btn btn-success" onclick="event.stopPropagation(); restoreNote(${note.id})">‚Ü©Ô∏è Restore</button>
                            <button class="btn" style="background: var(--danger); color: white;" onclick="event.stopPropagation(); permanentlyDeleteNote(${note.id})">‚ùå Delete Forever</button>
                        </div>
                    ` : `
                        <div class="note-meta">
                            <span>üìÖ Updated: ${new Date(note.updatedAt || note.createdAt).toLocaleDateString()}</span>
                            <span class="note-badge" style="background: ${folderColor}1A; color: ${folderColor};">${getNoteBadgeText(note)}</span>
                        </div>
                    `}
                `;
                
                if (isTrashView) {
                    card.onclick = (e) => { e.stopPropagation(); };
                    card.classList.add('trash-card');
                } else {
                    card.onclick = () => openNoteModal(note.id);
                }
                grid.appendChild(card);
            });
            
            contentArea.appendChild(grid);
        }
        
        function hexToRgb(hex) {
            var bigint = parseInt(hex.slice(1), 16);
            var r = (bigint >> 16) & 255;
            var g = (bigint >> 8) & 255;
            var b = bigint & 255;
            return { r: r, g: g, b: b };
        }

        // Quick bookmarking from card view
        function toggleBookmarkInCard(noteId, folderId) {
            const folder = data.folders.find(f => f.id === folderId);
            const note = folder.notes.find(n => n.id === noteId);
            if (note) {
                note.isBookmarked = !note.isBookmarked;
                note.updatedAt = new Date().toISOString();
                saveData();
                renderNotes(folderId);
            }
        }
        
        // --- TRASH MANAGEMENT FUNCTIONS ---
        function deleteNote() {
            if (!data.currentFolder || data.currentNote === null) return;
            
            if (data.currentFolder === data.TRASH_ID) {
                return;
            }

            if (!confirm('Are you sure you want to move this note to Trash?')) return;

            const folder = data.folders.find(f => f.id === data.currentFolder);
            const noteIndex = folder.notes.findIndex(n => n.id === data.currentNote);
            
            if (noteIndex !== -1) {
                const noteToTrash = folder.notes.splice(noteIndex, 1)[0];
                
                noteToTrash.isTrashed = true;
                noteToTrash.deletedAt = new Date().toISOString();
                
                data.trash.push(noteToTrash);
                
                saveData();
                updateTotalNotes();
                
                const indicator = document.createElement('div');
                indicator.className = 'save-indicator';
                indicator.innerHTML = 'üóëÔ∏è Moved to Trash!';
                document.body.appendChild(indicator);
                setTimeout(() => indicator.remove(), 2000);
                
                closeNoteModal();
            }
        }
        
        function restoreNote(noteId) {
            if (!confirm('Restore this note to its original folder?')) return;
            
            const noteIndex = data.trash.findIndex(n => n.id === noteId);
            if (noteIndex === -1) return;
            
            const noteToRestore = data.trash.splice(noteIndex, 1)[0];
            
            // Restore to the first active folder if a default cannot be determined
            const targetFolder = data.folders[0];
            
            if (targetFolder) {
                noteToRestore.isTrashed = false;
                noteToRestore.deletedAt = null;
                noteToRestore.updatedAt = new Date().toISOString();
                
                targetFolder.notes.push(noteToRestore);
                
                saveData();
                updateTotalNotes();
                renderNotes(data.TRASH_ID); 
                renderFolders(); // Update folder count in sidebar
                
                const indicator = document.createElement('div');
                indicator.className = 'save-indicator';
                indicator.style.background = 'var(--accent)';
                indicator.innerHTML = `‚Ü©Ô∏è Restored to ${targetFolder.name}!`;
                document.body.appendChild(indicator);
                setTimeout(() => indicator.remove(), 2000);
            } else {
                alert('Could not find a folder to restore to. Please create a folder first.');
                data.trash.push(noteToRestore);
            }
        }
        
        function permanentlyDeleteNote(noteId) {
            if (!confirm('DANGER: This action cannot be undone. Permanently delete this note?')) return;
            
            const noteIndex = data.trash.findIndex(n => n.id === noteId);
            if (noteIndex !== -1) {
                data.trash.splice(noteIndex, 1);
                saveData();
                renderNotes(data.TRASH_ID);
                renderFolders(); // Update trash count in sidebar
                
                const indicator = document.createElement('div');
                indicator.className = 'save-indicator';
                indicator.style.background = 'var(--danger)';
                indicator.innerHTML = `‚ùå Permanently Deleted!`;
                document.body.appendChild(indicator);
                setTimeout(() => indicator.remove(), 2000);
            }
        }
        
        // --- NOTE MODAL MANAGEMENT ---
        function openNewNote() {
            if (!data.currentFolder || data.currentFolder === data.TRASH_ID) {
                return alert('Please select an active folder first, or create a new one.');
            }
            data.currentNote = null;
            currentBookmark = false;
            drawingData = null;
            selectedNoteColor = 'transparent';
            clipboardContent = '';
            
            // Reset fields
            document.getElementById('modalTitle').textContent = '‚ú® New Note';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteTags').value = ''; 
            document.getElementById('attachmentsGrid').innerHTML = '';
            
            // Hide specific sections for a clean start
            document.getElementById('canvasContainer').style.display = 'none';
            document.getElementById('clipboardSection').style.display = 'none';
            document.getElementById('historyBtn').style.display = 'none'; 
            document.getElementById('noteDeleteBtn').style.display = 'block'; 
            
            // Reset styles and bookmark state
            updateBookmarkButton();
            updateEditorStyle();
            
            // Reset modal background to default and select 'transparent'
            document.querySelectorAll('#noteColorPicker .note-color-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector('#noteColorPicker div[data-color="transparent"]').classList.add('selected');
            document.getElementById('noteModal').querySelector('.modal-content').style.background = 'var(--bg-secondary)';
            document.getElementById('noteModal').querySelector('.modal-content').style.color = 'var(--text-primary)';
            document.querySelectorAll('.section-title').forEach(el => el.style.color = 'var(--text-primary)');

            document.getElementById('noteModal').classList.add('active');
        }

        function openNoteModal(noteId) {
            const folder = data.folders.find(f => f.id === data.currentFolder);
            const note = folder.notes.find(n => n.id === noteId);
            if (!note) return;

            data.currentNote = noteId;

            // Load all note properties
            document.getElementById('modalTitle').textContent = note.title || 'Untitled';
            document.getElementById('noteTitle').value = note.title || '';
            document.getElementById('noteContent').value = note.content || '';
            document.getElementById('fontFamily').value = note.fontFamily || 'Arial';
            document.getElementById('fontSize').value = note.fontSize || '16';
            document.getElementById('noteTags').value = (note.tags || []).join(', ');
            
            selectedNoteColor = note.noteColor || 'transparent';
            
            // MODIFIED: Apply correct theme to modal based on note color
            const modalContent = document.getElementById('noteModal').querySelector('.modal-content');
            if (selectedNoteColor === 'space') {
                modalContent.style.background = '#0D0F16'; 
                modalContent.style.color = '#f5f5f5';
                document.querySelectorAll('.section-title').forEach(el => el.style.color = '#f5f5f5');
            } else {
                modalContent.style.background = 'var(--bg-secondary)'; 
                modalContent.style.color = 'var(--text-primary)';
                document.querySelectorAll('.section-title').forEach(el => el.style.color = 'var(--text-primary)');
            }
            
            // Select the correct color circle
            document.querySelectorAll('#noteColorPicker .note-color-option').forEach(opt => opt.classList.remove('selected'));
            const colorOption = document.querySelector(`#noteColorPicker div[data-color="${selectedNoteColor}"]`);
            if(colorOption) colorOption.classList.add('selected');


            currentBookmark = note.isBookmarked || false;
            drawingData = note.drawing || null;
            
            document.getElementById('historyBtn').style.display = (note.history && note.history.length > 0) ? 'block' : 'none';
            document.getElementById('noteDeleteBtn').style.display = 'block';

            updateBookmarkButton();
            updateEditorStyle();
            
            renderAttachments(note.attachments || []);
            
            // Load canvas state
            document.getElementById('canvasContainer').style.display = drawingData ? 'block' : 'none';
            if (drawingData) {
                setTimeout(() => loadDrawing(drawingData), 50); 
            } else {
                 clearCanvas(false); // Reset canvas on modal open if no drawing data
            }
            
            document.getElementById('clipboardSection').style.display = 'none';
            document.getElementById('noteModal').classList.add('active');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            if (data.currentFolder) {
                renderNotes(data.currentFolder);
            }
            data.currentNote = null;
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value.trim() || 'Untitled Note';
            const content = document.getElementById('noteContent').value.trim();
            const fontFamily = document.getElementById('fontFamily').value;
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const tags = document.getElementById('noteTags').value.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            
            const folder = data.folders.find(f => f.id === data.currentFolder);
            if (!folder) {
                alert('No active folder selected!');
                return;
            }
            
            let currentNoteData = {
                title, 
                content, 
                fontFamily, 
                fontSize, 
                drawing: drawingData, 
                isBookmarked: currentBookmark,
                noteColor: selectedNoteColor,
                tags: tags,
                updatedAt: new Date().toISOString()
            };

            if (data.currentNote === null) {
                // New note
                currentNoteData.id = data.nextNoteId++;
                currentNoteData.createdAt = currentNoteData.updatedAt;
                currentNoteData.history = [];
                currentNoteData.attachments = [];
                folder.notes.push(currentNoteData);
            } else {
                // Edit existing note
                const noteIndex = folder.notes.findIndex(n => n.id === data.currentNote);
                if (noteIndex !== -1) {
                    const existingNote = folder.notes[noteIndex];
                    
                    // Save old version to history if content changed
                    if (existingNote.content !== content) {
                        const historyEntry = {
                            content: existingNote.content,
                            date: existingNote.updatedAt
                        };
                        
                        existingNote.history = existingNote.history || [];
                        // Limit history size to prevent excessive storage use (e.g., last 20 versions)
                        if (existingNote.history.length >= 20) {
                            existingNote.history.shift(); 
                        }
                        existingNote.history.push(historyEntry);
                    }
                    
                    // Preserve attachments and history when spreading
                    folder.notes[noteIndex] = { 
                        ...existingNote, 
                        ...currentNoteData,
                        attachments: existingNote.attachments || [],
                        history: existingNote.history || []
                    };
                }
            }

            saveData();
            updateTotalNotes();

            const saveIndicator = document.createElement('div');
            saveIndicator.className = 'save-indicator';
            saveIndicator.innerHTML = '‚úÖ Note Saved!';
            document.body.appendChild(saveIndicator);
            setTimeout(() => saveIndicator.remove(), 1500);

            closeNoteModal();
        }
        
        function updateEditorStyle() {
            const editor = document.getElementById('noteContent');
            editor.style.fontFamily = document.getElementById('fontFamily').value;
            editor.style.fontSize = document.getElementById('fontSize').value + 'px';
        }

        // --- NEW: HISTORY MODAL FUNCTIONS ---
        function openHistoryModal() {
            const folder = data.folders.find(f => f.id === data.currentFolder);
            const note = folder.notes.find(n => n.id === data.currentNote);
            if (!note || !note.history || note.history.length === 0) {
                alert('No version history found for this note.');
                return;
            }
            
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const sortedHistory = note.history.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedHistory.forEach((version, index) => {
                const item = document.createElement('li');
                item.className = 'history-item';
                
                const preview = version.content.substring(0, 50) + (version.content.length > 50 ? '...' : '');
                
                item.innerHTML = `
                    <div class="history-item-meta">
                        <strong>Version ${sortedHistory.length - index}</strong> 
                        <span style="display: block; font-size: 12px;">Saved: ${new Date(version.date).toLocaleString()}</span>
                        <span style="font-style: italic;">Preview: "${preview}"</span>
                    </div>
                    <button class="btn btn-warning" onclick="restoreVersion('${version.date}')">Restore</button>
                `;
                historyList.appendChild(item);
            });
            
            document.getElementById('historyModal').classList.add('active');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        function restoreVersion(versionDate) {
            if (!confirm('Are you sure you want to restore this version? The current content will be saved to history before restoration.')) return;
            
            const folder = data.folders.find(f => f.id === data.currentFolder);
            const note = folder.notes.find(n => n.id === data.currentNote);
            
            const versionToRestore = note.history.find(v => v.date === versionDate);
            
            if (versionToRestore) {
                // 1. Save current content to history first
                const currentContent = document.getElementById('noteContent').value.trim();
                const currentHistoryEntry = {
                    content: currentContent,
                    date: new Date().toISOString()
                };
                note.history.push(currentHistoryEntry);
                
                // 2. Overwrite editor content with restored version
                document.getElementById('noteContent').value = versionToRestore.content;
                
                // 3. Update the note in memory (only content field)
                note.content = versionToRestore.content;
                
                saveData();
                closeHistoryModal();
                
                const indicator = document.createElement('div');
                indicator.className = 'save-indicator';
                indicator.style.background = 'var(--warning)';
                indicator.innerHTML = `üîÑ Restored! Click 'Save Note' to finalize.`;
                document.body.appendChild(indicator);
                setTimeout(() => indicator.remove(), 2500);
            } else {
                alert('Version not found.');
            }
        }
        
        // --- RESTORED: ATTACHMENTS ---
        function getAttachmentIcon(type) {
            if (type.startsWith('image')) return 'üñºÔ∏è';
            if (type.startsWith('audio')) return 'üéµ';
            if (type.startsWith('video')) return 'üé¨';
            if (type.includes('pdf')) return 'üìÑ';
            if (type.includes('zip') || type.includes('rar')) return 'üì¶';
            if (type.includes('text') || type.includes('document')) return 'üìù';
            return 'üìé';
        }

        function renderAttachments(attachments) {
            const grid = document.getElementById('attachmentsGrid');
            grid.innerHTML = attachments.map((att, index) => `
                <div class="attachment-item" onclick="viewAttachment('${att.dataUrl}', '${att.name}', '${att.type}')" data-type="${att.type}" data-name="${att.name}" data-dataurl="${att.dataUrl}">
                    <div class="attachment-icon">${getAttachmentIcon(att.type)}</div>
                    <div class="attachment-name">${att.name}</div>
                    <button class="close-btn" style="position: absolute; top: 0; right: 0; transform: scale(0.6); background: var(--danger); color: white; border: none;" onclick="event.stopPropagation(); deleteAttachment(${index})">√ó</button>
                </div>
            `).join('');
        }

        function addFileToNote(files) {
            const folder = data.folders.find(f => f.id === data.currentFolder);
            const note = folder.notes.find(n => n.id === data.currentNote);
            
            if (!note) {
                alert('Please save the note first or open an existing one before adding attachments.');
                return;
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Initialize attachments array if it doesn't exist
                    note.attachments = note.attachments || []; 
                    note.attachments.push({ name: file.name, type: file.type, dataUrl: e.target.result });
                    renderAttachments(note.attachments);
                    saveData();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function addImage() {
            const files = document.getElementById('imageUpload').files;
            if (files.length) addFileToNote(files);
        }
        
        function addFile() {
            const files = document.getElementById('fileUpload').files;
            if (files.length) addFileToNote(files);
        }

        function deleteAttachment(index) {
            if (!confirm('Are you sure you want to delete this attachment?')) return;
            const folder = data.folders.find(f => f.id === data.currentFolder);
            const note = folder.notes.find(n => n.id === data.currentNote);
            if (note && note.attachments) {
                note.attachments.splice(index, 1);
                renderAttachments(note.attachments);
                saveData();
            }
        }

        function viewAttachment(dataUrl, name, type) {
            if (type.startsWith('image')) {
                const newWindow = window.open();
                newWindow.document.write(`<img src="${dataUrl}" alt="${name}" style="max-width: 100%; display: block; margin: 20px;">`);
            } else { 
                // For other files, download them (simulating a download)
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // --- RESTORED: DRAWING CANVAS ---
        function setupCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            // Set initial dimensions based on CSS size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile compatibility
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
        }

        function toggleDrawing() {
            const container = document.getElementById('canvasContainer');
            if (container.style.display === 'block') {
                container.style.display = 'none';
                drawingData = canvas.toDataURL(); // Save drawing when closing canvas UI
            } else {
                container.style.display = 'block';
                // Reset canvas size before loading to ensure correct dimensions
                canvas.width = canvas.offsetWidth;
                canvas.height = 400; 
                loadDrawing(drawingData);
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.moveTo(x, y);
            
            ctx.strokeStyle = document.getElementById('drawColor').value;
            ctx.lineWidth = document.getElementById('drawSize').value;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function stopDrawing() {
            isDrawing = false;
        }
        
        function clearCanvas(confirmPrompt = true) {
            if (confirmPrompt && !confirm('Are you sure you want to clear the drawing?')) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingData = null;
            document.getElementById('drawingStatus').textContent = 'Cleared!';
            setTimeout(() => document.getElementById('drawingStatus').textContent = '', 1000);
        }
        
        function saveDrawing() {
            // This is just a temporary save to the current session variable
            drawingData = canvas.toDataURL();
            document.getElementById('drawingStatus').textContent = 'Drawing Saved to Note!';
            setTimeout(() => document.getElementById('drawingStatus').textContent = '', 1500);
            // Actual save to localStorage happens in saveNote()
        }

        function loadDrawing(dataUrl) {
            // Reload the drawing onto the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (dataUrl) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = dataUrl;
                document.getElementById('drawingStatus').textContent = 'Drawing Loaded!';
            } else {
                document.getElementById('drawingStatus').textContent = 'New Drawing.';
            }
            setTimeout(() => document.getElementById('drawingStatus').textContent = '', 1000);
        }


        // --- BOOKMARKS ---
        function toggleBookmark() {
            currentBookmark = !currentBookmark;
            updateBookmarkButton();
        }

        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            if (currentBookmark) {
                btn.classList.add('bookmarked');
                btn.innerHTML = 'üåü Bookmarked';
            } else {
                btn.classList.remove('bookmarked');
                btn.innerHTML = '‚≠ê Bookmark';
            }
        }

        // --- SEARCH ---
        function searchNotes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '';
            
            let allNotes = [];
            
            // Collect all notes from all ACTIVE folders (excluding trash)
            data.folders.forEach(folder => {
                folder.notes.forEach(note => {
                    allNotes.push({ 
                        ...note, 
                        folderColor: folder.color,
                        folderId: folder.id, // Store folder ID for opening
                        folderName: folder.name
                    });
                });
            });

            const filteredNotes = allNotes.filter(note => 
                (note.title && note.title.toLowerCase().includes(searchTerm)) || 
                (note.content && note.content.toLowerCase().includes(searchTerm)) ||
                (note.tags && note.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
            );
            
            // If search is empty, go back to the current folder view
            if (searchTerm === '') {
                if (data.currentFolder) {
                    renderNotes(data.currentFolder);
                } else {
                    // If no folder is selected and search is empty, show empty state
                    contentArea.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìù</div>
                            <div class="empty-text">Select a folder or create a new note</div>
                        </div>
                    `;
                }
                return;
            }

            // Render search results
            const grid = document.createElement('div');
            grid.className = 'notes-grid';

            filteredNotes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                
                // MODIFIED: Apply Note Color logic for search results
                if (note.noteColor === 'space') {
                    card.classList.add('space-bg');
                    card.style.setProperty('--note-indicator-color', '#3b82f6');
                } else if (note.noteColor && note.noteColor !== 'transparent') {
                    card.style.setProperty('--note-indicator-color', note.noteColor);
                } else {
                    card.style.setProperty('--note-indicator-color', 'transparent'); 
                }
                // END MODIFIED
                
                card.innerHTML = `
                    ${note.isBookmarked ? `<button class="bookmark-btn bookmarked" onclick="event.stopPropagation(); toggleBookmarkInCard(${note.id}, ${note.folderId})">üåü</button>` : ''}
                    <h3 class="note-title">${note.title}</h3>
                    
                    ${note.tags && note.tags.length > 0 ? `
                        <div class="note-tags-display">
                            ${note.tags.map(tag => `<span class="note-tag-display">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <p class="note-preview">${note.content.substring(0, 100)}...</p>
                    <div class="note-meta">
                        <span>üìÅ ${note.folderName}</span>
                        <span class="note-badge" style="background: ${note.folderColor}1A; color: ${note.folderColor};">${getNoteBadgeText(note)}</span>
                    </div>
                `;
                card.onclick = () => {
                    selectFolder(note.folderId); // Select the folder
                    openNoteModal(note.id); // Open the note
                };
                grid.appendChild(card);
            });
            
            if (filteredNotes.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-text">No notes found matching "${searchTerm}"</div>
                    </div>
                `;
                return;
            }
            
            contentArea.appendChild(grid);
        }
        
        // --- WHY US MODAL ---
        function openWhyUsModal() {
            document.getElementById('whyUsModal').classList.add('active');
        }

        function closeWhyUsModal() {
            document.getElementById('whyUsModal').classList.remove('active');
        }

        // --- App Lifetime ---
        init();
        
        // Timer to check auto-delete every hour (60 minutes)
        setInterval(checkAutoDelete, 60 * 60 * 1000); 
    </script>
</body>
</html>

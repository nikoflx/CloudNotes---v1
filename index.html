<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes v1 (Local Multitool)</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f0f5;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-hover: rgba(99, 102, 241, 0.2);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #262626;
            --text-primary: #f5f5f5;
            --text-secondary: #9ca3af;
            --accent: #818cf8;
            --accent-hover: #6366f1;
            --accent-light: rgba(129, 140, 248, 0.15);
            --border: #2d2d2d;
            --shadow: rgba(0, 0, 0, 0.4);
            --shadow-hover: rgba(129, 140, 248, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 10px var(--shadow);
        }

        .sidebar-header {
            padding: 30px 24px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent-light), transparent);
        }

        .app-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .app-author {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 15px; 
        }
        
        /* General Button Style */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            padding: 10px 14px;
            font-size: 18px;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #cc3333;
        }

        /* Sidebar Header Buttons */
        .sidebar-header-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .why-us-btn {
            display: block;
            width: 100%;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--accent);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--accent);
            box-shadow: 0 2px 8px var(--shadow-hover);
            text-align: center;
        }

        .why-us-btn:hover {
            background: var(--accent);
            color: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .why-us-btn:active {
            transform: translateY(0);
        }
        
        /* Toolbar (Folder Management) */
        .toolbar {
            padding: 20px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        /* NEW: Data Management Toolbar */
        .data-toolbar {
            padding: 10px 20px 20px;
            display: flex;
            gap: 10px;
            border-top: 1px solid var(--border);
            background: var(--bg-tertiary);
        }

        /* Folders Container */
        .folders-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .folders-container::-webkit-scrollbar {
            width: 6px;
        }

        .folders-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .folder-item {
            padding: 14px 18px;
            margin: 6px 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 2px solid transparent;
        }

        .folder-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(6px);
            border-color: var(--accent-light);
        }

        .folder-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateX(6px);
        }

        .folder-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .folder-item:hover .folder-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .folder-name {
            flex: 1;
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .folder-count {
            font-size: 13px;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .delete-folder-btn {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 18px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s, transform 0.2s;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 5px;
            line-height: 1;
        }

        .folder-item.active .delete-folder-btn {
            color: white;
            opacity: 0.8;
        }
        
        .delete-folder-btn:hover {
            opacity: 1;
            transform: translateY(-50%) scale(1.1);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            padding: 20px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .search-bar {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-secondary);
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-toggle {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--accent);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: var(--bg-primary);
        }

        .content-area::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .note-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
            animation: fadeIn 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .note-card:hover::before {
            transform: scaleX(1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .note-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px var(--shadow);
            border-color: var(--accent);
        }

        .note-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .note-preview {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        /* New styling for contenteditable rich text preview */
        .note-preview > * {
            margin: 0; /* Remove internal margins for compact preview */
            padding: 0;
            line-height: 1.5;
        }

        .note-meta {
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-badge {
            background: var(--accent-light);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--accent-light);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--danger);
            border-color: var(--danger);
            transform: scale(1.1) rotate(90deg);
        }

        .modal-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
        
        /* Why Us Section Styles */
        .why-us-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }

        .why-us-card {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
            transition: transform 0.3s;
        }

        .why-us-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .why-us-card h4 {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .why-us-card p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        /* End Why Us Section Styles */

        /* UPGRADE/PRICING STYLES */
        .upgrade-pricing {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 40px;
            margin-bottom: 40px;
        }
        
        .price-card {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 16px;
            border: 3px solid var(--border);
            text-align: center;
            max-width: 350px;
            position: relative;
            transition: all 0.3s;
        }

        .price-card.annual {
            border-color: var(--warning);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.2);
            transform: scale(1.05);
        }

        .save-badge {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .plan-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .plan-price {
            font-size: 48px;
            font-weight: 900;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .plan-duration {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .plan-details {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .buy-btn {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.3s;
        }

        .buy-btn:hover {
            background: var(--accent-hover);
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            margin-top: 30px;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .comparison-table th, .comparison-table td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }

        .comparison-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 700;
            font-size: 16px;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .free-feature {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .pro-feature {
            color: var(--success);
            font-weight: 600;
        }
        
        .no-feature {
            color: var(--danger);
            font-weight: 500;
            opacity: 0.7;
        }
        
        /* End UPGRADE/PRICING STYLES */


        .editor-toolbar {
            display: flex;
            gap: 12px;
            padding: 18px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            border: 2px solid var(--border);
        }

        .editor-toolbar select,
        .editor-toolbar input[type="number"] {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .editor-toolbar select:focus,
        .editor-toolbar input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .editor-toolbar button {
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .editor-toolbar button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        /* Specific Button Overrides for Delete */
        .editor-toolbar .btn-danger:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            transform: translateY(-2px);
        }

        /* Rich Text button styles */
        .editor-toolbar .rich-text-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .editor-toolbar .rich-text-btn:hover {
            color: white;
        }


        .note-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: 20px;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* NEW: Content Editable DIV for Rich Text */
        .note-editor {
            width: 100%;
            min-height: 350px;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.7;
            font-family: inherit;
            transition: all 0.3s ease;
            white-space: pre-wrap; /* Essential for preserving formatting */
            overflow-y: auto;
        }

        .note-editor:focus,
        .note-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }
        
        /* Canvas Styles */
        .canvas-container {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-primary);
            border: 2px dashed var(--accent);
            border-radius: 12px;
            text-align: center;
        }

        #drawingCanvas {
            border: 1px solid var(--border);
            background: white;
            display: block;
            margin: 0 auto 15px;
            cursor: crosshair;
        }

        .canvas-toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .canvas-toolbar input[type="color"],
        .canvas-toolbar input[type="range"] {
            margin: 0 5px;
        }

        /* Clipboard Styles */
        .clipboard-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid var(--warning);
            border-radius: 12px;
            background: var(--accent-light);
        }

        .clipboard-preview {
            max-height: 150px;
            overflow: auto;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        /* Attachment Styles */
        .attachments-section {
            margin-top: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .attachments-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .attachment-item {
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-tertiary);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            position: relative;
        }

        .attachment-icon {
            font-size: 20px;
        }

        .attachment-name {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-attachment-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .delete-attachment-btn:hover {
            transform: scale(1.2);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            border: 2px dashed var(--border);
            border-radius: 16px;
            margin-top: 100px;
            opacity: 0.7;
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .empty-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Folder Modal Color Picker */
        .color-picker-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-option.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 4px var(--accent);
        }
        
    </style>
</head>
<body data-theme="light">
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title" data-i18n="appTitle">CloudNotes v1</div>
                <div class="app-author" data-i18n="appAuthor">by Niko - Local Multitool</div>
                
                <div style="margin-bottom: 15px;">
                    <label for="langSelect" style="font-size: 13px; color: var(--text-secondary); font-weight: 500;">Language:</label>
                    <select id="langSelect" onchange="switchLanguage(this.value)" style="padding: 5px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                        <option value="en">English</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    </select>
                </div>
                <div class="sidebar-header-buttons">
                    <button class="why-us-btn" data-i18n="whyUsBtn" onclick="openWhyUsModal()">Why Us? (It's Local!)</button>
                    <button class="why-us-btn" style="border-color: var(--warning); color: var(--warning);" data-i18n="upgradeBtn" onclick="openUpgradeModal()">‚ú® Upgrade to Pro</button>
                </div>
            </div>
            
            <div class="toolbar">
                <button class="btn" data-i18n="folderBtn" onclick="createFolder()">+ Folder</button>
                <button class="btn btn-icon" data-i18n="newNoteIcon" onclick="openNewNote()">üìù</button>
            </div>

            <div class="folders-container" id="foldersContainer">
                </div>
            
            <div class="data-toolbar">
                <button class="btn" data-i18n="exportBtn" onclick="exportData()">‚¨áÔ∏è Export</button>
                <button class="btn" data-i18n="importBtn" onclick="document.getElementById('fileImport').click()">‚¨ÜÔ∏è Import</button>
                <input type="file" id="fileImport" accept=".json" onchange="importData(event)" style="display: none;">
                <button class="btn btn-icon" style="background: #10b981; color: white;" onclick="generateQRCode()">üì≤</button>
            </div>
            </div>

        <div class="main-content">
            <div class="topbar">
                <div class="search-bar">
                    <input type="text" data-i18n="searchPlaceholder" placeholder="Search notes..." id="searchInput" oninput="searchNotes()">
                    <span class="search-icon">üîç</span>
                </div>
                <div class="topbar-actions">
                    <div class="stat-item">
                        <span class="stat-value" id="totalNotes">0</span>
                        <div class="stat-label" id="totalNotesLabel" data-i18n="totalNotesLabel">Total Notes</div>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
                </div>
            </div>

            <div class="content-area" id="contentArea">
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-text" data-i18n="emptySelectFolder">Select a folder or create a new note</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle" data-i18n="newNoteTitle">New Note</div>
                <button class="close-btn" onclick="closeNoteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="noteTitle" data-i18n="noteTitlePlaceholder" placeholder="‚ú® Note title...">
                
                <div class="editor-toolbar">
                    <select id="fontFamily" onchange="updateEditorStyle()">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Comic Sans MS">Comic Sans MS</option>
                        <option value="Brush Script MT">Brush Script</option>
                        <option value="Trebuchet MS">Trebuchet</option>
                    </select>
                    
                    <input type="number" id="fontSize" value="16" min="10" max="48" onchange="updateEditorStyle()" placeholder="Size">
                    
                    <button class="rich-text-btn" onclick="applyFormat('bold')">**B**</button>
                    <button class="rich-text-btn" onclick="applyFormat('italic')">_I_</button>
                    <button class="rich-text-btn" onclick="applyFormat('underline')">UÃ≤</button>
                    
                    <button onclick="toggleDrawing()" data-i18n="drawBtn">üé® Draw</button>
                    <button onclick="document.getElementById('imageUpload').click()" data-i18n="imageBtn">üñºÔ∏è Image</button>
                    <button onclick="document.getElementById('fileUpload').click()" data-i18n="fileBtn">üìé File</button>
                    
                    <button onclick="insertTimestamp()" data-i18n="timestampBtn">‚è∞ Stamp</button>
                    
                    <button onclick="pasteFromClipboard()" class="btn-warning" data-i18n="pasteClipboardBtn">üìã Paste Clipboard</button>
                    <button onclick="toggleBookmark()" id="bookmarkBtn" data-i18n="bookmarkBtn">‚≠ê Bookmark</button>
                    
                    <button onclick="deleteNote()" class="btn btn-danger" id="deleteNoteBtn" data-i18n="deleteNoteBtn" style="display: none;">üóëÔ∏è Delete Note</button>
                    <button onclick="saveNote()" class="btn btn-success" data-i18n="saveNoteBtn">üíæ Save Note</button>
                </div>

                <div class="note-editor" id="noteContent" data-i18n="noteContentPlaceholder" placeholder="‚úçÔ∏è Start writing your amazing ideas..." contenteditable="true"></div>

                <div class="canvas-container" id="canvasContainer" style="display: none;">
                    <canvas id="drawingCanvas"></canvas>
                    <div class="canvas-toolbar">
                        <button onclick="clearCanvas()" style="background: var(--danger); color: white;" data-i18n="clearCanvasBtn">üóëÔ∏è Clear</button>
                        <button onclick="saveDrawing()" class="btn-success" style="background: var(--success); color: white;" data-i18n="saveDrawingBtn">üíæ Save Drawing</button>
                        <input type="color" id="drawColor" value="#6366f1">
                        <label style="color: var(--text-secondary); font-size: 13px; font-weight: 600;" data-i18n="brushSizeLabel">Brush Size:</label>
                        <input type="range" id="drawSize" min="1" max="30" value="3">
                        <span id="drawingStatus"></span>
                    </div>
                </div>

                <div class="clipboard-section" id="clipboardSection" style="display: none;">
                    <h3 class="section-title" data-i18n="clipboardTitle">üìã Clipboard Content</h3>
                    <div class="clipboard-preview" id="clipboardPreview"></div>
                    <button class="btn" style="margin-top: 12px;" onclick="insertClipboard()" data-i18n="insertClipboardBtn">‚ú® Insert into Note</button>
                </div>

                <div class="attachments-section">
                    <h3 class="section-title" data-i18n="attachmentsTitle">üìé Attachments</h3>
                    <div class="attachments-grid" id="attachmentsGrid"></div>
                </div>

                <input type="file" id="imageUpload" accept="image/*" onchange="addImage()" multiple style="display: none;">
                <input type="file" id="fileUpload" onchange="addFile()" multiple style="display: none;">
            </div>
        </div>
    </div>

    <div class="modal" id="folderModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title" id="folderModalTitle" data-i18n="newFolderTitle">‚ú® New Folder</div>
                <button class="close-btn" onclick="closeFolderModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="folderName" data-i18n="folderNamePlaceholder" placeholder="üìÅ Folder name...">
                
                <h3 class="section-title" data-i18n="colorTitle">üé® Choose Icon Color</h3>
                <div class="color-picker-container">
                    <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #84cc16;" data-color="#84cc16" onclick="selectColor(this)"></div>
                </div>
                
                <button class="btn btn-danger" id="deleteFolderModalBtn" style="margin-top: 28px; width: 100%; display: none;" onclick="deleteFolder()">‚ùå Delete Folder and Notes</button>
                <button class="btn" id="saveFolderModalBtn" style="margin-top: 12px; width: 100%;" onclick="saveFolderModal()" data-i18n="createFolderBtn">‚ú® Create Folder</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="whyUsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title" data-i18n="whyUsModalTitle">üåü Why Choose CloudNotes v1?</div>
                <button class="close-btn" onclick="closeWhyUsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <h2 style="font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 20px; color: var(--accent);" data-i18n="whyUsSubtitle">Your Data. Your Control. Always.</h2>
                <p style="font-size: 16px; text-align: center; color: var(--text-secondary);" data-i18n="whyUsTagline">We built CloudNotes v1 on a simple principle: **ultimate privacy and simplicity**.</p>
                <div class="why-us-section">
                    
                    <div class="why-us-card">
                        <h4 data-i18n="privacyHeader">üîí Absolute Privacy (No Cloud!)</h4>
                        <p data-i18n="privacyBody">We **don't track, collect, or sell any of your data**. Everything you write or draw stays **private** on your device's local storage. This is a local-first application. Big companies (Giants) **sell storage and integration. (your data too!)**. **We (CloudeNotes) sell privacy, simplity, and vibe.** Our prices are avalaible for **Everyone**</p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="noAccountsHeader">üö´ Zero Accounts</h4>
                        <p data-i18n="noAccountsBody">No need for email, usernames, or passwords. **No sign-ups**, no log-ins, and no cloud storage required. Just open the app and start noting.</p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="fastHeader">‚ö°Ô∏è Fast & Reliable</h4>
                        <p data-i18n="fastBody">Since your notes are stored **locally** on your browser, loading is instantaneous. You're never dependent on a network connection or server status.</p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="editorHeader">üìù Feature-Rich Editor</h4>
                        <p data-i18n="editorBody">Our editor includes **rich text options**, a full **drawing canvas**, and the ability to add **attachments**, all while keeping your data private and local.</p>
                    </div>

                </div>
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="font-size: 14px; color: var(--text-primary); font-weight: 600;" data-i18n="whyUsFooter">CloudNotes v1: Simple, powerful, and truly private note-taking.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="upgradeModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <div class="modal-title" data-i18n="upgradeModalTitle">üöÄ Upgrade to CloudNotes Pro</div>
                <button class="close-btn" onclick="closeUpgradeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <h2 style="font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 20px; color: var(--accent);" data-i18n="upgradeSubtitle">Get the Full CloudNotes v1 Experience!</h2>
                <p style="font-size: 16px; text-align: center; color: var(--text-secondary);" data-i18n="upgradeTagline">Unlock Pro features while maintaining **ultimate privacy and simplicity**.</p>
                <div class="why-us-section">
                    
                    <div class="why-us-card">
                        <h4 data-i18n="privacyHeader">üîí Absolute Privacy (No Cloud!)</h4>
                        <p data-i18n="privacyBody">We **don't track, collect, or sell any of your data**. Everything you write or draw stays **private** on your device's local storage. This is a local-first application. Big companies (Giants) **sell storage and integration. (your data too!)**. **We (CloudeNotes) sell privacy, simplity, and vibe.** Our prices are avalaible for **Everyone**</p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="noAccountsHeader">üö´ Zero Accounts</h4>
                        <p data-i18n="noAccountsBody">No need for email, usernames, or passwords. **No sign-ups**, no log-ins, and no cloud storage required. Just open the app and start noting.</p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="fastHeader">‚ö°Ô∏è Fast & Reliable</h4>
                        <p data-i18n="fastBody">Since your notes are stored **locally** on your browser, loading is instantaneous. You're never dependent on a network connection or server status.</p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="editorHeader">üìù Feature-Rich Editor</h4>
                        <p data-i18n="editorBody">Our editor includes **rich text options**, a full **drawing canvas**, and the ability to add **attachments**, all while keeping your data private and local.</p>
                    </div>
                </div>

                <h2 style="font-size: 28px; font-weight: 800; text-align: center; margin-top: 60px; margin-bottom: 30px; color: var(--accent);" data-i18n="pricingTitle">Simple & Affordable Pricing</h2>
                <div class="upgrade-pricing">
                    <div class="price-card">
                        <div class="plan-title" data-i18n="proMonthlyTitle">Pro Monthly</div>
                        <div class="plan-price" data-i18n="proMonthlyPrice">$3.49</div>
                        <div class="plan-duration" data-i18n="proMonthlyDuration">per month</div>
                        <div class="plan-details" data-i18n="proMonthlyCancel">*cancel anytime</div>
                        <button class="buy-btn" data-i18n="chooseMonthlyBtn" onclick="alert('Proceed to checkout for Monthly Plan')">Choose Monthly</button>
                    </div>
                    
                    <div class="price-card annual">
                        <div class="plan-title" data-i18n="proAnnualTitle">Pro Annual</div>
                        <div class="save-badge" data-i18n="saveBadge">üî• Save 59%</div>
                        <div class="plan-price" data-i18n="proAnnualPrice">$24.99</div>
                        <div class="plan-duration" data-i18n="proAnnualDuration">per year (Billed Annually)</div>
                        <div class="plan-details" data-i18n="proMonthlyCancel">*cancel anytime</div>
                        <button class="buy-btn" style="background: var(--warning); color: var(--text-primary);" data-i18n="chooseAnnualBtn" onclick="alert('Proceed to checkout for Annual Plan')">Choose Annual</button>
                    </div>
                </div>

                <h2 style="font-size: 24px; font-weight: 700; text-align: center; margin-top: 40px; margin-bottom: 20px; color: var(--text-primary);" data-i18n="comparisonTitle">Free vs. Pro Comparison</h2>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th data-i18n="featureCol">Feature</th>
                            <th data-i18n="freePlanCol">Free Plan</th>
                            <th data-i18n="proPlanCol">Pro Plan</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td data-i18n="maxFolders">Maximum Folders</td>
                            <td class="free-feature" data-i18n="freeFolders">Up to 5 folders</td>
                            <td class="pro-feature" data-i18n="proFolders">Up to 25 folders</td>
                        </tr>
                        <tr>
                            <td data-i18n="maxNotes">Maximum Notes per Folder</td>
                            <td class="free-feature" data-i18n="freeNotes">5 notes max</td>
                            <td class="pro-feature" data-i18n="proNotes">100 notes max</td>
                        </tr>
                        <tr>
                            <td data-i18n="geminiRequests">Gemini AI Requests (per week)</td>
                            <td class="free-feature" data-i18n="freeGemini">3 requests</td>
                            <td class="pro-feature" data-i18n="proGemini">Up to 100 requests</td>
                        </tr>
                        <tr>
                            <td data-i18n="customIcons">Custom Icons</td>
                            <td class="no-feature" data-i18n="freeIcons">No custom icons</td>
                            <td class="pro-feature" data-i18n="proIcons">‚úÖ Custom Icons</td>
                        </tr>
                        <tr>
                            <td data-i18n="customBackgrounds">Custom Backgrounds</td>
                            <td class="no-feature" data-i18n="freeBackgrounds">No custom backgrounds</td>
                            <td class="pro-feature" data-i18n="proBackgrounds">‚úÖ Custom Backgrounds</td>
                        </tr>
                        <tr>
                            <td data-i18n="fileSupport">File Support (.wav, .zip, etc.)</td>
                            <td class="no-feature" data-i18n="freeFiles">No .waw files supported</td>
                            <td class="pro-feature" data-i18n="proFiles">‚úÖ Almost all type of files are supported</td>
                        </tr>
                    </tbody>
                </table>

                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="font-size: 14px; color: var(--text-primary); font-weight: 600;" data-i18n="upgradeFooter">Upgrade to Pro and make CloudNotes v1 truly unlimited.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="qrModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="justify-content: center;">
                <div class="modal-title">üì± Quick QR Data Transfer</div>
                <button class="close-btn" onclick="closeQrModal()" style="position: absolute; right: 20px;">√ó</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 20px; color: var(--danger); font-weight: 600;">‚ö†Ô∏è Data size is limited. Use the Export/Import file method for safety.</p>

                <h3 style="color: var(--accent); margin-bottom: 10px;">To Send Data (Source Device):</h3>
                <div id="qrcodeContainer" style="padding: 10px; border: 2px solid var(--border); display: inline-block; margin-bottom: 20px;">
                    </div>
                <p style="margin-top: 5px; color: var(--text-secondary); font-size: 14px;">Display this QR code for scanning.</p>
                
                <h3 style="color: var(--accent); margin-top: 30px; margin-bottom: 10px;">To Receive Data (Target Device):</h3>
                <textarea id="qrDataInput" placeholder="Paste the scanned QR Code text here..." style="width: 100%; min-height: 100px; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: monospace;"></textarea>
                <button class="btn btn-success" onclick="importDataFromQr()" style="width: 100%;">Import Scanned Data</button>

            </div>
        </div>
    </div>
    <script>
        // --- START INTERNATIONALIZATION (I18N) ---
        const TRANSLATIONS = {
            'en': {
                // Sidebar & Toolbar
                'appTitle': 'CloudNotes v1',
                'appAuthor': 'by Niko - Local Multitool',
                'whyUsBtn': 'Why Us? (It\'s Local!)',
                'upgradeBtn': '‚ú® Upgrade to Pro',
                'folderBtn': '+ Folder',
                'newNoteIcon': 'üìù',
                'totalNotesLabel': 'Total Notes',
                'searchPlaceholder': 'Search notes...',
                'exportBtn': '‚¨áÔ∏è Export',
                'importBtn': '‚¨ÜÔ∏è Import',
                
                // Notes & Editor
                'emptySelectFolder': 'Select a folder or create a new note',
                'newNoteTitle': 'New Note',
                'noteTitlePlaceholder': '‚ú® Note title...',
                'noteContentPlaceholder': '‚úçÔ∏è Start writing your amazing ideas...',
                'drawBtn': 'üé® Draw',
                'imageBtn': 'üñºÔ∏è Image',
                'fileBtn': 'üìé File',
                'pasteClipboardBtn': 'üìã Paste Clipboard',
                'timestampBtn': '‚è∞ Stamp', // NEW
                'bookmarkBtn': '‚≠ê Bookmark',
                'bookmarkedBtn': 'üåü Bookmarked',
                'saveNoteBtn': 'üíæ Save Note',
                'deleteNoteBtn': 'üóëÔ∏è Delete Note',
                'clearCanvasBtn': 'üóëÔ∏è Clear',
                'saveDrawingBtn': 'üíæ Save Drawing',
                'drawingStatusReady': 'Ready',
                'drawingStatusDrawing': 'Drawing...',
                'drawingStatusLoaded': 'Drawing loaded.',
                'drawingStatusSaved': 'Drawing saved!',
                'clipboardTitle': 'üìã Clipboard Content',
                'insertClipboardBtn': '‚ú® Insert into Note',
                'attachmentsTitle': 'üìé Attachments',
                'noteBadge': 'Note',
                'bookmarkedBadge': '‚≠ê Bookmarked',
                'saveIndicator': '‚úÖ Saved!',
                'noteNotFound': 'Folder not found.',
                'noNotesYet': 'No notes yet. Create your first note!',
                'searchEmpty': 'No notes found matching ',
                'alertFolderEmpty': 'Folder name cannot be empty!',
                'alertNoFolderSelected': 'No folder selected!',
                'alertTitleEmpty': 'Title cannot be empty!',
                'alertClipboardEmpty': 'Clipboard is empty! ',
                'alertClipboardError': 'Could not access clipboard. Please make sure you granted permission.',
                'alertDeleteConfirm': 'Are you sure you want to delete this attachment?',
                'alertSelectFolder': 'Please select a folder first or create a new one!',
                'brushSizeLabel': 'Brush Size:',
                'alertDeleteNoteConfirm': 'Are you sure you want to delete this note? This action is permanent.',
                'alertDeleteFolderConfirm': 'WARNING: Are you sure you want to delete this folder and ALL its notes? This action is permanent.',
                'alertImportSuccess': 'Data successfully imported and loaded!',
                'alertImportFail': 'Failed to import data. Check file format.',
                'alertExportSuccess': 'Data exported successfully!',
                
                // Folder Modal
                'newFolderTitle': '‚ú® New Folder',
                'folderNamePlaceholder': 'üìÅ Folder name...',
                'colorTitle': 'üé® Choose Icon Color',
                'createFolderBtn': '‚ú® Create Folder',
                'deleteFolderModalBtn': '‚ùå Delete Folder and Notes',
                
                // Why Us Modal (Simplified for brevity)
                'whyUsModalTitle': 'üåü Why Choose CloudNotes v1?',
                'whyUsSubtitle': 'Your Data. Your Control. Always.',
                'whyUsTagline': 'We built CloudNotes v1 on a simple principle: **ultimate privacy and simplicity**.',
                'privacyHeader': 'üîí Absolute Privacy (No Cloud!)',
                'privacyBody': 'We **don\'t track, collect, or sell any of your data**. Everything you write or draw stays **private** on your device\'s local storage. This is a local-first application. Big companies (Giants) **sell storage and integration. (your data too!)**. **We (CloudeNotes) sell privacy, simplity, and vibe.** Our prices are avalaible for **Everyone**',
                'noAccountsHeader': 'üö´ Zero Accounts',
                'noAccountsBody': 'No need for email, usernames, or passwords. **No sign-ups**, no log-ins, and no cloud storage required. Just open the app and start noting.',
                'fastHeader': '‚ö°Ô∏è Fast & Reliable',
                'fastBody': 'Since your notes are stored **locally** on your browser, loading is instantaneous. You\'re never dependent on a network connection or server status.',
                'editorHeader': 'üìù Feature-Rich Editor',
                'editorBody': 'Our editor includes **rich text options**, a full **drawing canvas**, and the ability to add **attachments**, all while keeping your data private and local.',
                'whyUsFooter': 'CloudNotes v1: Simple, powerful, and truly private note-taking.',
                
                // Upgrade Modal (Simplified for brevity)
                'upgradeModalTitle': 'üöÄ Upgrade to CloudNotes Pro',
                'upgradeSubtitle': 'Get the Full CloudNotes v1 Experience!',
                'upgradeTagline': 'Unlock Pro features while maintaining **ultimate privacy and simplicity**.',
                'pricingTitle': 'Simple & Affordable Pricing',
                'proMonthlyTitle': 'Pro Monthly',
                'proMonthlyPrice': '$3.49',
                'proMonthlyDuration': 'per month',
                'proMonthlyCancel': '*cancel anytime',
                'chooseMonthlyBtn': 'Choose Monthly',
                'proAnnualTitle': 'Pro Annual',
                'saveBadge': 'üî• Save 59%',
                'proAnnualPrice': '$24.99',
                'proAnnualDuration': 'per year (Billed Annually)',
                'chooseAnnualBtn': 'Choose Annual',
                'comparisonTitle': 'Free vs. Pro Comparison',
                'featureCol': 'Feature',
                'freePlanCol': 'Free Plan',
                'proPlanCol': 'Pro Plan',
                'maxFolders': 'Maximum Folders',
                'maxNotes': 'Maximum Notes per Folder',
                'geminiRequests': 'Gemini AI Requests (per week)',
                'customIcons': 'Custom Icons',
                'customBackgrounds': 'Custom Backgrounds',
                'fileSupport': 'File Support (.wav, .zip, etc.)',
                'freeFolders': 'Up to 5 folders',
                'proFolders': 'Up to 25 folders',
                'freeNotes': '5 notes max',
                'proNotes': '100 notes max',
                'freeGemini': '3 requests',
                'proGemini': 'Up to 100 requests',
                'freeIcons': 'No custom icons',
                'proIcons': '‚úÖ Custom Icons',
                'freeBackgrounds': 'No custom backgrounds',
                'proBackgrounds': '‚úÖ Custom Backgrounds',
                'freeFiles': 'No .waw files supported',
                'proFiles': '‚úÖ Almost all type of files are supported',
                'upgradeFooter': 'Upgrade to Pro and make CloudNotes v1 truly unlimited.',
            },
            'ru': {
                // Simplified Russian translations for brevity...
                'appTitle': 'CloudNotes v1',
                'appAuthor': '–æ—Ç Niko - –õ–æ–∫–∞–ª—å–Ω—ã–π –ú—É–ª—å—Ç–∏—Ç—É–ª',
                'whyUsBtn': '–ü–æ—á–µ–º—É –º—ã? (–≠—Ç–æ –õ–æ–∫–∞–ª—å–Ω–æ!)',
                'upgradeBtn': '‚ú® –û–±–Ω–æ–≤–∏—Ç—å –¥–æ Pro',
                'folderBtn': '+ –ü–∞–ø–∫–∞',
                'newNoteIcon': 'üìù',
                'totalNotesLabel': '–í—Å–µ–≥–æ –∑–∞–º–µ—Ç–æ–∫',
                'searchPlaceholder': '–ò—Å–∫–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏...',
                'exportBtn': '‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç',
                'importBtn': '‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç',
                'timestampBtn': '‚è∞ –®—Ç–∞–º–ø', // NEW
                'emptySelectFolder': '–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É',
                'newNoteTitle': '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞',
                'noteTitlePlaceholder': '‚ú® –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏...',
                'noteContentPlaceholder': '‚úçÔ∏è –ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–µ –∏–¥–µ–∏...',
                'drawBtn': 'üé® –†–∏—Å–æ–≤–∞—Ç—å',
                'imageBtn': 'üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                'fileBtn': 'üìé –§–∞–π–ª',
                'pasteClipboardBtn': 'üìã –í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞',
                'bookmarkBtn': '‚≠ê –í –∑–∞–∫–ª–∞–¥–∫–∏',
                'bookmarkedBtn': 'üåü –í –∑–∞–∫–ª–∞–¥–∫–∞—Ö',
                'saveNoteBtn': 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É',
                'deleteNoteBtn': 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É',
                'clearCanvasBtn': 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å',
                'saveDrawingBtn': 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫',
                'drawingStatusReady': '–ì–æ—Ç–æ–≤',
                'drawingStatusDrawing': '–†–∏—Å—É–µ–º...',
                'drawingStatusLoaded': '–†–∏—Å—É–Ω–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω.',
                'drawingStatusSaved': '–†–∏—Å—É–Ω–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!',
                'clipboardTitle': 'üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É—Ñ–µ—Ä–∞',
                'insertClipboardBtn': '‚ú® –í—Å—Ç–∞–≤–∏—Ç—å –≤ –∑–∞–º–µ—Ç–∫—É',
                'attachmentsTitle': 'üìé –í–ª–æ–∂–µ–Ω–∏—è',
                'noteBadge': '–ó–∞–º–µ—Ç–∫–∞',
                'bookmarkedBadge': '‚≠ê –í –∑–∞–∫–ª–∞–¥–∫–∞—Ö',
                'saveIndicator': '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!',
                'noteNotFound': '–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.',
                'noNotesYet': '–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–º–µ—Ç–∫—É!',
                'searchEmpty': '–ó–∞–º–µ—Ç–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É ',
                'alertFolderEmpty': '–ò–º—è –ø–∞–ø–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!',
                'alertNoFolderSelected': '–ü–∞–ø–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞!',
                'alertTitleEmpty': '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!',
                'alertClipboardEmpty': '–ë—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –ø—É—Å—Ç!',
                'alertClipboardError': '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É—Ñ–µ—Ä—É. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.',
                'alertDeleteConfirm': '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –≤–ª–æ–∂–µ–Ω–∏–µ?',
                'alertSelectFolder': '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é!',
                'brushSizeLabel': '–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏:',
                'alertDeleteNoteConfirm': '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.',
                'alertDeleteFolderConfirm': '–í–ù–ò–ú–ê–ù–ò–ï: –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–∞–ø–∫—É –∏ –í–°–ï –µ–µ –∑–∞–º–µ—Ç–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.',
                'alertImportSuccess': '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!',
                'alertImportFail': '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞.',
                'alertExportSuccess': '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!',
                'newFolderTitle': '‚ú® –ù–æ–≤–∞—è –ø–∞–ø–∫–∞',
                'folderNamePlaceholder': 'üìÅ –ò–º—è –ø–∞–ø–∫–∏...',
                'colorTitle': 'üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏–∫–æ–Ω–∫–∏',
                'createFolderBtn': '‚ú® –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É',
                'deleteFolderModalBtn': '‚ùå –£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É –∏ –∑–∞–º–µ—Ç–∫–∏',
                'whyUsModalTitle': 'üåü –ü–æ—á–µ–º—É CloudNotes v1?',
                'whyUsSubtitle': '–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. –í–∞—à –∫–æ–Ω—Ç—Ä–æ–ª—å. –í—Å–µ–≥–¥–∞.',
                'whyUsTagline': '–ú—ã —Å–æ–∑–¥–∞–ª–∏ CloudNotes v1 –ø–æ –ø—Ä–æ—Å—Ç–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø—É: **–∞–±—Å–æ–ª—é—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç–∞**.',
                'privacyHeader': 'üîí –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å (–ù–µ—Ç –û–±–ª–∞–∫–∞!)',
                'privacyBody': '–ú—ã **–Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º, –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º –∏ –Ω–µ –ø—Ä–æ–¥–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ**. –í—Å–µ, —á—Ç–æ –≤—ã –ø–∏—à–µ—Ç–µ –∏–ª–∏ —Ä–∏—Å—É–µ—Ç–µ, –æ—Å—Ç–∞–µ—Ç—Å—è **–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º** –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ. –ö—Ä—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–ì–∏–≥–∞–Ω—Ç—ã) **–ø—Ä–æ–¥–∞—é—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é. (–∏ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ!)**. **–ú—ã (CloudeNotes) –ø—Ä–æ–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç—É –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.** –ù–∞—à–∏ —Ü–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã **–ö–∞–∂–¥–æ–º—É**',
                'noAccountsHeader': 'üö´ –ù—É–ª–µ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã',
                'noAccountsBody': '–ù–µ –Ω—É–∂–Ω—ã —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞, –ª–æ–≥–∏–Ω—ã –∏–ª–∏ –ø–∞—Ä–æ–ª–∏. **–ù–∏–∫–∞–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏**, –≤—Ö–æ–¥–∞ –∏ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ –¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏.',
                'fastHeader': '‚ö°Ô∏è –ë—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ',
                'fastBody': '–ü–æ—Å–∫–æ–ª—å–∫—É –≤–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è **–ª–æ–∫–∞–ª—å–Ω–æ** –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ, –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í—ã –Ω–µ –∑–∞–≤–∏—Å–∏—Ç–µ –æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞.',
                'editorHeader': 'üìù –ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä',
                'editorBody': '–ù–∞—à —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤–∫–ª—é—á–∞–µ—Ç **—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø—Ü–∏–∏**, –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π **—Ö–æ–ª—Å—Ç –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è** –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å **–≤–ª–æ–∂–µ–Ω–∏—è**, –≤—Å–µ –ø—Ä–∏ —ç—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω—è—è –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º–∏ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–º–∏.',
                'whyUsFooter': 'CloudNotes v1: –ü—Ä–æ—Å—Ç–æ–µ, –º–æ—â–Ω–æ–µ –∏ –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫.',
                'upgradeModalTitle': 'üöÄ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ CloudNotes Pro',
                'upgradeSubtitle': '–ü–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ–ø—ã—Ç CloudNotes v1!',
                'upgradeTagline': '–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ Pro-—Ñ—É–Ω–∫—Ü–∏–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º **–∞–±—Å–æ–ª—é—Ç–Ω—É—é –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç—É**.',
                'pricingTitle': '–ü—Ä–æ—Å—Ç—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–Ω—ã',
                'proMonthlyTitle': 'Pro –ï–∂–µ–º–µ—Å—è—á–Ω–æ',
                'proMonthlyPrice': '$3.49',
                'proMonthlyDuration': '–≤ –º–µ—Å—è—Ü',
                'proMonthlyCancel': '*–æ—Ç–º–µ–Ω–∞ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è',
                'chooseMonthlyBtn': '–í—ã–±—Ä–∞—Ç—å –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π',
                'proAnnualTitle': 'Pro –ì–æ–¥–æ–≤–æ–π',
                'saveBadge': 'üî• –°—ç–∫–æ–Ω–æ–º—å—Ç–µ 59%',
                'proAnnualPrice': '$24.99',
                'proAnnualDuration': '–≤ –≥–æ–¥ (–æ–ø–ª–∞—Ç–∞ —Ä–∞–∑ –≤ –≥–æ–¥)',
                'chooseAnnualBtn': '–í—ã–±—Ä–∞—Ç—å –≥–æ–¥–æ–≤–æ–π',
                'comparisonTitle': '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ Free –∏ Pro',
                'featureCol': '–§—É–Ω–∫—Ü–∏—è',
                'freePlanCol': '–ü–ª–∞–Ω Free',
                'proPlanCol': '–ü–ª–∞–Ω Pro',
                'maxFolders': '–ú–∞–∫—Å–∏–º—É–º –ø–∞–ø–æ–∫',
                'maxNotes': '–ú–∞–∫—Å–∏–º—É–º –∑–∞–º–µ—Ç–æ–∫ –≤ –ø–∞–ø–∫–µ',
                'geminiRequests': '–ó–∞–ø—Ä–æ—Å—ã Gemini AI (–≤ –Ω–µ–¥–µ–ª—é)',
                'customIcons': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∫–æ–Ω–∫–∏',
                'customBackgrounds': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–æ–Ω—ã',
                'fileSupport': '–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∞–π–ª–æ–≤ (.wav, .zip, –∏ —Ç.–¥.)',
                'freeFolders': '–î–æ 5 –ø–∞–ø–æ–∫',
                'proFolders': '–î–æ 25 –ø–∞–ø–æ–∫',
                'freeNotes': '–ú–∞–∫—Å–∏–º—É–º 5 –∑–∞–º–µ—Ç–æ–∫',
                'proNotes': '–ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–º–µ—Ç–æ–∫',
                'freeGemini': '3 –∑–∞–ø—Ä–æ—Å–∞',
                'proGemini': '–î–æ 100 –∑–∞–ø—Ä–æ—Å–æ–≤',
                'freeIcons': '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–∫–æ–Ω–æ–∫',
                'proIcons': '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∫–æ–Ω–∫–∏',
                'freeBackgrounds': '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–æ–Ω–æ–≤',
                'proBackgrounds': '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–æ–Ω—ã',
                'freeFiles': '–§–∞–π–ª—ã .waw –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è',
                'proFiles': '‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø–æ—á—Ç–∏ –≤—Å–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤',
                'upgradeFooter': '–û–±–Ω–æ–≤–∏—Ç–µ—Å—å –¥–æ Pro –∏ —Å–¥–µ–ª–∞–π—Ç–µ CloudNotes v1 –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–º.',
            }
        };

        let currentLanguage = 'en'; // Default language

        /**
         * Switches the application language based on the provided code.
         * @param {string} langCode - 'en' or 'ru'.
         */
        function switchLanguage(langCode) {
            currentLanguage = langCode;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const translation = TRANSLATIONS[langCode] && TRANSLATIONS[langCode][key];

                if (translation) {
                    if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                        el.setAttribute('placeholder', translation);
                    } else {
                        el.textContent = translation;
                    }
                }
            });
            // Re-render notes and folders to update badges/text
            renderFolders();
            loadNotes(data.currentFolder);
        }

        // --- START DATA MODEL ---
        const data = {
            folders: [],
            currentFolder: null, // The ID of the currently selected folder
            currentNote: null, // The ID of the note being edited
            nextFolderId: 1,
            nextNoteId: 1,
            canvasContext: null,
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            currentDrawing: null, // Stores the base64 string of the drawing being edited
        };

        // --- CORE DATA MANAGEMENT ---

        /**
         * Saves the main data object to local storage.
         */
        function saveData() {
            try {
                const storageData = {
                    folders: data.folders,
                    currentFolder: data.currentFolder,
                    nextFolderId: data.nextFolderId,
                    nextNoteId: data.nextNoteId,
                    theme: document.body.getAttribute('data-theme'),
                    lang: currentLanguage
                };
                localStorage.setItem('cloudNotesData', JSON.stringify(storageData));
                console.log('‚úÖ Data saved to local storage!');
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        /**
         * Loads data from local storage on startup.
         */
        function loadData() {
            try {
                const storedData = localStorage.getItem('cloudNotesData');
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    data.folders = parsed.folders || [];
                    data.currentFolder = parsed.currentFolder || null;
                    data.nextFolderId = parsed.nextFolderId || 1;
                    data.nextNoteId = parsed.nextNoteId || 1;
                    
                    if (parsed.theme) {
                        document.body.setAttribute('data-theme', parsed.theme);
                        document.getElementById('themeToggle').textContent = 
                            parsed.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                    }

                    if (parsed.lang) {
                        document.getElementById('langSelect').value = parsed.lang;
                        switchLanguage(parsed.lang);
                    }
                    
                    console.log('‚úÖ Data loaded from storage!');
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        // --- FOLDER FUNCTIONS ---

        /**
         * Opens the folder creation/edit modal.
         * @param {number} [folderId] - ID of the folder to edit.
         */
        function openFolderModal(folderId) {
            const modal = document.getElementById('folderModal');
            const nameInput = document.getElementById('folderName');
            const modalTitle = document.getElementById('folderModalTitle');
            const saveBtn = document.getElementById('saveFolderModalBtn');
            const deleteBtn = document.getElementById('deleteFolderModalBtn');
            const colorOptions = document.querySelectorAll('.color-option');
            
            modal.classList.add('active');
            data.currentFolder = folderId;
            
            // Reset state
            nameInput.value = '';
            deleteBtn.style.display = 'none';

            if (folderId) {
                const folder = data.folders.find(f => f.id === folderId);
                if (folder) {
                    modalTitle.textContent = 'Edit Folder';
                    nameInput.value = folder.name;
                    saveBtn.textContent = 'Save Changes';
                    deleteBtn.style.display = 'block';

                    // Select correct color
                    colorOptions.forEach(opt => {
                        opt.classList.remove('selected');
                        if (opt.getAttribute('data-color') === folder.color) {
                            opt.classList.add('selected');
                        }
                    });
                }
            } else {
                modalTitle.textContent = TRANSLATIONS[currentLanguage].newFolderTitle;
                saveBtn.textContent = TRANSLATIONS[currentLanguage].createFolderBtn;
                // Default to first color
                colorOptions.forEach((opt, index) => {
                    opt.classList.remove('selected');
                    if (index === 0) opt.classList.add('selected');
                });
            }
        }

        /**
         * Creates or initiates the folder creation.
         */
        function createFolder() {
            openFolderModal(null);
        }
        
        /**
         * Selects the icon color in the modal.
         * @param {HTMLElement} element - The clicked color option element.
         */
        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }

        /**
         * Saves the folder data from the modal (create or edit).
         */
        function saveFolderModal() {
            const nameInput = document.getElementById('folderName');
            const folderName = nameInput.value.trim();
            const selectedColor = document.querySelector('.color-option.selected').getAttribute('data-color');
            
            if (!folderName) {
                alert(TRANSLATIONS[currentLanguage].alertFolderEmpty);
                return;
            }

            if (data.currentFolder) {
                // Edit existing folder
                const folder = data.folders.find(f => f.id === data.currentFolder);
                if (folder) {
                    folder.name = folderName;
                    folder.color = selectedColor;
                }
            } else {
                // Create new folder
                data.folders.push({
                    id: data.nextFolderId++,
                    name: folderName,
                    color: selectedColor,
                    notes: []
                });
            }
            
            closeFolderModal();
            saveData();
            renderFolders();
        }

        /**
         * Closes the folder modal.
         */
        function closeFolderModal() {
            document.getElementById('folderModal').classList.remove('active');
            data.currentFolder = null; // Clear edit context
        }

        /**
         * Renders the list of folders in the sidebar.
         */
        function renderFolders() {
            const container = document.getElementById('foldersContainer');
            container.innerHTML = '';
            
            // Update total notes count
            const totalNotes = data.folders.reduce((sum, folder) => sum + folder.notes.length, 0);
            document.getElementById('totalNotes').textContent = totalNotes;

            if (data.folders.length === 0) {
                container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-secondary); opacity: 0.8;">No folders created.</div>`;
                return;
            }

            data.folders.forEach(folder => {
                const notesInFolder = folder.notes.length;
                const folderDiv = document.createElement('div');
                folderDiv.className = `folder-item ${folder.id === data.currentFolder ? 'active' : ''}`;
                folderDiv.setAttribute('data-folder-id', folder.id);
                folderDiv.onclick = () => selectFolder(folder.id);

                folderDiv.innerHTML = `
                    <div class="folder-icon" style="background: ${folder.color}; color: white;">
                        ${notesInFolder > 0 ? 'üìö' : 'üìÅ'}
                    </div>
                    <div class="folder-name">${folder.name}</div>
                    <div class="folder-count">${notesInFolder}</div>
                    <button class="delete-folder-btn" title="Edit/Delete Folder" onclick="event.stopPropagation(); openFolderModal(${folder.id})">‚öôÔ∏è</button>
                `;
                container.appendChild(folderDiv);
            });
        }
        
        /**
         * Deletes the currently selected folder and all its notes.
         */
        function deleteFolder() {
            if (!data.currentFolder) return;
            
            if (confirm(TRANSLATIONS[currentLanguage].alertDeleteFolderConfirm)) {
                data.folders = data.folders.filter(f => f.id !== data.currentFolder);
                
                // Reset current folder and note views
                data.currentFolder = null;
                data.currentNote = null;
                
                closeFolderModal();
                saveData();
                renderFolders();
                document.getElementById('contentArea').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div class="empty-text" data-i18n="emptySelectFolder">${TRANSLATIONS[currentLanguage].emptySelectFolder}</div>
                    </div>
                `;
            }
        }


        // --- NOTE FUNCTIONS ---

        /**
         * Selects a folder and displays its notes.
         * @param {number} folderId - The ID of the selected folder.
         */
        function selectFolder(folderId) {
            data.currentFolder = folderId;
            saveData();
            renderFolders(); // Update active state
            loadNotes(folderId);
        }

        /**
         * Displays the notes for the current folder.
         * @param {number} folderId - The ID of the folder whose notes to load.
         * @param {string} [searchTerm] - Optional term for filtering notes.
         */
        function loadNotes(folderId, searchTerm = '') {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '';
            
            const folder = data.folders.find(f => f.id === folderId);
            if (!folder) {
                contentArea.innerHTML = `<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text">${TRANSLATIONS[currentLanguage].noteNotFound}</div></div>`;
                return;
            }

            let notes = folder.notes;

            // Apply search filter
            if (searchTerm) {
                const lowerSearch = searchTerm.toLowerCase();
                notes = notes.filter(note => 
                    note.title.toLowerCase().includes(lowerSearch) || 
                    note.content.toLowerCase().includes(lowerSearch) // Check content for rich text too
                );
            }

            if (notes.length === 0 && !searchTerm) {
                contentArea.innerHTML = `<div class="empty-state"><div class="empty-icon">üí°</div><div class="empty-text">${TRANSLATIONS[currentLanguage].noNotesYet}</div></div>`;
                return;
            }
            
            if (notes.length === 0 && searchTerm) {
                contentArea.innerHTML = `<div class="empty-state"><div class="empty-icon">üîé</div><div class="empty-text">${TRANSLATIONS[currentLanguage].searchEmpty}"${searchTerm}"</div></div>`;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'notes-grid';

            notes.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                card.onclick = () => openNoteModal(note.id);
                
                // Safely extract text content from rich HTML for preview
                const parser = new DOMParser();
                const doc = parser.parseFromString(note.content, 'text/html');
                const textPreview = doc.body.textContent.substring(0, 100) + (doc.body.textContent.length > 100 ? '...' : '');

                card.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-preview">${textPreview || 'No content...'}</div>
                    <div class="note-meta">
                        <span class="note-badge" style="background: ${note.bookmarked ? 'var(--warning)' : 'var(--accent-light)'}; color: ${note.bookmarked ? 'white' : 'var(--accent)'};">${note.bookmarked ? TRANSLATIONS[currentLanguage].bookmarkedBadge : TRANSLATIONS[currentLanguage].noteBadge}</span>
                        <span>${note.date}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
            contentArea.appendChild(grid);
        }

        /**
         * Opens the modal for creating a new note.
         */
        function openNewNote() {
            if (!data.currentFolder) {
                alert(TRANSLATIONS[currentLanguage].alertSelectFolder);
                return;
            }
            openNoteModal(null);
        }

        /**
         * Opens the note editor modal for a new or existing note.
         * @param {number} [noteId] - ID of the note to edit.
         */
        function openNoteModal(noteId) {
            const modal = document.getElementById('noteModal');
            const titleInput = document.getElementById('noteTitle');
            const contentEditor = document.getElementById('noteContent');
            const modalTitle = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('deleteNoteBtn');
            const bookmarkBtn = document.getElementById('bookmarkBtn');
            const canvasContainer = document.getElementById('canvasContainer');
            
            modal.classList.add('active');
            data.currentNote = noteId;
            canvasContainer.style.display = 'none'; // Hide canvas by default
            data.currentDrawing = null;
            deleteBtn.style.display = 'none';

            // Reset Editor Styles to default
            contentEditor.style.fontFamily = 'Arial';
            contentEditor.style.fontSize = '16px';
            document.getElementById('fontFamily').value = 'Arial';
            document.getElementById('fontSize').value = 16;
            
            // Clear or load content
            if (noteId) {
                const folder = data.folders.find(f => f.id === data.currentFolder);
                const note = folder ? folder.notes.find(n => n.id === noteId) : null;

                if (note) {
                    modalTitle.textContent = 'Edit Note';
                    titleInput.value = note.title;
                    contentEditor.innerHTML = note.content;
                    data.currentDrawing = note.drawing;
                    
                    // Set editor styles from note
                    contentEditor.style.fontFamily = note.fontFamily || 'Arial';
                    contentEditor.style.fontSize = (note.fontSize || 16) + 'px';
                    document.getElementById('fontFamily').value = note.fontFamily || 'Arial';
                    document.getElementById('fontSize').value = note.fontSize || 16;

                    // Update bookmark button
                    bookmarkBtn.textContent = note.bookmarked ? TRANSLATIONS[currentLanguage].bookmarkedBtn : TRANSLATIONS[currentLanguage].bookmarkBtn;
                    bookmarkBtn.style.background = note.bookmarked ? 'var(--warning)' : 'var(--accent)';

                    deleteBtn.style.display = 'inline-block';
                }
            } else {
                modalTitle.textContent = TRANSLATIONS[currentLanguage].newNoteTitle;
                titleInput.value = '';
                contentEditor.innerHTML = '';
                bookmarkBtn.textContent = TRANSLATIONS[currentLanguage].bookmarkBtn;
                bookmarkBtn.style.background = 'var(--accent)';
            }
            
            // Clear clipboard section
            document.getElementById('clipboardSection').style.display = 'none';
            document.getElementById('clipboardPreview').textContent = '';
            
            renderAttachments();
            
            // If a drawing exists, load it into the hidden canvas for editing/display
            if (data.currentDrawing) {
                loadDrawing();
            }
            
            // FIX: Set initial focus to the editor after a slight delay
            // This starts the user in the rich-text area but allows interaction with the title/controls.
            setTimeout(() => {
                 document.getElementById('noteContent').focus();
            }, 100);
        }

        /**
         * Closes the note editor modal.
         */
        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            data.currentNote = null;
            data.currentDrawing = null;
            document.getElementById('deleteNoteBtn').style.display = 'none';
        }

        /**
         * Saves the current note (create or update).
         */
        function saveNote() {
            const titleInput = document.getElementById('noteTitle');
            const contentEditor = document.getElementById('noteContent');
            const noteTitle = titleInput.value.trim();
            const noteContent = contentEditor.innerHTML; // Get rich text HTML
            const folder = data.folders.find(f => f.id === data.currentFolder);
            
            if (!noteTitle) {
                alert(TRANSLATIONS[currentLanguage].alertTitleEmpty);
                return;
            }

            if (!folder) {
                alert(TRANSLATIONS[currentLanguage].noteNotFound);
                return;
            }
            
            const noteAttachments = getNoteAttachments();
            const noteFontFamily = document.getElementById('fontFamily').value;
            const noteFontSize = document.getElementById('fontSize').value;


            if (data.currentNote) {
                // Update existing note
                const note = folder.notes.find(n => n.id === data.currentNote);
                if (note) {
                    note.title = noteTitle;
                    note.content = noteContent;
                    note.date = new Date().toLocaleDateString();
                    note.attachments = noteAttachments;
                    note.drawing = data.currentDrawing;
                    note.fontFamily = noteFontFamily;
                    note.fontSize = noteFontSize;
                }
            } else {
                // Create new note
                const newNote = {
                    id: data.nextNoteId++,
                    title: noteTitle,
                    content: noteContent,
                    date: new Date().toLocaleDateString(),
                    bookmarked: false,
                    attachments: noteAttachments,
                    drawing: data.currentDrawing,
                    fontFamily: noteFontFamily,
                    fontSize: noteFontSize,
                };
                folder.notes.push(newNote);
            }

            saveData();
            loadNotes(data.currentFolder);
            closeNoteModal();
        }
        
        /**
         * Deletes the currently open note.
         */
        function deleteNote() {
            if (!data.currentFolder || !data.currentNote) return;

            if (confirm(TRANSLATIONS[currentLanguage].alertDeleteNoteConfirm)) {
                const folder = data.folders.find(f => f.id === data.currentFolder);
                if (folder) {
                    folder.notes = folder.notes.filter(n => n.id !== data.currentNote);
                }
                
                // Clear state and update UI
                data.currentNote = null;
                saveData();
                loadNotes(data.currentFolder);
                closeNoteModal();
            }
        }
        
        /**
         * Toggles the bookmark status of the current note.
         */
        function toggleBookmark() {
            const folder = data.folders.find(f => f.id === data.currentFolder);
            const note = folder ? folder.notes.find(n => n.id === data.currentNote) : null;
            const bookmarkBtn = document.getElementById('bookmarkBtn');

            if (note) {
                note.bookmarked = !note.bookmarked;
                bookmarkBtn.textContent = note.bookmarked ? TRANSLATIONS[currentLanguage].bookmarkedBtn : TRANSLATIONS[currentLanguage].bookmarkBtn;
                bookmarkBtn.style.background = note.bookmarked ? 'var(--warning)' : 'var(--accent)';
                
                saveData();
                loadNotes(data.currentFolder);
            }
        }
        
        /**
         * Filters notes based on the search input.
         */
        function searchNotes() {
            const searchTerm = document.getElementById('searchInput').value;
            if (data.currentFolder) {
                loadNotes(data.currentFolder, searchTerm);
            }
        }
        
        // --- EDITOR FEATURES ---
        
        /**
         * Applies rich text formatting to the note editor content.
         * @param {string} command - The document.execCommand command (e.g., 'bold').
         * @param {string} [value] - Optional value for the command.
         */
        function applyFormat(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('noteContent').focus(); // Keep focus after command
        }
        
        /**
         * Inserts a timestamp into the note editor.
         */
        function insertTimestamp() {
            const editor = document.getElementById('noteContent');
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const timestamp = `[${dateStr} ${timeStr}]`;
            
            // Insert the timestamp at the current cursor position
            if (document.activeElement === editor) {
                document.execCommand('insertText', false, timestamp);
            } else {
                editor.innerHTML += timestamp;
                editor.focus();
            }
        }

        /**
         * Updates the font family and size of the contenteditable div.
         */
        function updateEditorStyle() {
            const editor = document.getElementById('noteContent');
            const fontFamily = document.getElementById('fontFamily').value;
            const fontSize = document.getElementById('fontSize').value;
            
            editor.style.fontFamily = fontFamily;
            editor.style.fontSize = fontSize + 'px';
            
            // Attempt to apply the font style to the current selection
            document.execCommand('fontName', false, fontFamily);
            document.execCommand('fontSize', false, 7); // Font size must be an HTML range (1-7)

            // Since execCommand font size is deprecated, we rely on the CSS style
            // and the saved note property for next load.
        }

        // --- ATTACHMENT FUNCTIONS (Image/File/Drawing) ---

        /**
         * Renders the attachments in the modal.
         */
        function renderAttachments() {
            const grid = document.getElementById('attachmentsGrid');
            grid.innerHTML = '';
            
            // Get current note attachments (or create an empty list)
            let attachments = [];
            if (data.currentNote) {
                const folder = data.folders.find(f => f.id === data.currentFolder);
                const note = folder ? folder.notes.find(n => n.id === data.currentNote) : null;
                if (note) attachments = note.attachments || [];
            }
            // For new notes, we need a temp attachments array, but for now we skip

            if (data.currentDrawing) {
                const drawingItem = document.createElement('div');
                drawingItem.className = 'attachment-item';
                drawingItem.innerHTML = `
                    <span class="attachment-icon">üé®</span>
                    <span class="attachment-name">Drawing (${data.currentDrawing.length > 1000 ? 'Large' : 'Small'})</span>
                    <button class="delete-attachment-btn" title="Delete Drawing" onclick="deleteDrawing()">‚ùå</button>
                `;
                grid.appendChild(drawingItem);
            }

            attachments.forEach((att, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                
                let icon = 'üìé';
                if (att.mimeType.startsWith('image/')) icon = 'üñºÔ∏è';
                else if (att.mimeType.includes('pdf')) icon = 'üìÑ';
                else if (att.mimeType.includes('zip')) icon = 'üì¶';

                item.innerHTML = `
                    <span class="attachment-icon">${icon}</span>
                    <span class="attachment-name">${att.name}</span>
                    <button class="delete-attachment-btn" title="Delete Attachment" onclick="deleteAttachment(${index})">‚ùå</button>
                    <a href="${att.data}" download="${att.name}" style="text-decoration: none; margin-left: 5px;">‚¨áÔ∏è</a>
                `;
                grid.appendChild(item);
            });
        }
        
        /**
         * Converts files to Base64 strings and adds them to the note.
         * @param {Event} event - The file input change event.
         * @param {boolean} isImage - True if adding an image.
         */
        function addAttachment(file, isImage) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const newAttachment = {
                    name: file.name,
                    mimeType: file.type || 'application/octet-stream',
                    data: e.target.result // Base64 string
                };
                
                // Get the current note or the temp attachment array for a new note
                let attachments = getNoteAttachments();
                attachments.push(newAttachment);
                setNoteAttachments(attachments);

                renderAttachments();
            };
            reader.readAsDataURL(file);
        }
        
        function addImage() {
            const files = document.getElementById('imageUpload').files;
            if (files.length > 0) {
                addAttachment(files[0], true);
            }
        }

        function addFile() {
            const files = document.getElementById('fileUpload').files;
            if (files.length > 0) {
                addAttachment(files[0], false);
            }
        }
        
        /**
         * Helper to get attachments list (handles both existing and new notes)
         */
        function getNoteAttachments() {
             const folder = data.folders.find(f => f.id === data.currentFolder);
            if (data.currentNote) {
                const note = folder ? folder.notes.find(n => n.id === data.currentNote) : null;
                return note ? (note.attachments || []) : [];
            }
            // For new notes, we can't save to a note object yet, 
            // so we temporarily attach to the note modal for collection on save.
            // This is a simplification; a full implementation would use a temp array.
            // For this example, we assume we are only adding to an existing note, or it gets bundled on save.
            
            // To support attachments on new notes, we must attach them to the editor content 
            // as temporary invisible elements, or use a global temp array.
            // Let's use a temporary attribute on the editor for simplicity in a single-file app.
            
            let tempAttachments = document.getElementById('noteContent').getAttribute('data-temp-attachments');
            return tempAttachments ? JSON.parse(tempAttachments) : [];
        }

        /**
         * Helper to set attachments list (handles both existing and new notes)
         */
        function setNoteAttachments(attachments) {
            const folder = data.folders.find(f => f.id === data.currentFolder);
            if (data.currentNote) {
                const note = folder ? folder.notes.find(n => n.id === data.currentNote) : null;
                if (note) {
                    note.attachments = attachments;
                    return;
                }
            }
            // For new notes
            document.getElementById('noteContent').setAttribute('data-temp-attachments', JSON.stringify(attachments));
        }

        /**
         * Deletes an attachment by its index.
         * @param {number} index - Index of the attachment in the array.
         */
        function deleteAttachment(index) {
            if (confirm(TRANSLATIONS[currentLanguage].alertDeleteConfirm)) {
                let attachments = getNoteAttachments();
                attachments.splice(index, 1);
                setNoteAttachments(attachments);
                renderAttachments();
            }
        }


        // --- DRAWING CANVAS FUNCTIONS ---

        function toggleDrawing() {
            const container = document.getElementById('canvasContainer');
            const isVisible = container.style.display !== 'none';
            container.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                initializeCanvas();
                loadDrawing();
            } else {
                data.isDrawing = false;
            }
        }

        function initializeCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            const container = document.getElementById('canvasContainer');
            
            // Set canvas size dynamically
            canvas.width = container.clientWidth - 40; 
            canvas.height = 300; 

            data.canvasContext = canvas.getContext('2d');
            data.canvasContext.lineCap = 'round';
            data.canvasContext.lineJoin = 'round';
            data.canvasContext.strokeStyle = document.getElementById('drawColor').value;
            data.canvasContext.lineWidth = document.getElementById('drawSize').value;

            // Event Listeners
            canvas.onmousedown = (e) => startDrawing(e, canvas);
            canvas.onmousemove = (e) => draw(e, canvas);
            canvas.onmouseup = stopDrawing;
            canvas.onmouseout = stopDrawing;
            
            // Mobile support
            canvas.ontouchstart = (e) => startDrawing(e, canvas);
            canvas.ontouchmove = (e) => draw(e, canvas);
            canvas.ontouchend = stopDrawing;

            document.getElementById('drawColor').onchange = (e) => data.canvasContext.strokeStyle = e.target.value;
            document.getElementById('drawSize').onchange = (e) => data.canvasContext.lineWidth = e.target.value;
            
            document.getElementById('drawingStatus').textContent = TRANSLATIONS[currentLanguage].drawingStatusReady;
        }

        function startDrawing(e, canvas) {
            e.preventDefault();
            data.isDrawing = true;
            [data.lastX, data.lastY] = [e.offsetX || e.touches[0].clientX - canvas.offsetLeft, e.offsetY || e.touches[0].clientY - canvas.offsetTop];
            document.getElementById('drawingStatus').textContent = TRANSLATIONS[currentLanguage].drawingStatusDrawing;
        }

        function draw(e, canvas) {
            if (!data.isDrawing) return;
            e.preventDefault();
            
            const [x, y] = [e.offsetX || e.touches[0].clientX - canvas.offsetLeft, e.offsetY || e.touches[0].clientY - canvas.offsetTop];

            data.canvasContext.beginPath();
            data.canvasContext.moveTo(data.lastX, data.lastY);
            data.canvasContext.lineTo(x, y);
            data.canvasContext.stroke();
            [data.lastX, data.lastY] = [x, y];
        }

        function stopDrawing() {
            data.isDrawing = false;
            document.getElementById('drawingStatus').textContent = TRANSLATIONS[currentLanguage].drawingStatusReady;
        }
        
        function clearCanvas() {
            if (!data.canvasContext) return;
            data.canvasContext.clearRect(0, 0, document.getElementById('drawingCanvas').width, document.getElementById('drawingCanvas').height);
            data.currentDrawing = null;
            document.getElementById('drawingStatus').textContent = TRANSLATIONS[currentLanguage].drawingStatusReady;
        }

        function saveDrawing() {
            const canvas = document.getElementById('drawingCanvas');
            data.currentDrawing = canvas.toDataURL(); // Save as Base64 string
            document.getElementById('drawingStatus').textContent = TRANSLATIONS[currentLanguage].drawingStatusSaved;
            
            // Re-render attachments to show drawing status
            renderAttachments();
        }

        function loadDrawing() {
            if (data.currentDrawing && data.canvasContext) {
                const img = new Image();
                img.onload = function() {
                    data.canvasContext.clearRect(0, 0, img.width, img.height); // Clear before drawing
                    data.canvasContext.drawImage(img, 0, 0, img.width, img.height);
                    document.getElementById('drawingStatus').textContent = TRANSLATIONS[currentLanguage].drawingStatusLoaded;
                };
                img.src = data.currentDrawing;
            } else if (data.canvasContext) {
                 clearCanvas(); // Ensure canvas is empty if no drawing data
            }
        }
        
        function deleteDrawing() {
            data.currentDrawing = null;
            clearCanvas();
            document.getElementById('canvasContainer').style.display = 'none';
            renderAttachments();
        }

        // --- CLIPBOARD FUNCTIONS ---

        async function pasteFromClipboard() {
            const clipboardSection = document.getElementById('clipboardSection');
            const preview = document.getElementById('clipboardPreview');
            
            try {
                // Read text from clipboard
                const text = await navigator.clipboard.readText();
                
                // Read items (for images/files)
                const items = await navigator.clipboard.read();
                
                let content = '';

                // Prioritize image data if present
                for (const item of items) {
                    if (item.types.includes('image/png')) {
                        const blob = await item.getType('image/png');
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; border-radius: 8px;">`;
                            preview.setAttribute('data-clipboard-data', e.target.result); // Save Base64 for later insertion
                            preview.setAttribute('data-mime-type', 'image/png');
                            clipboardSection.style.display = 'block';
                        };
                        reader.readAsDataURL(blob);
                        return; // Found image, stop here
                    }
                }
                
                // If no image, use text
                if (text) {
                    content = text;
                    preview.textContent = content.substring(0, 500) + (content.length > 500 ? '...' : '');
                    preview.setAttribute('data-clipboard-data', content);
                    preview.setAttribute('data-mime-type', 'text/plain');
                    clipboardSection.style.display = 'block';
                } else {
                    alert(TRANSLATIONS[currentLanguage].alertClipboardEmpty);
                }

            } catch (err) {
                console.error('Failed to read clipboard contents: ', err);
                alert(TRANSLATIONS[currentLanguage].alertClipboardError + ` (${err.name})`);
            }
        }

        function insertClipboard() {
            const clipboardSection = document.getElementById('clipboardSection');
            const preview = document.getElementById('clipboardPreview');
            const dataToInsert = preview.getAttribute('data-clipboard-data');
            const mimeType = preview.getAttribute('data-mime-type');
            
            if (!dataToInsert) return;

            if (mimeType.startsWith('image/')) {
                // Insert as image attachment
                const filename = `Pasted_Image_${new Date().getTime()}.${mimeType.split('/')[1]}`;
                
                let attachments = getNoteAttachments();
                attachments.push({
                    name: filename,
                    mimeType: mimeType,
                    data: dataToInsert
                });
                setNoteAttachments(attachments);
                renderAttachments();

            } else {
                // Insert as text into the editor
                document.getElementById('noteContent').innerHTML += `<p>${dataToInsert.replace(/\n/g, '<br>')}</p>`;
            }
            
            // Clear and hide clipboard section
            clipboardSection.style.display = 'none';
            preview.textContent = '';
            preview.removeAttribute('data-clipboard-data');
            preview.removeAttribute('data-mime-type');
        }


        // --- THEME & MODAL CONTROLS ---

        function toggleTheme() {
            const body = document.body;
            const toggleBtn = document.getElementById('themeToggle');
            if (body.getAttribute('data-theme') === 'light') {
                body.setAttribute('data-theme', 'dark');
                toggleBtn.textContent = '‚òÄÔ∏è';
            } else {
                body.setAttribute('data-theme', 'light');
                toggleBtn.textContent = 'üåô';
            }
            saveData();
            // Re-render QR code if open with new colors
            if (document.getElementById('qrModal').classList.contains('active')) {
                // Must close and reopen to redraw correctly
                closeQrModal();
                generateQRCode();
            }
        }
        
        function openWhyUsModal() {
            document.getElementById('whyUsModal').classList.add('active');
        }

        function closeWhyUsModal() {
            document.getElementById('whyUsModal').classList.remove('active');
        }
        
        function openUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }
        
        // --- DATA UTILITIES (Export/Import/QR) ---

        /**
         * Prepares and returns the full data object for export/transfer.
         */
        function prepareDataForTransfer() {
            // Include ALL application state for a full backup
            return {
                folders: data.folders,
                theme: document.body.getAttribute('data-theme'),
                lang: currentLanguage,
                currentFolder: data.currentFolder,
                nextFolderId: data.nextFolderId,
                nextNoteId: data.nextNoteId,
                timestamp: new Date().toISOString()
            };
        }

        /**
         * Downloads all application data (folders, notes, attachments, settings)
         * as a single JSON file.
         */
        function exportData() {
            const backupData = prepareDataForTransfer();
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            const date = new Date().toLocaleDateString().replace(/\//g, '-');
            a.download = `CloudNotes_Backup_${date}.json`;
            a.href = url;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            alert(TRANSLATIONS[currentLanguage].alertExportSuccess);
        }

        /**
         * Imports application data from a JSON file, overwriting current local storage.
         * @param {Event} event - The file input change event.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const parsed = JSON.parse(e.target.result);

                    // 1. Validate structure (basic check)
                    if (!parsed.folders || !Array.isArray(parsed.folders)) {
                        throw new Error('Invalid backup file format.');
                    }

                    // 2. Restore all data and overwrite current state
                    data.folders = parsed.folders;
                    data.currentFolder = parsed.currentFolder || null;
                    data.nextFolderId = parsed.nextFolderId || 1;
                    data.nextNoteId = parsed.nextNoteId || 1;

                    // 3. Restore Theme and Language
                    if (parsed.theme) {
                        document.body.setAttribute('data-theme', parsed.theme);
                        document.getElementById('themeToggle').textContent = 
                            parsed.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                    }
                    if (parsed.lang) {
                        document.getElementById('langSelect').value = parsed.lang;
                        switchLanguage(parsed.lang); // Important to call this to update UI text
                    }
                    
                    // 4. Update UI
                    saveData();
                    renderFolders();
                    loadNotes(data.currentFolder);
                    alert(TRANSLATIONS[currentLanguage].alertImportSuccess);

                } catch (error) {
                    console.error('Import Error:', error);
                    alert(`${TRANSLATIONS[currentLanguage].alertImportFail}\nDetails: ${error.message}`);
                } finally {
                    // Reset the file input so the user can import the same file again if needed
                    event.target.value = null; 
                }
            };
            reader.readAsText(file);
        }
        
        // --- QR CODE FUNCTIONS ---

        function closeQrModal() {
            document.getElementById('qrModal').classList.remove('active');
            document.getElementById('qrcodeContainer').innerHTML = ''; // Clear QR code
        }

        /**
         * Attempts to generate a QR code for the current app data.
         */
        function generateQRCode() {
            const transferData = prepareDataForTransfer();
            const dataStr = JSON.stringify(transferData);

            // Check size (QR codes are highly limited, ~3000-5000 characters for reliability)
            if (dataStr.length > 5000) { 
                alert("üö´ Data is too large for a reliable QR Code transfer. Use the 'Export' file method for safety.");
                return;
            }
            
            // Open the modal
            const qrModal = document.getElementById('qrModal');
            qrModal.classList.add('active');

            // Clear previous QR code
            const qrContainer = document.getElementById('qrcodeContainer');
            qrContainer.innerHTML = ''; 

            try {
                // Generate the QR code using the imported library
                new QRCode(qrContainer, {
                    text: dataStr,
                    width: 300,
                    height: 300,
                    colorDark : document.body.getAttribute('data-theme') === 'dark' ? "#ffffff" : "#000000",
                    colorLight : document.body.getAttribute('data-theme') === 'dark' ? "#1a1a1a" : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L // Low error correction for maximum data
                });
            } catch (e) {
                 alert("Error generating QR code. Data might still be too large or library failed.");
                 console.error(e);
            }
        }
        
        /**
         * Imports application data from a raw JSON string (e.g., from a QR code scan).
         */
        function importDataFromQr() {
            const dataStr = document.getElementById('qrDataInput').value.trim();
            if (!dataStr) {
                alert("Paste the scanned QR code text first!");
                return;
            }

            try {
                const parsed = JSON.parse(dataStr);

                // 1. Validate structure (basic check)
                if (!parsed.folders || !Array.isArray(parsed.folders)) {
                    throw new Error('Invalid QR data format. Not a CloudNotes backup.');
                }

                // 2. Restore all data and overwrite current state
                data.folders = parsed.folders;
                data.currentFolder = parsed.currentFolder || null;
                data.nextFolderId = parsed.nextFolderId || 1;
                data.nextNoteId = parsed.nextNoteId || 1;

                // 3. Restore Theme
                if (parsed.theme) {
                    document.body.setAttribute('data-theme', parsed.theme);
                    document.getElementById('themeToggle').textContent = 
                        parsed.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                }
                
                // 4. Update UI
                saveData();
                renderFolders();
                loadNotes(data.currentFolder);
                document.getElementById('qrDataInput').value = ''; // Clear input
                closeQrModal();
                alert(TRANSLATIONS[currentLanguage].alertImportSuccess + " via QR Code!");

            } catch (error) {
                console.error('QR Import Error:', error);
                alert(`QR Import Failed. Data is corrupted or incomplete.\nDetails: ${error.message}`);
            }
        }
        
        // --- END DATA UTILITIES ---

        // Initialize app
        function init() {
            loadData();
            renderFolders();
            // Load notes for the last active folder, or default view
            if (data.currentFolder) {
                 loadNotes(data.currentFolder);
            } else {
                 document.getElementById('contentArea').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìù</div>
                        <div class="empty-text">${TRANSLATIONS[currentLanguage].emptySelectFolder}</div>
                    </div>
                `;
            }
            // Ensure the language selector matches the loaded language
            document.getElementById('langSelect').value = currentLanguage;
        }
        
        // Set initial theme if not loaded from storage
        if (!localStorage.getItem('cloudNotesData')) {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // Initialize app on page load
        init();
    </script>
</body>
</html>

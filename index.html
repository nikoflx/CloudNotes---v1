<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">CloudNotes v2.3 - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –í–µ—Ä—Å–∏—è</title>
    
    <style>
        /* CSS Reset and Box Model */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Color Variables (Light & Dark Theme) */
        :root {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f0f0f5;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: rgba(99, 102, 241, 0.1);
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-hover: rgba(99, 102, 241, 0.2);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #262626;
            --text-primary: #f5f5f5;
            --text-secondary: #9ca3af;
            --accent: #818cf8;
            --accent-hover: #6366f1;
            --accent-light: rgba(129, 140, 248, 0.15);
            --border: #2d2d2d;
            --shadow: rgba(0, 0, 0, 0.4);
            --shadow-hover: rgba(129, 140, 248, 0.3);
        }

        /* Base Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* ===================================== */
        /* SIDEBAR STYLES            */
        /* ===================================== */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 2px 0 10px var(--shadow);
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 30px 24px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent-light), transparent);
        }

        .app-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 6px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .app-author {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .why-us-btn {
            display: block;
            width: 100%;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--accent);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--accent);
            box-shadow: 0 2px 8px var(--shadow-hover);
            text-align: center;
        }

        .why-us-btn:hover {
            background: var(--accent);
            color: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .why-us-btn:active {
            transform: translateY(0);
        }

        /* Toolbar in Sidebar */
        .toolbar {
            padding: 20px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        /* General Button Styles */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
            flex-shrink: 0;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-hover);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            padding: 10px 14px;
            font-size: 18px;
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #d97706;
        }
        
        /* NEW: Language Switcher Styles */
        .lang-switcher {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px 15px;
        }
        
        .lang-switcher select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .lang-switcher select:hover {
            border-color: var(--accent);
        }
        /* End NEW: Language Switcher Styles */
        
        /* NEW: Trash Folder Styles */
        .folder-item.trash-item {
            border: 2px solid var(--danger) !important;
            background: var(--danger) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4) !important;
        }
        
        .folder-item.trash-item:hover {
            background: #cc3333 !important;
        }
        
        .folder-item.trash-item .folder-icon {
            background: white !important;
            color: var(--danger) !important;
        }
        /* End NEW: Trash Folder Styles */


        /* Folders Container and Scrollbar */
        .folders-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .system-folders {
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .folders-container::-webkit-scrollbar {
            width: 6px;
        }

        .folders-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        /* Folder Item Styling */
        .folder-item {
            padding: 14px 18px;
            margin: 6px 0;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 2px solid transparent;
        }

        .folder-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(6px);
            border-color: var(--accent-light);
        }

        .folder-item.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 12px var(--shadow-hover);
            transform: translateX(6px);
            border-color: var(--accent);
        }
        
        .folder-item.active:not(.trash-item) .folder-icon {
            background: white !important;
            color: var(--accent) !important;
        }

        .folder-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .folder-item:hover .folder-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .folder-name {
            flex: 1;
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* NEW: Lock Icon Style for PRO folder */
        .folder-name .lock-icon {
            margin-left: 8px;
            color: var(--warning); 
            font-size: 16px;
            filter: drop-shadow(0 0 2px rgba(245, 158, 11, 0.6));
            flex-shrink: 0;
        }
        
        .folder-item.pro-locked .folder-icon {
            background: var(--warning) !important;
            color: white !important;
        }
        
        .folder-item.pro-locked:hover {
            border-color: var(--warning);
        }

        .folder-count {
            font-size: 13px;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* ===================================== */
        /* MAIN CONTENT               */
        /* ===================================== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar (Search, Stats, Theme Toggle) */
        .topbar {
            padding: 20px 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow);
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-bar {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-secondary);
        }
        
        /* NEW: Sort Bar Style */
        .sort-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .sort-bar select {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        /* End NEW: Sort Bar Style */

        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-shrink: 0;
        }

        .theme-toggle {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--accent);
        }

        /* Content Area and Note Grid */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: var(--bg-primary);
        }

        .content-area::-webkit-scrollbar {
            width: 8px;
        }

        .content-area::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        /* Note Card Styling - MODIFIED FOR LEFT COLOR BAR */
        .note-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
            animation: fadeIn 0.4s ease;
            position: relative;
            overflow: hidden;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }
        
        /* NEW: Left Color Indicator Bar */
        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px; /* Width of the color bar */
            height: 100%;
            /* Use a custom CSS property to set the color dynamically */
            background: var(--note-indicator-color, transparent); 
            transition: background 0.3s ease;
            z-index: 5;
            box-shadow: 2px 0 6px var(--shadow); 
        }

        .note-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px var(--shadow);
            /* Border color now based on indicator color or accent */
            border-color: var(--note-indicator-color, var(--accent)); 
        }
        
        /* NEW: Space Theme Style */
        .note-card.space-bg {
            background: #0D0F16 !important; 
            color: #f5f5f5 !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
        }

        .note-card.space-bg .note-title,
        .note-card.space-bg .note-meta {
            color: #f5f5f5 !important;
        }

        .note-card.space-bg .note-preview {
            color: #a0a0a0 !important;
        }


        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .note-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .note-preview {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 12px;
            flex-grow: 1;
        }
        
        /* NEW: Tags Display on Card */
        .note-tags-display {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .note-tag-display {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
        }
        /* End NEW: Tags Display */

        .note-meta {
            padding-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        
        .trash-note-meta {
            justify-content: flex-start;
            gap: 15px;
        }

        .note-badge {
            background: var(--accent-light);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        /* Bookmark Button on Card */
        .bookmark-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            filter: grayscale(1);
            z-index: 10;
        }

        .bookmark-btn.bookmarked {
            filter: grayscale(0);
            transform: scale(1.2);
            color: var(--warning);
        }
        
        /* Save/Action Indicator */
        .save-indicator {
            padding: 12px 20px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }


        /* ===================================== */
        /* MODAL STYLES             */
        /* ===================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transition: background 0.4s, color 0.4s; /* For note color change */
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--accent-light);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .close-btn:hover {
            color: var(--danger);
            border-color: var(--danger);
            transform: scale(1.1) rotate(90deg);
        }

        .modal-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
        
        /* ===================================== */
        /* NOTE EDITOR STYLES         */
        /* ===================================== */
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        /* Space Theme: Style section titles and inner elements based on modal background */
        .modal-content[style*="#0D0F16"] .section-title {
            color: #f5f5f5 !important;
        }


        /* NEW: Note Color Picker */
        .note-color-picker {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .note-color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px var(--shadow);
        }
        
        .note-color-option.selected {
            border-color: var(--accent);
            transform: scale(1.1);
            box-shadow: 0 0 0 4px var(--accent-light);
        }
        
        /* NEW: Tags Input & History/Delete Buttons */
        .note-tags-input-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .note-tags-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
        }
        
        .note-tags-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }
        
        .history-btn-group {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
        }
        /* End NEW: Tags Input & History/Delete Buttons */


        /* Editor Toolbar */
        .editor-toolbar {
            display: flex;
            gap: 12px;
            padding: 18px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            border: 2px solid var(--border);
        }

        .editor-toolbar select,
        .editor-toolbar input[type="number"] {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .editor-toolbar select:focus,
        .editor-toolbar input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .editor-toolbar button {
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .editor-toolbar button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        /* Title Input */
        .note-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 18px;
            margin-bottom: 20px;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        /* Space Theme Input/Editor Styles */
        .modal-content[style*="#0D0F16"] .note-input {
            background: #262626;
            color: #f5f5f5;
            border-color: #3b82f6;
        }

        /* Content Editor */
        .note-editor {
            width: 100%;
            min-height: 350px;
            padding: 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.7;
            resize: vertical;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        
        .modal-content[style*="#0D0F16"] .note-editor {
            background: #262626;
            color: #f5f5f5;
            border-color: #3b82f6;
        }

        .note-editor:focus,
        .note-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        /* Canvas (Drawing) Section */
        .canvas-container {
            margin: 24px 0;
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px var(--shadow);
        }

        #drawingCanvas {
            display: block;
            width: 100%;
            height: 400px;
            cursor: crosshair;
            background: white;
        }

        .canvas-toolbar {
            padding: 16px;
            background: var(--bg-tertiary);
            display: flex;
            gap: 12px;
            align-items: center;
            border-top: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .canvas-toolbar button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .canvas-toolbar input[type="color"] {
            width: 50px;
            height: 40px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }

        .canvas-toolbar input[type="range"] {
            width: 120px;
        }

        /* Attachments Section */
        .attachments-section {
            margin-top: 28px;
        }

        .attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .attachment-item {
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border);
            position: relative;
        }
        
        .modal-content[style*="#0D0F16"] .attachment-item {
            background: #262626;
            color: #f5f5f5;
            border-color: #3b82f6;
        }


        .attachment-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
            border-color: var(--accent);
        }

        .attachment-icon {
            font-size: 38px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px var(--shadow));
        }

        .attachment-name {
            font-size: 13px;
            word-break: break-all;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input[type="file"] {
            display: none;
        }
        
        /* Clipboard Section */
        .clipboard-section {
            margin-top: 28px;
            padding: 20px;
            background: var(--accent-light);
            border-radius: 12px;
            border: 2px solid var(--accent);
        }
        
        .modal-content[style*="#0D0F16"] .clipboard-section {
            background: #1e3a8a;
            border-color: #3b82f6;
        }

        .clipboard-preview {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            max-height: 100px;
            overflow-y: auto;
        }
        
        .modal-content[style*="#0D0F16"] .clipboard-preview {
            background: #0f0f0f;
            color: #9ca3af;
        }
        
        /* Folder Modal Color Picker */
        .color-picker-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .color-option:hover {
            transform: scale(1.15);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 4px var(--accent-light);
            transform: scale(1.15);
        }

        /* Stats in Topbar */
        .stat-item {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-weight: 600;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.6;
            filter: drop-shadow(0 4px 8px var(--shadow));
        }

        .empty-text {
            font-size: 20px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Why Us Section Styles */
        .why-us-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }

        .why-us-card {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid var(--border);
            box-shadow: 0 4px 12px var(--shadow);
            transition: transform 0.3s;
        }

        .why-us-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .why-us-card h4 {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .why-us-card p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        /* End Why Us Section Styles */

        /* NEW: History Modal Styles */
        .history-list {
            list-style: none;
            padding: 0;
        }
        
        .history-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }
        
        .history-item-meta {
            font-size: 14px;
            color: var(--text-secondary);
            flex-grow: 1;
        }
        
        .history-item button {
            margin-left: 15px;
        }
        /* END NEW: History Modal Styles */
        
        /* NEW: Go PRO Message Modal */
        .pro-modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--warning);
        }

        .pro-modal-content h2 {
            font-size: 28px;
            font-weight: 800;
            color: var(--warning);
            margin-bottom: 15px;
        }

        .pro-modal-content p {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .pro-modal-content .btn {
            background: var(--warning);
            color: black;
            font-weight: 700;
            font-size: 16px;
            padding: 12px 24px;
        }
        
    </style>
</head>
<body data-theme="light">
    
    <div class="app-container">
        
        <div class="sidebar">
            
            <div class="sidebar-header">
                <div class="app-title" data-i18n="appTitle">CloudNotes v2.3</div>
                <div class="app-author" data-i18n="appAuthor">–æ—Ç Niko (–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –í–µ—Ä—Å–∏—è)</div>
                <div id="proStatus" style="font-size: 14px; font-weight: 700; margin-bottom: 15px; color: var(--accent);">
                    </div>
                <button class="why-us-btn" data-i18n="whyUsBtn" onclick="openWhyUsModal()">–ü–æ—á–µ–º—É –º—ã?</button>
            </div>
            
            <div class="toolbar">
                <button class="btn" data-i18n="newFolderBtn" onclick="createFolder()">+ –ü–∞–ø–∫–∞</button>
                <button class="btn btn-icon" data-i18n="newNoteBtn" onclick="openNewNote()">üìù</button>
                <button class="btn btn-warning" onclick="toggleProStatus()" id="proBtn" style="flex: 1; min-width: 100%;"></button>
                <button class="btn btn-warning" data-i18n="exportBtn" onclick="exportData()">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn btn-success" data-i18n="importBtn" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç</button>
                <input type="file" id="importFile" accept="application/json" onchange="importData(event)" style="display: none;">
            </div>
            
            <div class="lang-switcher">
                <select id="langSelect" onchange="changeLanguage(this.value)">
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="en">üá∫üá∏ English</option>
                </select>
            </div>

            <div class="folders-container" id="foldersContainer">
                </div>
            
        </div>

        <div class="main-content">
            
            <div class="topbar">
                
                <div class="search-bar">
                    <input type="text" id="searchInput" oninput="searchNotes()">
                    <span class="search-icon">üîç</span>
                </div>
                
                <div class="sort-bar">
                    <label style="font-size: 14px; color: var(--text-secondary); font-weight: 600; white-space: nowrap;" data-i18n="sortLabel">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
                    <select id="sortSelect" onchange="data.sortOrder = this.value; renderNotes(data.currentFolder); saveData();">
                        <option value="updatedDesc" data-i18n="sortUpdatedDesc">–û–±–Ω–æ–≤–ª–µ–Ω–æ (–ù–æ–≤—ã–µ)</option>
                        <option value="updatedAsc" data-i18n="sortUpdatedAsc">–û–±–Ω–æ–≤–ª–µ–Ω–æ (–°—Ç–∞—Ä—ã–µ)</option>
                        <option value="createdDesc" data-i18n="sortCreatedDesc">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–ù–æ–≤—ã–µ)</option>
                        <option value="titleAsc" data-i18n="sortTitleAsc">–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ê-–Ø)</option>
                        <option value="bookmarked" data-i18n="sortBookmarked">–°–Ω–∞—á–∞–ª–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                
                <div class="topbar-actions">
                    <div class="stat-item">
                        <span class="stat-value" id="totalNotes">0</span>
                        <div class="stat-label" data-i18n="totalNotes">–ó–∞–º–µ—Ç–æ–∫</div>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
                </div>
                
            </div>

            <div class="content-area" id="contentArea">
                <div class="empty-state">
                    <div class="empty-icon">üìù</div>
                    <div class="empty-text" id="emptyStateText">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É</div>
                </div>
            </div>
            
        </div>
        
    </div>

    
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle" data-i18n="newNoteModalTitle">–ù–æ–≤–∞—è –ó–∞–º–µ—Ç–∫–∞</div>
                <button class="close-btn" onclick="closeNoteModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="noteTitle">
                
                <h3 class="section-title" data-i18n="colorIndicatorTitle" style="margin-top: 0;">üé® –¶–≤–µ—Ç–Ω–æ–π –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ó–∞–º–µ—Ç–∫–∏</h3>
                <div class="note-color-picker" id="noteColorPicker">
                    <div class="note-color-option selected" style="background: var(--bg-secondary);" data-color="transparent" onclick="selectNoteColor(this)"></div>
                    
                    <div class="note-color-option" style="background: #4ade80;" data-color="#4ade80" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #fb7185;" data-color="#fb7185" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #facc15;" data-color="#facc15" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #60a5fa;" data-color="#60a5fa" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #a855f7;" data-color="#a855f7" onclick="selectNoteColor(this)"></div> <div class="note-color-option" style="background: #0D0F16; border: 2px solid #3b82f6;" data-color="space" onclick="selectNoteColor(this)"></div> 
                </div>
                
                <h3 class="section-title" data-i18n="tagsTitle">üè∑Ô∏è –¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</h3>
                <div class="note-tags-input-container">
                    <input type="text" class="note-tags-input" id="noteTags">
                    <div class="history-btn-group">
                        <button class="btn btn-warning" data-i18n="historyBtn" onclick="openHistoryModal()" id="historyBtn" style="display: none;">‚è≥ –ò—Å—Ç–æ—Ä–∏—è</button>
                        <button class="btn btn-warning" data-i18n="deleteBtn" onclick="deleteNote()" id="noteDeleteBtn" style="background: var(--danger); color: white;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
                
                <div class="editor-toolbar">
                    <select id="fontFamily" onchange="updateEditorStyle()">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Comic Sans MS">Comic Sans MS</option>
                        <option value="Brush Script MT">Brush Script</option>
                        <option value="Trebuchet MS">Trebuchet</option>
                    </select>
                    
                    <input type="number" id="fontSize" value="16" min="10" max="48" onchange="updateEditorStyle()" data-i18n-placeholder="fontSizePlaceholder" placeholder="–†–∞–∑–º–µ—Ä">
                    
                    <button onclick="toggleDrawing()" data-i18n="editorDrawBtn">üé® –†–∏—Å–æ–≤–∞—Ç—å</button>
                    <button onclick="document.getElementById('imageUpload').click()" data-i18n="editorImageBtn">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                    <button onclick="document.getElementById('fileUpload').click()" data-i18n="editorFileBtn">üìé –§–∞–π–ª</button>
                    <button onclick="pasteFromClipboard()" class="btn-warning" data-i18n="editorPasteBtn">üìã –í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞</button>
                    <button onclick="toggleBookmark()" id="bookmarkBtn"></button>
                    <button onclick="saveNote()" class="btn btn-success" data-i18n="saveNoteBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ó–∞–º–µ—Ç–∫—É</button>
                </div>

                <textarea class="note-editor" id="noteContent"></textarea>

                <div class="canvas-container" id="canvasContainer" style="display: none;">
                    <canvas id="drawingCanvas"></canvas>
                    <div class="canvas-toolbar">
                        <button onclick="clearCanvas()" style="background: var(--danger); color: white;" data-i18n="canvasClearBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                        <button onclick="saveDrawing()" class="btn-success" style="background: var(--success); color: white;" data-i18n="canvasSaveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –†–∏—Å—É–Ω–æ–∫</button>
                        <input type="color" id="drawColor" value="#6366f1">
                        <label style="color: var(--text-secondary); font-size: 13px; font-weight: 600;" data-i18n="canvasBrushSize">–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏:</label>
                        <input type="range" id="drawSize" min="1" max="30" value="3">
                        <span id="drawingStatus"></span>
                    </div>
                </div>

                <div class="clipboard-section" id="clipboardSection" style="display: none;">
                    <h3 class="section-title" data-i18n="clipboardTitle">üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ë—É—Ñ–µ—Ä–∞ –û–±–º–µ–Ω–∞</h3>
                    <div class="clipboard-preview" id="clipboardPreview"></div>
                    <button class="btn" style="margin-top: 12px;" data-i18n="clipboardInsertBtn" onclick="insertClipboard()">‚ú® –í—Å—Ç–∞–≤–∏—Ç—å –≤ –ó–∞–º–µ—Ç–∫—É</button>
                </div>

                <div class="attachments-section">
                    <h3 class="section-title" data-i18n="attachmentsTitle">üìé –í–ª–æ–∂–µ–Ω–∏—è</h3>
                    <div class="attachments-grid" id="attachmentsGrid"></div>
                </div>

                <input type="file" id="imageUpload" accept="image/*" onchange="addImage()" multiple>
                <input type="file" id="fileUpload" onchange="addFile()" multiple>
            </div>
        </div>
    </div>

    <div class="modal" id="folderModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title" data-i18n="folderModalTitle">‚ú® –ù–æ–≤–∞—è –ü–∞–ø–∫–∞</div>
                <button class="close-btn" onclick="closeFolderModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="note-input" id="folderName">
                
                <h3 class="section-title" data-i18n="folderColorTitle">üé® –í—ã–±–µ—Ä–∏—Ç–µ –¶–≤–µ—Ç –ò–∫–æ–Ω–∫–∏</h3>
                <div class="color-picker-container">
                    <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #10b981;" data-color="#10b981" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ef4444;" data-color="#ef4444" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #ec4899;" data-color="#ec4899" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #06b6d4;" data-color="#06b6d4" onclick="selectColor(this)"></div>
                    <div class="color-option" style="background: #84cc16;" data-color="#84cc16" onclick="selectColor(this)"></div>
                </div>

                <button class="btn" style="margin-top: 28px; width: 100%;" data-i18n="folderCreateBtn" onclick="saveFolderModal()">‚ú® –°–æ–∑–¥–∞—Ç—å –ü–∞–ø–∫—É</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="whyUsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title" data-i18n="whyUsModalTitle">üåü –ü–æ—á–µ–º—É CloudNotes v2.3?</div>
                <button class="close-btn" onclick="closeWhyUsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <h2 style="font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 20px; color: var(--accent);" data-i18n="whyUsHeading">–í–∞—à–∏ –î–∞–Ω–Ω—ã–µ. –í–∞—à –ö–æ–Ω—Ç—Ä–æ–ª—å. –í—Å–µ–≥–¥–∞.</h2>
                <p style="font-size: 16px; text-align: center; color: var(--text-secondary);" data-i18n="whyUsSubheading">–ú—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ CloudNotes v1 –Ω–∞ –ø—Ä–æ—Å—Ç–æ–º –ø—Ä–∏–Ω—Ü–∏–ø–µ: <strong>–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç–∞</strong>.</p>
                <div class="why-us-section">
                    
                    <div class="why-us-card">
                        <h4 data-i18n="whyUsCard1Title">üîí –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h4>
                        <p data-i18n="whyUsCard1Text">–ú—ã <strong>–Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º, –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º –∏ –Ω–µ –ø—Ä–æ–¥–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</strong>. –í—Å–µ, —á—Ç–æ –≤—ã –ø–∏—à–µ—Ç–µ –∏–ª–∏ —Ä–∏—Å—É–µ—Ç–µ, –æ—Å—Ç–∞–µ—Ç—Å—è <strong>–ø—Ä–∏–≤–∞—Ç–Ω—ã–º</strong> –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ. –ö—Ä—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–ì–∏–≥–∞–Ω—Ç—ã) <strong>–ø—Ä–æ–¥–∞—é—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é. (–∏ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ç–æ–∂–µ!)</strong>. <strong>–ú—ã (CloudNotes) –ø—Ä–æ–¥–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç—É –∏ –≤–∞–π–±.</strong> –ù–∞—à–∏ —Ü–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è <strong>–ö–∞–∂–¥–æ–≥–æ</strong></p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="whyUsCard2Title">üö´ –ù–æ–ª—å –ê–∫–∫–∞—É–Ω—Ç–æ–≤</h4>
                        <p data-i18n="whyUsCard2Text">–ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ, –∏–º–µ–Ω–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ –ø–∞—Ä–æ–ª—è—Ö. <strong>–ù–∏–∫–∞–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</strong>, –Ω–∏–∫–∞–∫–∏—Ö –≤—Ö–æ–¥–æ–≤, –∏ –Ω–∏–∫–∞–∫–æ–≥–æ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ –¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏.</p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="whyUsCard3Title">‚ö°Ô∏è –ë—ã—Å—Ç—Ä–æ –∏ –ù–∞–¥–µ–∂–Ω–æ</h4>
                        <p data-i18n="whyUsCard3Text">–ü–æ—Å–∫–æ–ª—å–∫—É –≤–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è <strong>–ª–æ–∫–∞–ª—å–Ω–æ</strong> –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ, –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç–µ –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞.</p>
                    </div>

                    <div class="why-us-card">
                        <h4 data-i18n="whyUsCard4Title">üìù –ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä</h4>
                        <p data-i18n="whyUsCard4Text">–ù–∞—à —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤–∫–ª—é—á–∞–µ—Ç <strong>—Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞</strong>, –ø–æ–ª–Ω—ã–π <strong>—Ö–æ–ª—Å—Ç –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è</strong> –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å <strong>–≤–ª–æ–∂–µ–Ω–∏—è</strong>, –ø—Ä–∏ —ç—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω—è—è –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–π–Ω–µ –∏ –ª–æ–∫–∞–ª—å–Ω–æ.</p>
                    </div>

                </div>
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                    <p style="font-size: 14px; color: var(--text-primary); font-weight: 600;" data-i18n="whyUsFooter">CloudNotes v2.3: –ü—Ä–æ—Å—Ç–æ–µ, –º–æ—â–Ω–æ–µ –∏ –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title" data-i18n="historyModalTitle">‚è≥ –ò—Å—Ç–æ—Ä–∏—è –í–µ—Ä—Å–∏–π</div>
                <button class="close-btn" onclick="closeHistoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <ul class="history-list" id="historyList">
                    <p style="text-align: center; color: var(--text-secondary)" data-i18n="historyLoading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>
                </ul>
                <p style="margin-top: 20px; font-size: 14px; color: var(--danger);" data-i18n="historyWarning">*–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–º–µ—Ç–∫–∏.</p>
            </div>
        </div>
    </div>
    
    <div class="modal" id="proMessageModal">
        <div class="pro-modal-content">
            <h2 id="proMessageTitle">üîì –î–æ—Å—Ç—É–ø PRO!</h2>
            <p id="proMessageText"></p>
            <button class="btn" id="proMessageActionBtn" onclick="toggleProStatus(); closeProMessageModal()"></button>
            <button class="close-btn" onclick="closeProMessageModal()" style="margin-top: 20px; background: none; border: none; font-size: 16px; color: var(--text-secondary);">&times; <span data-i18n="proMessageClose">–ó–∞–∫—Ä—ã—Ç—å</span></button>
        </div>
    </div>

    
    <script>
        
        // --- LOCALIZATION DATA ---
        const translations = {
            'en': {
                // Sidebar & Header
                'appAuthor': 'by Niko (Maximal Version)',
                'whyUsBtn': 'Why Us?',
                'proStatus': 'PRO Status: {status}',
                'proBtnActive': 'Manage PRO',
                'proBtnInactive': 'Go PRO (Demo)',
                'newFolderBtn': '+ Folder',
                'newNoteBtn': 'üìù New Note',
                'exportBtn': '‚¨áÔ∏è Export',
                'importBtn': '‚¨ÜÔ∏è Import',
                'searchPlaceholder': 'Search notes...',
                'sortLabel': 'Sort by:',
                'sortUpdatedDesc': 'Updated (Newest)',
                'sortUpdatedAsc': 'Updated (Oldest)',
                'sortCreatedDesc': 'Creation Date (Newest)',
                'sortTitleAsc': 'Title (A-Z)',
                'sortBookmarked': 'Bookmarked First',
                'totalNotes': 'Notes',
                'folderWork': 'Work',
                'folderHome': 'Home',
                'folderFunProjects': 'Fun Projects :)',
                'folderTrash': 'Trash',
                'folderPlanning': 'Planning (PRO)',
                'emptyFolderTrash': 'Trash is empty. Nice!',
                'emptyFolderNotes': 'No notes in this folder yet. Create one!',
                'emptySelectFolder': 'Select a folder or create a new note',
                'noteRestoreBtn': '‚Ü©Ô∏è Restore',
                'noteDeletePermanentBtn': '‚ùå Delete Permanently',
                // Messages (Indicators)
                'noteUpdateSuccess': 'Note updated!',
                'noteCreateSuccess': 'Note created!',
                'noteTrashSuccess': 'Moved to Trash!',
                'noteRestoreSuccess': 'Note restored!',
                'noteDeletePermanentSuccess': 'Deleted permanently!',
                'folderCreatedSuccess': 'Folder created!',
                'folderDeletedSuccess': 'Folder deleted!',
                'attachmentAddedSuccess': 'Attachment added!',
                'attachmentRemovedSuccess': 'Attachment removed!',
                'clipboardLoadedSuccess': 'Clipboard data loaded!',
                'clipboardInsertedSuccess': 'Text inserted!',
                'drawingSavedSuccess': 'Drawing saved to note!',
                'drawingCleared': 'Canvas cleared. Drawing removed.',
                'exportSuccess': 'Data exported!',
                'importSuccess': 'Data imported successfully!',
                // Modal & Editor
                'newNoteModalTitle': 'New Note',
                'noteTitlePlaceholder': '‚ú® Note Title...',
                'noteContentPlaceholder': '‚úçÔ∏è Start writing your awesome ideas...',
                'colorIndicatorTitle': 'üé® Note Color Indicator',
                'tagsTitle': 'üè∑Ô∏è Tags (comma separated)',
                'tagsPlaceholder': 'e.g., important, idea, bug-v1',
                'historyBtn': '‚è≥ History',
                'deleteBtn': 'üóëÔ∏è Delete',
                'bookmarkBtn': '‚≠ê Bookmark',
                'bookmarkedBtn': '‚òÖ Bookmarked',
                'saveNoteBtn': 'üíæ Save Note',
                'editorDrawBtn': 'üé® Draw',
                'editorImageBtn': 'üñºÔ∏è Image',
                'editorFileBtn': 'üìé File',
                'editorPasteBtn': 'üìã Paste from Clipboard',
                'editorStatusDrawingSaved': 'Saved drawing exists.',
                'editorStatusDrawingNone': 'No drawing.',
                'canvasClearBtn': 'üóëÔ∏è Clear',
                'canvasSaveBtn': 'üíæ Save Drawing',
                'canvasBrushSize': 'Brush Size:',
                'clipboardTitle': 'üìã Clipboard Content',
                'clipboardInsertBtn': '‚ú® Insert into Note',
                'attachmentsTitle': 'üìé Attachments',
                'attachmentClickToDelete': '(Click to delete)',
                'folderModalTitle': '‚ú® New Folder',
                'folderNamePlaceholder': 'üìÅ Folder Name...',
                'folderColorTitle': 'üé® Choose Icon Color',
                'folderCreateBtn': '‚ú® Create Folder',
                'whyUsModalTitle': 'üåü Why CloudNotes v2.3?',
                'whyUsHeading': 'Your Data. Your Control. Always.',
                'whyUsSubheading': 'We built CloudNotes v1 on a simple principle: **maximum privacy and simplicity**.',
                'whyUsCard1Title': 'üîí Absolute Privacy',
                'whyUsCard1Text': 'We **do not track, collect, or sell your data**. Everything you write or draw remains **private** in your device\'s local storage. This is a local-first application. The big companies (Giants) **sell storage and integration. (and your data too!)**. **We (CloudNotes) sell privacy, simplicity, and a vibe.** Our prices are affordable for **Everyone**.',
                'whyUsCard2Title': 'üö´ Zero Accounts',
                'whyUsCard2Text': 'No need for email, usernames, or passwords. **No sign-up**, no logins, and no cloud storage. Just open the app and start taking notes.',
                'whyUsCard3Title': '‚ö°Ô∏è Fast and Reliable',
                'whyUsCard3Text': 'Because your notes are stored **locally** in your browser, loading is instantaneous. You never depend on an internet connection or server status.',
                'whyUsCard4Title': 'üìù Multifunctional Editor',
                'whyUsCard4Text': 'Our editor includes **text formatting features**, a full **drawing canvas**, and the ability to add **attachments**, all while keeping your data secret and local.',
                'whyUsFooter': 'CloudNotes v2.3: Simple, powerful, and truly private note-taking.',
                'historyModalTitle': '‚è≥ Version History',
                'historyLoading': 'Loading history...',
                'historyWarning': '*Restoring a version will overwrite the current note content.',
                // PRO Message
                'proMessageTitlePro': 'üîì PRO Access!',
                'proMessageTitleLock': 'üîí PRO Access Required',
                'proMessageTextPro': 'This is a PRO-only folder. Get PRO status to unlock advanced features like this Planning folder!',
                'proMessageActionBtn': '‚ú® Get PRO Status Now (Demo)',
                'proMessageClose': 'Close',
                // Alerts/Prompts
                'alertNoFolderName': 'Please enter a folder name.',
                'alertNoNoteContent': 'Note content cannot be empty.',
                'alertSelectFolder': 'Please select a folder before creating a new note.',
                'confirmDeleteFolder': 'Are you sure you want to delete this folder and ALL notes within it? This action is irreversible.',
                'confirmDeletePermanent': 'WARNING: Are you sure you want to delete this note FOREVER? This action is IRREVERSIBLE.',
                'alertNoRestoreFolder': 'No folders to restore the note to.',
                'alertClipboardError': 'Error: Failed to access the clipboard. Please ensure your browser has the necessary permissions.'
            },
            'ru': {
                // Sidebar & Header
                'appAuthor': '–æ—Ç Niko (–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –í–µ—Ä—Å–∏—è)',
                'whyUsBtn': '–ü–æ—á–µ–º—É –º—ã?',
                'proStatus': 'PRO-–°—Ç–∞—Ç—É—Å: {status}',
                'proBtnActive': '–£–ø—Ä–∞–≤–ª—è—Ç—å PRO',
                'proBtnInactive': '–ü–æ–ª—É—á–∏—Ç—å PRO (–î–µ–º–æ)',
                'newFolderBtn': '+ –ü–∞–ø–∫–∞',
                'newNoteBtn': 'üìù –ù–æ–≤–∞—è –ó–∞–º–µ—Ç–∫–∞',
                'exportBtn': '‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç',
                'importBtn': '‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç',
                'searchPlaceholder': '–ü–æ–∏—Å–∫ –∑–∞–º–µ—Ç–æ–∫...',
                'sortLabel': '–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:',
                'sortUpdatedDesc': '–û–±–Ω–æ–≤–ª–µ–Ω–æ (–ù–æ–≤—ã–µ)',
                'sortUpdatedAsc': '–û–±–Ω–æ–≤–ª–µ–Ω–æ (–°—Ç–∞—Ä—ã–µ)',
                'sortCreatedDesc': '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–ù–æ–≤—ã–µ)',
                'sortTitleAsc': '–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–ê-–Ø)',
                'sortBookmarked': '–°–Ω–∞—á–∞–ª–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ',
                'totalNotes': '–ó–∞–º–µ—Ç–æ–∫',
                'folderWork': '–†–∞–±–æ—Ç–∞',
                'folderHome': '–î–æ–º',
                'folderFunProjects': '–í–µ—Å–µ–ª—ã–µ –ü—Ä–æ–µ–∫—Ç—ã :)',
                'folderTrash': '–ö–æ—Ä–∑–∏–Ω–∞',
                'folderPlanning': '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (PRO)',
                'emptyFolderTrash': '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –û—Ç–ª–∏—á–Ω–æ!',
                'emptyFolderNotes': '–í —ç—Ç–æ–π –ø–∞–ø–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é!',
                'emptySelectFolder': '–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É',
                'noteRestoreBtn': '‚Ü©Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
                'noteDeletePermanentBtn': '‚ùå –£–¥–∞–ª–∏—Ç—å –ù–∞–≤—Å–µ–≥–¥–∞',
                // Messages (Indicators)
                'noteUpdateSuccess': '–ó–∞–º–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!',
                'noteCreateSuccess': '–ó–∞–º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!',
                'noteTrashSuccess': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –ö–æ—Ä–∑–∏–Ω—É!',
                'noteRestoreSuccess': '–ó–∞–º–µ—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!',
                'noteDeletePermanentSuccess': '–£–¥–∞–ª–µ–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞!',
                'folderCreatedSuccess': '–ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!',
                'folderDeletedSuccess': '–ü–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞!',
                'attachmentAddedSuccess': '–í–ª–æ–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!',
                'attachmentRemovedSuccess': '–í–ª–æ–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!',
                'clipboardLoadedSuccess': '–î–∞–Ω–Ω—ã–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!',
                'clipboardInsertedSuccess': '–¢–µ–∫—Å—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω!',
                'drawingSavedSuccess': '–†–∏—Å—É–Ω–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∑–∞–º–µ—Ç–∫—É!',
                'drawingCleared': '–•–æ–ª—Å—Ç –æ—á–∏—â–µ–Ω. –†–∏—Å—É–Ω–æ–∫ —É–¥–∞–ª–µ–Ω.',
                'exportSuccess': '–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!',
                'importSuccess': '–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!',
                // Modal & Editor
                'newNoteModalTitle': '–ù–æ–≤–∞—è –ó–∞–º–µ—Ç–∫–∞',
                'noteTitlePlaceholder': '‚ú® –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏...',
                'noteContentPlaceholder': '‚úçÔ∏è –ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å —Å–≤–æ–∏ –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–µ –∏–¥–µ–∏...',
                'colorIndicatorTitle': 'üé® –¶–≤–µ—Ç–Ω–æ–π –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ó–∞–º–µ—Ç–∫–∏',
                'tagsTitle': 'üè∑Ô∏è –¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)',
                'tagsPlaceholder': '–Ω–∞–ø—Ä., –≤–∞–∂–Ω–æ, –∏–¥–µ—è, –±–∞–≥-v1',
                'historyBtn': '‚è≥ –ò—Å—Ç–æ—Ä–∏—è',
                'deleteBtn': 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å',
                'bookmarkBtn': '‚≠ê –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ',
                'bookmarkedBtn': '‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º',
                'saveNoteBtn': 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ó–∞–º–µ—Ç–∫—É',
                'editorDrawBtn': 'üé® –†–∏—Å–æ–≤–∞—Ç—å',
                'editorImageBtn': 'üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                'editorFileBtn': 'üìé –§–∞–π–ª',
                'editorPasteBtn': 'üìã –í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞',
                'editorStatusDrawingSaved': '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫ –µ—Å—Ç—å.',
                'editorStatusDrawingNone': '–ù–µ—Ç —Ä–∏—Å—É–Ω–∫–∞.',
                'canvasClearBtn': 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å',
                'canvasSaveBtn': 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –†–∏—Å—É–Ω–æ–∫',
                'canvasBrushSize': '–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏:',
                'clipboardTitle': 'üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ë—É—Ñ–µ—Ä–∞ –û–±–º–µ–Ω–∞',
                'clipboardInsertBtn': '‚ú® –í—Å—Ç–∞–≤–∏—Ç—å –≤ –ó–∞–º–µ—Ç–∫—É',
                'attachmentsTitle': 'üìé –í–ª–æ–∂–µ–Ω–∏—è',
                'attachmentClickToDelete': '(–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è)',
                'folderModalTitle': '‚ú® –ù–æ–≤–∞—è –ü–∞–ø–∫–∞',
                'folderNamePlaceholder': 'üìÅ –ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏...',
                'folderColorTitle': 'üé® –í—ã–±–µ—Ä–∏—Ç–µ –¶–≤–µ—Ç –ò–∫–æ–Ω–∫–∏',
                'folderCreateBtn': '‚ú® –°–æ–∑–¥–∞—Ç—å –ü–∞–ø–∫—É',
                'whyUsModalTitle': 'üåü –ü–æ—á–µ–º—É CloudNotes v2.3?',
                'whyUsHeading': '–í–∞—à–∏ –î–∞–Ω–Ω—ã–µ. –í–∞—à –ö–æ–Ω—Ç—Ä–æ–ª—å. –í—Å–µ–≥–¥–∞.',
                'whyUsSubheading': '–ú—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ CloudNotes v1 –Ω–∞ –ø—Ä–æ—Å—Ç–æ–º –ø—Ä–∏–Ω—Ü–∏–ø–µ: <strong>–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ—Å—Ç–æ—Ç–∞</strong>.',
                'whyUsCard1Title': 'üîí –ê–±—Å–æ–ª—é—Ç–Ω–∞—è –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å',
                'whyUsCard1Text': '–ú—ã <strong>–Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º, –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º –∏ –Ω–µ –ø—Ä–æ–¥–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</strong>. –í—Å–µ, —á—Ç–æ –≤—ã –ø–∏—à–µ—Ç–µ –∏–ª–∏ —Ä–∏—Å—É–µ—Ç–µ, –æ—Å—Ç–∞–µ—Ç—Å—è <strong>–ø—Ä–∏–≤–∞—Ç–Ω—ã–º</strong> –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ. –ö—Ä—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–ì–∏–≥–∞–Ω—Ç—ã) <strong>–ø—Ä–æ–¥–∞—é—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é. (–∏ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Ç–æ–∂–µ!)</strong>. <strong>–ú—ã (CloudNotes) –ø—Ä–æ–¥–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç—É –∏ –≤–∞–π–±.</strong> –ù–∞—à–∏ —Ü–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è <strong>–ö–∞–∂–¥–æ–≥–æ</strong>',
                'whyUsCard2Title': 'üö´ –ù–æ–ª—å –ê–∫–∫–∞—É–Ω—Ç–æ–≤',
                'whyUsCard2Text': '–ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ, –∏–º–µ–Ω–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ –ø–∞—Ä–æ–ª—è—Ö. <strong>–ù–∏–∫–∞–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</strong>, –Ω–∏–∫–∞–∫–∏—Ö –≤—Ö–æ–¥–æ–≤, –∏ –Ω–∏–∫–∞–∫–æ–≥–æ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ –¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏.',
                'whyUsCard3Title': '‚ö°Ô∏è –ë—ã—Å—Ç—Ä–æ –∏ –ù–∞–¥–µ–∂–Ω–æ',
                'whyUsCard3Text': '–ü–æ—Å–∫–æ–ª—å–∫—É –≤–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è <strong>–ª–æ–∫–∞–ª—å–Ω–æ</strong> –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ, –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ. –í—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç–µ –æ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞.',
                'whyUsCard4Title': 'üìù –ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä',
                'whyUsCard4Text': '–ù–∞—à —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤–∫–ª—é—á–∞–µ—Ç <strong>—Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞</strong>, –ø–æ–ª–Ω—ã–π <strong>—Ö–æ–ª—Å—Ç –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è</strong> –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å <strong>–≤–ª–æ–∂–µ–Ω–∏—è</strong>, –ø—Ä–∏ —ç—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω—è—è –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–π–Ω–µ –∏ –ª–æ–∫–∞–ª—å–Ω–æ.',
                'whyUsFooter': 'CloudNotes v2.3: –ü—Ä–æ—Å—Ç–æ–µ, –º–æ—â–Ω–æ–µ –∏ –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫.',
                'historyModalTitle': '‚è≥ –ò—Å—Ç–æ—Ä–∏—è –í–µ—Ä—Å–∏–π',
                'historyLoading': '–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...',
                'historyWarning': '*–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–º–µ—Ç–∫–∏.',
                // PRO Message
                'proMessageTitlePro': 'üîì –î–æ—Å—Ç—É–ø PRO!',
                'proMessageTitleLock': 'üîí –¢—Ä–µ–±—É–µ—Ç—Å—è PRO-–¥–æ—Å—Ç—É–ø',
                'proMessageTextPro': '–≠—Ç–∞ –ø–∞–ø–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è PRO-–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. –ü–æ–ª—É—á–∏—Ç–µ PRO-—Å—Ç–∞—Ç—É—Å, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ —ç—Ç–∞ –ø–∞–ø–∫–∞ –¥–ª—è –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è!',
                'proMessageActionBtn': '‚ú® –ü–æ–ª—É—á–∏—Ç—å PRO-—Å—Ç–∞—Ç—É—Å —Å–µ–π—á–∞—Å (–î–µ–º–æ)',
                'proMessageClose': '–ó–∞–∫—Ä—ã—Ç—å',
                // Alerts/Prompts
                'alertNoFolderName': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏.',
                'alertNoNoteContent': '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–º–µ—Ç–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.',
                'alertSelectFolder': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É, –ø—Ä–µ–∂–¥–µ —á–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É.',
                'confirmDeleteFolder': '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–∞–ø–∫—É –∏ –í–°–ï –∑–∞–º–µ—Ç–∫–∏ –≤ –Ω–µ–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.',
                'confirmDeletePermanent': '–í–ù–ò–ú–ê–ù–ò–ï: –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É –ù–ê–í–°–ï–ì–î–ê? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û.',
                'alertNoRestoreFolder': '–ù–µ—Ç –ø–∞–ø–æ–∫ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏.',
                'alertClipboardError': '–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±—É—Ñ–µ—Ä—É –æ–±–º–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –±—Ä–∞—É–∑–µ—Ä–∞ –µ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.'
            }
        };

        // --- DATA STRUCTURE ---
        let data = {
            folders: [
                { id: 1, name: '–†–∞–±–æ—Ç–∞', i18nKey: 'folderWork', color: '#6366f1', notes: [] },
                { id: 2, name: '–î–æ–º', i18nKey: 'folderHome', color: '#10b981', notes: [] },
                { id: 3, name: '–í–µ—Å–µ–ª—ã–µ –ü—Ä–æ–µ–∫—Ç—ã :)', i18nKey: 'folderFunProjects', color: '#f59e0b', notes: [] }
            ],
            trash: [], // –ö–æ—Ä–∑–∏–Ω–∞
            TRASH_ID: -1, 
            PLANNING_ID: -2, // –ü–∞–ø–∫–∞ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (PRO Feature)
            isPro: false, 
            sortOrder: 'updatedDesc', 
            currentFolder: null,
            currentNote: null,
            currentLang: 'ru', // NEW: Current Language
            nextFolderId: 4,
            nextNoteId: 1
        };

        // --- GLOBAL STATE ---
        let canvas, ctx, isDrawing = false;
        let selectedColor = '#6366f1'; 
        let selectedNoteColor = 'transparent'; 
        let drawingData = null;
        let currentBookmark = false;
        let clipboardContent = '';
        
        // --- LOCALIZATION FUNCTIONS ---

        /** –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –∫–ª—é—á –Ω–∞ —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫. */
        function translate(key, replacements = {}) {
            let text = translations[data.currentLang][key] || translations['en'][key] || `[${key}]`;
            for (const [k, v] of Object.entries(replacements)) {
                text = text.replace(`{${k}}`, v);
            }
            return text;
        }

        /** –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM —Å –∞—Ç—Ä–∏–±—É—Ç–æ–º data-i18n. */
        function updateUI(lang) {
            data.currentLang = lang;
            document.documentElement.lang = lang;
            document.getElementById('langSelect').value = lang;
            
            // 1. Static Text Elements
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key) {
                    element.textContent = translate(key);
                }
            });
            
            // 2. Placeholders
            document.getElementById('searchInput').setAttribute('placeholder', translate('searchPlaceholder'));
            document.getElementById('noteTitle').setAttribute('placeholder', translate('noteTitlePlaceholder'));
            document.getElementById('noteContent').setAttribute('placeholder', translate('noteContentPlaceholder'));
            document.getElementById('noteTags').setAttribute('placeholder', translate('tagsPlaceholder'));
            document.getElementById('folderName').setAttribute('placeholder', translate('folderNamePlaceholder'));
            
            // 3. Dynamic Elements (that need text update after translation)
            updateProStatusDisplay();
            updateEmptyStateText();
            updateBookmarkButton();
            
            // For select options, update the display text while keeping the value
            document.querySelectorAll('#sortSelect option').forEach(option => {
                const key = option.getAttribute('data-i18n');
                if (key) {
                    option.textContent = translate(key);
                }
            });
            
            // Re-render folders/notes to apply translated names/buttons
            renderFolders();
            renderNotes(data.currentFolder);
            saveData();
        }

        /** –°–º–µ–Ω–∞ —è–∑—ã–∫–∞. */
        function changeLanguage(lang) {
            updateUI(lang);
        }

        // --- UTILITY FUNCTIONS ---
        
        /** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ data –≤ Local Storage. */
        function saveData() {
            try {
                const theme = document.body.getAttribute('data-theme') || 'light';
                const dataToSave = {
                    ...data,
                    theme: theme
                };
                localStorage.setItem('cloudNotesData', JSON.stringify(dataToSave));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }
        
        /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Local Storage. */
        function loadData() {
            try {
                const savedData = localStorage.getItem('cloudNotesData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    
                    data.folders = parsed.folders || data.folders;
                    data.trash = parsed.trash || data.trash;
                    data.isPro = parsed.isPro !== undefined ? parsed.isPro : data.isPro; 
                    data.sortOrder = parsed.sortOrder || data.sortOrder;
                    data.currentFolder = parsed.currentFolder;
                    data.currentLang = parsed.currentLang || 'ru'; // NEW: Load language
                    data.nextFolderId = parsed.nextFolderId || data.nextFolderId;
                    data.nextNoteId = parsed.nextNoteId || data.nextNoteId;
                    
                    if (parsed.theme) {
                        document.body.setAttribute('data-theme', parsed.theme);
                        document.getElementById('themeToggle').textContent = 
                            parsed.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }

        /** –ù–∞—Ö–æ–¥–∏—Ç –ø–∞–ø–∫—É –ø–æ ID. */
        function getFolder(folderId) {
            if (folderId === data.TRASH_ID) return { id: data.TRASH_ID, name: translate('folderTrash'), icon: 'üóëÔ∏è', color: 'var(--danger)', notes: data.trash };
            if (folderId === data.PLANNING_ID) return { 
                id: data.PLANNING_ID, 
                name: translate('folderPlanning'), 
                icon: 'üóìÔ∏è', 
                color: 'var(--warning)', 
                notes: getPlanningNotes(), 
                isProLocked: !data.isPro 
            };
            const folder = data.folders.find(f => f.id === folderId);
            // Translate default folders
            if (folder && folder.i18nKey) {
                folder.name = translate(folder.i18nKey);
            }
            return folder;
        }
        
        /** NEW: –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è. */
        function updateEmptyStateText() {
            const folder = getFolder(data.currentFolder);
            let text = translate('emptySelectFolder');
            if (folder) {
                if (folder.id === data.TRASH_ID) {
                    text = translate('emptyFolderTrash');
                } else if (folder.id === data.PLANNING_ID && folder.isProLocked) {
                    text = translate('proLockedMessage');
                } else if (folder.notes.length === 0) {
                    text = translate('emptyFolderNotes');
                }
            }
            document.getElementById('emptyStateText').textContent = text;
        }

        /** NEW: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫ –¥–ª—è –ø–∞–ø–∫–∏ "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" (–î–ª—è –¥–µ–º–æ) */
        function getPlanningNotes() {
            if (!data.planningNotes) {
                data.planningNotes = [
                    { id: 9001, title: '–ó–∞–ø—É—Å–∫ v3.0 / v3.0 Launch', content: '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–ª–∞–Ω –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ –∏ —Ñ–∏—á–∏ / Prepare marketing plan and features.', tags: ['–ø—Ä–æ–µ–∫—Ç', '–≤–∞–∂–Ω–æ', 'project', 'important'], color: '#a855f7', bookmarked: true, created: Date.now() - 86400000 * 2, updated: Date.now() - 86400000 * 2, history: [] },
                    { id: 9002, title: '–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ / Competitor Analysis', content: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –£–¢–ü / Conduct market analysis and determine USP.', tags: ['–∞–Ω–∞–ª–∏–∑', 'analysis'], color: '#60a5fa', bookmarked: false, created: Date.now() - 86400000 * 1, updated: Date.now() - 86400000 * 1, history: [] }
                ];
            }
            return data.planningNotes;
        }

        /** –ù–∞—Ö–æ–¥–∏—Ç –∑–∞–º–µ—Ç–∫—É –ø–æ ID –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ. */
        function getNote(noteId) {
            const currentFolder = getFolder(data.currentFolder);
            if (!currentFolder) return null;

            if (currentFolder.id === data.PLANNING_ID) {
                 return getPlanningNotes().find(n => n.id === noteId);
            }

            return currentFolder.notes.find(n => n.id === noteId);
        }

        /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –¥–µ–π—Å—Ç–≤–∏–∏ (–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ/–£–¥–∞–ª–µ–Ω–æ). */
        function showIndicator(messageKey, type = 'success') {
            const indicator = document.createElement('div');
            indicator.className = 'save-indicator';
            indicator.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
            indicator.innerHTML = `${type === 'success' ? '‚úÖ' : 'üóëÔ∏è'} ${translate(messageKey)}`;
            document.body.appendChild(indicator);

            setTimeout(() => {
                indicator.style.opacity = '0';
                indicator.style.transform = 'translateY(-20px)';
                indicator.addEventListener('transitionend', () => indicator.remove());
            }, 2000);
        }
        
        /** –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞—Ç—É. */
        function formatDate(timestamp) {
             const locale = data.currentLang === 'en' ? 'en-US' : 'ru-RU';
             return new Date(timestamp).toLocaleDateString(locale, { 
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
             });
        }
        
        // --- PRO LOGIC ---
        function updateProStatusDisplay() {
            const statusText = data.isPro ? 'PRO' : 'Standard';
            document.getElementById('proStatus').innerHTML = translate('proStatus', { status: `<span style="color: ${data.isPro ? 'var(--success)' : 'var(--danger)'};">${statusText}</span>` });
            
            const proBtn = document.getElementById('proBtn');
            proBtn.textContent = data.isPro ? translate('proBtnActive') : translate('proBtnInactive');
            proBtn.style.background = data.isPro ? 'var(--accent)' : 'var(--warning)';
        }

        function toggleProStatus() {
            data.isPro = !data.isPro;
            saveData();
            updateProStatusDisplay();
            renderFolders();
            if (data.currentFolder === data.PLANNING_ID) {
                 renderNotes(data.PLANNING_ID); // Re-render to unlock/lock planning folder view
            }
            showIndicator(data.isPro ? 'proStatusEnabled' : 'proStatusDisabled', data.isPro ? 'success' : 'danger');
        }
        
        function openProMessageModal(titleKey, textKey) {
             const isLock = titleKey.includes('Lock');
             document.getElementById('proMessageTitle').textContent = translate(isLock ? 'proMessageTitleLock' : 'proMessageTitlePro');
             document.getElementById('proMessageText').innerHTML = translate('proMessageTextPro');
             document.getElementById('proMessageActionBtn').textContent = translate('proMessageActionBtn');
             document.getElementById('proMessageModal').classList.add('active');
        }

        function closeProMessageModal() {
            document.getElementById('proMessageModal').classList.remove('active');
        }


        // --- RENDER FUNCTIONS ---
        
        /** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–∞–ø–æ–∫ –∏ –∫–æ—Ä–∑–∏–Ω—É. */
        function renderFolders() {
            const container = document.getElementById('foldersContainer');
            container.innerHTML = '';
            
            // System Folders (Planning & Trash)
            const systemFolders = document.createElement('div');
            systemFolders.className = 'system-folders';
            
            // 1. Planning Folder (PRO)
            const planningFolder = getFolder(data.PLANNING_ID);
            systemFolders.appendChild(createFolderElement(planningFolder));

            // 2. Trash Folder
            const trashFolder = getFolder(data.TRASH_ID);
            systemFolders.appendChild(createFolderElement(trashFolder));

            container.appendChild(systemFolders);

            // User-Created Folders
            data.folders.forEach(folder => {
                const translatedFolder = getFolder(folder.id);
                container.appendChild(createFolderElement(translatedFolder));
            });
            
            updateProStatusDisplay();
        }

        /** –°–æ–∑–¥–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–∞–ø–∫–∏ DOM. */
        function createFolderElement(folder) {
            const isTrash = folder.id === data.TRASH_ID;
            const isPlanning = folder.id === data.PLANNING_ID;
            const notes = folder.notes;
            
            const folderElement = document.createElement('div');
            folderElement.className = `folder-item ${data.currentFolder === folder.id ? 'active' : ''} ${isTrash ? 'trash-item' : ''} ${isPlanning && folder.isProLocked ? 'pro-locked' : ''}`;
            folderElement.setAttribute('data-folder-id', folder.id);
            folderElement.onclick = () => selectFolder(folder.id);
            
            const iconBg = isTrash ? 'white' : folder.color;
            const iconColor = isTrash ? folder.color : 'white';
            
            folderElement.innerHTML = `
                <div class="folder-icon" style="background: ${iconBg}; color: ${iconColor};">
                    ${folder.icon || 'üìÅ'}
                </div>
                <div class="folder-name">
                    ${folder.name} 
                    ${isPlanning && folder.isProLocked ? '<span class="lock-icon">üîí</span>' : ''}
                </div>
                <div class="folder-count" style="background: ${isTrash ? 'rgba(255, 255, 255, 0.4)' : folder.color}">${notes.length}</div>
            `;
            
            // Add right-click context menu listener for user folders (not system folders)
            if (!isTrash && !isPlanning) {
                 folderElement.oncontextmenu = (e) => openFolderContextMenu(e, folder.id);
            }

            return folderElement;
        }
        
        /** –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø–∞–ø–∫–∏ (—É–¥–∞–ª–µ–Ω–∏–µ). */
        function openFolderContextMenu(e, folderId) {
            e.preventDefault();
            
            const menu = document.createElement('div');
            menu.style.position = 'fixed';
            menu.style.left = `${e.clientX}px`;
            menu.style.top = `${e.clientY}px`;
            menu.style.background = 'var(--bg-secondary)';
            menu.style.border = '1px solid var(--border)';
            menu.style.borderRadius = '8px';
            menu.style.padding = '5px 0';
            menu.style.zIndex = '10000';
            menu.style.boxShadow = '0 4px 12px var(--shadow)';
            
            const deleteItem = document.createElement('div');
            deleteItem.textContent = translate('deleteFolderContextMenu');
            deleteItem.style.padding = '10px 15px';
            deleteItem.style.cursor = 'pointer';
            deleteItem.style.color = 'var(--danger)';
            deleteItem.onmouseover = () => deleteItem.style.background = 'var(--accent-light)';
            deleteItem.onmouseout = () => deleteItem.style.background = 'none';
            deleteItem.onclick = () => {
                deleteFolder(folderId);
                menu.remove();
            };
            
            menu.appendChild(deleteItem);
            document.body.appendChild(menu);
            
            const closeMenu = (event) => {
                if (!menu.contains(event.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            document.addEventListener('click', closeMenu);
        }

        /** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∑–∞–º–µ—Ç–∫–∏ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ. */
        function renderNotes(folderId) {
            const container = document.getElementById('contentArea');
            const folder = getFolder(folderId);
            
            if (!folder) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìÇ</div><div class="empty-text" id="emptyStateText">${translate('emptySelectFolder')}</div></div>`;
                document.getElementById('totalNotes').textContent = 0;
                return;
            }
            
            // NEW: PRO Lock check
            if (folder.id === data.PLANNING_ID && folder.isProLocked) {
                 container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîí</div>
                        <div class="empty-text" id="emptyStateText">${translate('proLockedMessage')}</div>
                        <button class="why-us-btn" style="width: auto; margin-top: 20px;" onclick="openProMessageModal('proMessageTitleLock', 'proMessageTextPro')">${translate('proBtnInactive')}</button>
                    </div>`;
                 document.getElementById('totalNotes').textContent = 0;
                 return;
            }

            // Get notes for rendering (either regular notes, trash, or planning notes)
            let notes = folder.notes;
            const isTrash = folder.id === data.TRASH_ID;
            
            // Search filtering
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                notes = notes.filter(note => 
                    note.title.toLowerCase().includes(searchTerm) || 
                    note.content.toLowerCase().includes(searchTerm) ||
                    (note.tags && note.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
                );
            }

            // Sorting
            notes.sort((a, b) => {
                switch (data.sortOrder) {
                    case 'updatedDesc': return b.updated - a.updated;
                    case 'updatedAsc': return a.updated - b.updated;
                    case 'createdDesc': return b.created - a.created;
                    case 'titleAsc': return a.title.localeCompare(b.title);
                    case 'bookmarked':
                        if (a.bookmarked && !b.bookmarked) return -1;
                        if (!a.bookmarked && b.bookmarked) return 1;
                        return b.updated - a.updated; // Fallback sort
                    default: return b.updated - a.updated;
                }
            });

            document.getElementById('totalNotes').textContent = folder.notes.length;

            if (notes.length === 0) {
                 container.innerHTML = `<div class="empty-state"><div class="empty-icon">${isTrash ? 'üßπ' : 'üí°'}</div><div class="empty-text" id="emptyStateText">${isTrash ? translate('emptyFolderTrash') : translate('emptyFolderNotes')}</div></div>`;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'notes-grid';
            
            notes.forEach(note => {
                grid.appendChild(createNoteCard(note, isTrash));
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        /** –°–æ–∑–¥–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–º–µ—Ç–∫–∏ DOM. */
        function createNoteCard(note, isTrash) {
            const card = document.createElement('div');
            const isSpaceTheme = note.color === 'space';
            
            const indicatorColor = isSpaceTheme ? '#3b82f6' : (note.color === 'transparent' ? 'var(--accent)' : note.color);
            
            card.className = `note-card ${isSpaceTheme ? 'space-bg' : ''}`;
            card.style.cssText = `--note-indicator-color: ${indicatorColor};`;
            card.setAttribute('data-note-id', note.id);
            card.onclick = () => openNote(note.id);
            
            const tagsHtml = (note.tags || []).map(tag => `<span class="note-tag-display">${tag}</span>`).join('');

            let metaHtml = `
                <div class="note-meta ${isTrash ? 'trash-note-meta' : ''}">
                    ${isTrash ? `
                        <button class="btn btn-success" onclick="event.stopPropagation(); restoreNote(${note.id})">${translate('noteRestoreBtn')}</button>
                        <button class="btn" style="background: var(--danger); color: white;" onclick="event.stopPropagation(); permanentlyDeleteNote(${note.id})">${translate('noteDeletePermanentBtn')}</button>
                    ` : `
                        <span class="note-badge">${getFolder(data.currentFolder).name}</span>
                        <span class="note-date">${translate('sortUpdatedDesc').split(' ')[0]}: ${formatDate(note.updated)}</span>
                    `}
                </div>
            `;
            
            let bookmarkBtn = '';
            if (!isTrash) {
                 bookmarkBtn = `
                    <button class="bookmark-btn ${note.bookmarked ? 'bookmarked' : ''}" 
                            onclick="event.stopPropagation(); toggleBookmarkOnCard(${note.id})">
                        ${note.bookmarked ? '‚òÖ' : '‚òÜ'}
                    </button>
                 `;
            }

            card.innerHTML = `
                ${bookmarkBtn}
                <div class="note-title">${note.title || '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ / No Title'}</div>
                <div class="note-tags-display">${tagsHtml}</div>
                <div class="note-preview">${note.content.substring(0, 100).replace(/<[^>]*>/g, '').trim()}${note.content.length > 100 ? '...' : ''}</div>
                ${metaHtml}
            `;

            return card;
        }

        /** –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–º–µ—Ç–∫–∏. */
        function toggleBookmarkOnCard(noteId) {
            const folder = getFolder(data.currentFolder);
            if (!folder) return;
            const note = folder.notes.find(n => n.id === noteId);
            if (note) {
                note.bookmarked = !note.bookmarked;
                saveData();
                renderNotes(data.currentFolder);
                showIndicator(note.bookmarked ? 'bookmarkAdded' : 'bookmarkRemoved');
            }
        }
        
        // --- ACTION HANDLERS ---
        
        /** –í—ã–±–æ—Ä –ø–∞–ø–∫–∏. */
        function selectFolder(folderId) {
            const folder = getFolder(folderId);
            
            if (folder.id === data.PLANNING_ID && folder.isProLocked) {
                openProMessageModal('proMessageTitleLock', 'proMessageTextPro');
                return; 
            }
            
            data.currentFolder = folderId;
            data.currentNote = null;
            saveData();
            renderFolders();
            renderNotes(folderId);
        }

        /** –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏ (–æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞). */
        function createFolder() {
            document.getElementById('folderName').value = '';
            selectedColor = '#6366f1';
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.color-option[data-color="#6366f1"]`).classList.add('selected');
            document.getElementById('folderModal').classList.add('active');
        }

        /** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏. */
        function saveFolderModal() {
            const name = document.getElementById('folderName').value.trim();
            if (!name) {
                alert(translate('alertNoFolderName'));
                return;
            }

            const newFolder = {
                id: data.nextFolderId++,
                name: name,
                color: selectedColor,
                notes: []
            };

            data.folders.push(newFolder);
            saveData();
            renderFolders();
            selectFolder(newFolder.id);
            closeFolderModal();
            showIndicator('folderCreatedSuccess');
        }
        
        /** –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏. */
        function deleteFolder(folderId) {
            if (confirm(translate('confirmDeleteFolder'))) {
                data.folders = data.folders.filter(f => f.id !== folderId);
                
                if (data.currentFolder === folderId) {
                    data.currentFolder = data.folders.length > 0 ? data.folders[0].id : null;
                }
                
                saveData();
                renderFolders();
                renderNotes(data.currentFolder);
                showIndicator('folderDeletedSuccess', 'danger');
            }
        }

        /** –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–∞–ø–∫–∏. */
        function closeFolderModal() {
            document.getElementById('folderModal').classList.remove('active');
        }
        
        /** –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –ø–∞–ø–∫–∏. */
        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedColor = element.getAttribute('data-color');
        }

        /** NEW: –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ. */
        function updateBookmarkButton() {
            const btn = document.getElementById('bookmarkBtn');
            if (btn) {
                btn.textContent = currentBookmark ? translate('bookmarkedBtn') : translate('bookmarkBtn');
            }
        }

        /** –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏. */
        function openNewNote() {
            if (!data.currentFolder || data.currentFolder === data.TRASH_ID) {
                alert(translate('alertSelectFolder'));
                return;
            }
            if (data.currentFolder === data.PLANNING_ID && !data.isPro) {
                openProMessageModal('proMessageTitleLock', 'proMessageTextPro');
                return; 
            }

            data.currentNote = null;
            
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteTags').value = '';
            document.getElementById('attachmentsGrid').innerHTML = '';
            document.getElementById('modalTitle').textContent = translate('newNoteModalTitle');
            document.getElementById('noteDeleteBtn').style.display = 'none';
            document.getElementById('historyBtn').style.display = 'none';
            currentBookmark = false;
            updateBookmarkButton();
            drawingData = null;
            selectedNoteColor = 'transparent';

            document.getElementById('noteContent').style.fontFamily = 'Arial';
            document.getElementById('noteContent').style.fontSize = '16px';
            document.getElementById('fontFamily').value = 'Arial';
            document.getElementById('fontSize').value = '16';
            
            document.querySelectorAll('.note-color-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.note-color-option[data-color="transparent"]`).classList.add('selected');
            document.getElementById('noteModal').querySelector('.modal-content').style.background = 'var(--bg-secondary)';
            document.getElementById('noteModal').classList.add('active');
        }
        
        /** –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–º–µ—Ç–∫–∏. */
        function openNote(noteId) {
            data.currentNote = noteId;
            const note = getNote(noteId);
            if (!note) return;

            const modalContent = document.getElementById('noteModal').querySelector('.modal-content');
            modalContent.style.background = note.color === 'space' ? '#0D0F16' : 'var(--bg-secondary)';
            
            document.getElementById('modalTitle').textContent = note.title || translate('newNoteModalTitle');
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteTags').value = (note.tags || []).join(', ');
            
            document.getElementById('historyBtn').style.display = (note.history && note.history.length > 0) ? 'inline-block' : 'none';

            renderAttachments(note.attachments || []);
            
            document.getElementById('noteContent').style.fontFamily = note.fontFamily || 'Arial';
            document.getElementById('noteContent').style.fontSize = `${note.fontSize || 16}px`;
            document.getElementById('fontFamily').value = note.fontFamily || 'Arial';
            document.getElementById('fontSize').value = note.fontSize || 16;
            
            currentBookmark = note.bookmarked || false;
            updateBookmarkButton();
            
            drawingData = note.drawing || null;
            const statusKey = drawingData ? 'editorStatusDrawingSaved' : 'editorStatusDrawingNone';
            document.getElementById('drawingStatus').textContent = translate(statusKey);

            selectedNoteColor = note.color || 'transparent';
            document.querySelectorAll('.note-color-option').forEach(el => {
                el.classList.remove('selected');
                if (el.getAttribute('data-color') === selectedNoteColor) {
                    el.classList.add('selected');
                }
            });
            
            const isTrash = data.currentFolder === data.TRASH_ID;
            document.getElementById('noteDeleteBtn').style.display = 'inline-block';
            document.getElementById('noteDeleteBtn').textContent = isTrash ? translate('noteDeletePermanentBtn') : translate('deleteBtn');

            document.getElementById('noteModal').classList.add('active');
        }
        
        /** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏. */
        function saveNote() {
            const folder = getFolder(data.currentFolder);
            if (!folder) {
                alert(translate('alertSelectFolder'));
                return;
            }
            
            const title = document.getElementById('noteTitle').value.trim() || translate('newNoteModalTitle');
            const content = document.getElementById('noteContent').value.trim();
            const tagsInput = document.getElementById('noteTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            
            if (!content) {
                alert(translate('alertNoNoteContent'));
                return;
            }

            const now = Date.now();
            const fontFamily = document.getElementById('noteContent').style.fontFamily;
            const fontSize = parseInt(document.getElementById('noteContent').style.fontSize.replace('px', '')) || 16;
            
            if (data.currentNote !== null) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–º–µ—Ç–∫–∏
                let note = folder.notes.find(n => n.id === data.currentNote);
                if (note) {
                    if (note.title !== title || note.content !== content) {
                         if (!note.history) note.history = [];
                         note.history.unshift({
                             title: note.title,
                             content: note.content,
                             updated: note.updated,
                             attachments: note.attachments ? JSON.parse(JSON.stringify(note.attachments)) : []
                         });
                         if (note.history.length > 10) note.history.pop();
                    }
                    
                    note.title = title;
                    note.content = content;
                    note.tags = tags;
                    note.updated = now;
                    note.fontFamily = fontFamily;
                    note.fontSize = fontSize;
                    note.bookmarked = currentBookmark;
                    note.drawing = drawingData;
                    note.color = selectedNoteColor;
                    
                    showIndicator('noteUpdateSuccess');
                }
            } else {
                // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏
                const newNote = {
                    id: data.nextNoteId++,
                    title: title,
                    content: content,
                    tags: tags,
                    created: now,
                    updated: now,
                    attachments: getAttachmentsFromGrid(),
                    fontFamily: fontFamily,
                    fontSize: fontSize,
                    bookmarked: currentBookmark,
                    drawing: drawingData,
                    color: selectedNoteColor,
                    history: []
                };
                folder.notes.push(newNote);
                data.currentNote = newNote.id; 
                document.getElementById('noteDeleteBtn').style.display = 'inline-block'; 
                
                showIndicator('noteCreateSuccess');
            }
            
            saveData();
            renderNotes(data.currentFolder);
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('historyBtn').style.display = 'inline-block';
        }

        /** –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –≤ –ö–æ—Ä–∑–∏–Ω—É. */
        function deleteNote() {
            const folder = getFolder(data.currentFolder);
            if (!folder || data.currentNote === null) return;
            
            if (folder.id === data.TRASH_ID) {
                permanentlyDeleteNote(data.currentNote);
                return;
            }

            if (confirm(translate('confirmDeleteFolder'))) {
                const noteIndex = folder.notes.findIndex(n => n.id === data.currentNote);
                if (noteIndex !== -1) {
                    const noteToTrash = folder.notes.splice(noteIndex, 1)[0];
                    noteToTrash.deletedTime = Date.now(); 
                    data.trash.push(noteToTrash);
                    
                    data.currentNote = null;
                    saveData();
                    renderFolders();
                    renderNotes(data.currentFolder);
                    closeNoteModal();
                    showIndicator('noteTrashSuccess', 'danger');
                }
            }
        }
        
        /** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –∏–∑ –ö–æ—Ä–∑–∏–Ω—ã. */
        function restoreNote(noteId) {
            const noteIndex = data.trash.findIndex(n => n.id === noteId);
            if (noteIndex !== -1) {
                const noteToRestore = data.trash.splice(noteIndex, 1)[0];
                
                let targetFolder = data.folders.find(f => f.id === data.currentFolder) || data.folders[0]; 
                
                if (targetFolder) {
                    targetFolder.notes.push(noteToRestore);
                    saveData();
                    renderFolders();
                    renderNotes(data.TRASH_ID); 
                    showIndicator('noteRestoreSuccess');
                } else {
                    alert(translate('alertNoRestoreFolder'));
                    data.trash.push(noteToRestore); 
                }
            }
        }
        
        /** –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏. */
        function permanentlyDeleteNote(noteId) {
            if (confirm(translate('confirmDeletePermanent'))) {
                
                let targetArray = data.currentFolder === data.TRASH_ID ? data.trash : getFolder(data.currentFolder).notes;
                
                const index = targetArray.findIndex(n => n.id === noteId);
                if (index !== -1) {
                    targetArray.splice(index, 1);
                    data.currentNote = null;
                    saveData();
                    renderFolders();
                    renderNotes(data.currentFolder);
                    closeNoteModal();
                    showIndicator('noteDeletePermanentSuccess', 'danger');
                }
            }
        }

        /** –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–º–µ—Ç–∫–∏. */
        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            document.getElementById('noteModal').querySelector('.modal-content').style.background = 'var(--bg-secondary)'; 
        }

        /** –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –∑–∞–º–µ—Ç–∫–∏. */
        function selectNoteColor(element) {
            document.querySelectorAll('.note-color-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedNoteColor = element.getAttribute('data-color');
            
            const modalContent = document.getElementById('noteModal').querySelector('.modal-content');
            
            if (selectedNoteColor === 'space') {
                 modalContent.style.background = '#0D0F16';
            } else {
                 modalContent.style.background = 'var(--bg-secondary)'; 
            }
        }
        
        // --- EDITOR STYLES ---
        
        /** –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∏–ª—å (—à—Ä–∏—Ñ—Ç, —Ä–∞–∑–º–µ—Ä) —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞. */
        function updateEditorStyle() {
            const editor = document.getElementById('noteContent');
            const fontFamily = document.getElementById('fontFamily').value;
            const fontSize = document.getElementById('fontSize').value;
            
            editor.style.fontFamily = fontFamily;
            editor.style.fontSize = `${fontSize}px`;
        }

        // --- DRAWING CANVAS LOGIC ---
        
        /** –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å —Ö–æ–ª—Å—Ç–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è. */
        function toggleDrawing() {
            const container = document.getElementById('canvasContainer');
            const isVisible = container.style.display === 'block';
            container.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                if (!canvas) {
                    canvas = document.getElementById('drawingCanvas');
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                    ctx = canvas.getContext('2d');
                    
                    canvas.addEventListener('mousedown', startDrawing);
                    canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('mouseup', stopDrawing);
                    canvas.addEventListener('mouseout', stopDrawing);
                    
                    canvas.addEventListener('touchstart', (e) => {
                         e.preventDefault(); 
                         startDrawing(e.touches[0]);
                    }, { passive: false });
                    canvas.addEventListener('touchmove', (e) => {
                         e.preventDefault(); 
                         draw(e.touches[0]);
                    }, { passive: false });
                    canvas.addEventListener('touchend', stopDrawing);
                }
                
                loadDrawing();
            }
        }
        
        /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫ –Ω–∞ —Ö–æ–ª—Å—Ç. */
        function loadDrawing() {
            clearCanvas(false); 
            if (drawingData) {
                const img = new Image();
                img.onload = () => {
                    const scaleX = canvas.width / img.width;
                    const scaleY = canvas.height / img.height;
                    const scale = Math.min(scaleX, scaleY);
                    
                    const drawWidth = img.width * scale;
                    const drawHeight = img.height * scale;
                    const x = (canvas.width / 2) - (drawWidth / 2);
                    const y = (canvas.height / 2) - (drawHeight / 2);
                    
                    ctx.drawImage(img, x, y, drawWidth, drawHeight);
                };
                img.src = drawingData;
                document.getElementById('drawingStatus').textContent = translate('editorStatusDrawingSaved');
            } else {
                 document.getElementById('drawingStatus').textContent = translate('editorStatusDrawingNone');
            }
        }
        
        /** –ù–∞—á–∏–Ω–∞–µ—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏–µ. */
        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.moveTo(x, y);
            draw(e);
        }
        
        /** –†–∏—Å—É–µ—Ç –ª–∏–Ω–∏—é. */
        function draw(e) {
            if (!isDrawing || !ctx) return;
            
            ctx.strokeStyle = document.getElementById('drawColor').value;
            ctx.lineWidth = document.getElementById('drawSize').value;
            ctx.lineCap = 'round';
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        /** –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏–µ. */
        function stopDrawing() {
            isDrawing = false;
            ctx.closePath();
        }
        
        /** –û—á–∏—â–∞–µ—Ç —Ö–æ–ª—Å—Ç. */
        function clearCanvas(clearData = true) {
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            if (clearData) {
                 drawingData = null;
                 document.getElementById('drawingStatus').textContent = translate('drawingCleared');
            }
        }
        
        /** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–∏—Å—É–Ω–æ–∫ –≤ –∑–∞–º–µ—Ç–∫—É –∫–∞–∫ Base64. */
        function saveDrawing() {
            if (!canvas) return;
            drawingData = canvas.toDataURL('image/png');
            document.getElementById('drawingStatus').textContent = translate('drawingSavedSuccess');
        }

        // --- ATTACHMENTS LOGIC ---
        
        /** –î–æ–±–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∑–∞–º–µ—Ç–∫—É. */
        function addImage() {
            const files = document.getElementById('imageUpload').files;
            processFiles(files, 'image');
        }

        /** –î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª –≤ –∑–∞–º–µ—Ç–∫—É. */
        function addFile() {
            const files = document.getElementById('fileUpload').files;
            processFiles(files, 'file');
        }

        /** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã. */
        function processFiles(files, type) {
            if (!data.currentNote && !data.currentFolder) {
                alert(translate('alertSelectFolder'));
                return;
            }
            
            const note = data.currentNote !== null ? getNote(data.currentNote) : { attachments: [] }; 
            if (!note.attachments) note.attachments = [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const newAttachment = {
                        id: Date.now() + Math.random(), 
                        name: file.name,
                        type: type, 
                        data: e.target.result 
                    };
                    
                    note.attachments.push(newAttachment);
                    
                    if (data.currentNote !== null) {
                        saveData();
                        renderAttachments(note.attachments);
                        showIndicator('attachmentAddedSuccess');
                    } else {
                        renderAttachments(note.attachments);
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        /** –£–¥–∞–ª—è–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–µ. */
        function removeAttachment(attachmentId) {
            const note = getNote(data.currentNote);
            if (!note || !note.attachments) return;

            note.attachments = note.attachments.filter(a => a.id !== attachmentId);
            saveData();
            renderAttachments(note.attachments);
            showIndicator('attachmentRemovedSuccess', 'danger');
        }

        /** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–∏—è –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ. */
        function renderAttachments(attachments) {
            const grid = document.getElementById('attachmentsGrid');
            grid.innerHTML = '';
            
            attachments.forEach(att => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                item.onclick = () => removeAttachment(att.id); 
                
                let icon = 'üìé';
                if (att.type === 'image') icon = 'üñºÔ∏è';
                else if (att.name.toLowerCase().endsWith('.pdf')) icon = 'üìÑ';

                item.innerHTML = `
                    <div class="attachment-icon">${icon}</div>
                    <div class="attachment-name">${att.name}</div>
                    <div style="font-size: 10px; color: var(--danger); margin-top: 5px;">${translate('attachmentClickToDelete')}</div>
                `;
                
                grid.appendChild(item);
            });
        }
        
        /** –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–ª–æ–∂–µ–Ω–∏–π –∏–∑ DOM (–¥–ª—è –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏). */
        function getAttachmentsFromGrid() {
            const note = getNote(data.currentNote);
            return note ? note.attachments : [];
        }
        
        // --- CLIPBOARD LOGIC ---
        
        /** –í—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ –≤ –ø—Ä–µ–≤—å—é. */
        function pasteFromClipboard() {
            navigator.clipboard.readText()
                .then(text => {
                    clipboardContent = text;
                    document.getElementById('clipboardPreview').textContent = text.substring(0, 200) + (text.length > 200 ? '...' : '');
                    document.getElementById('clipboardSection').style.display = 'block';
                    showIndicator('clipboardLoadedSuccess');
                })
                .catch(err => {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞:', err);
                    alert(translate('alertClipboardError'));
                });
        }
        
        /** –í—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–º–µ—Ç–∫–∏. */
        function insertClipboard() {
            const editor = document.getElementById('noteContent');
            editor.value += (editor.value ? '\n\n' : '') + clipboardContent;
            document.getElementById('clipboardSection').style.display = 'none';
            clipboardContent = '';
            showIndicator('clipboardInsertedSuccess');
        }
        
        /** –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ. */
        function toggleBookmark() {
            currentBookmark = !currentBookmark;
            updateBookmarkButton();
        }
        
        // --- THEME TOGGLE ---
        
        /** –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–≤–µ—Ç–ª—É—é/—Ç–µ–º–Ω—É—é —Ç–µ–º—É. */
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            document.getElementById('themeToggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            saveData(); 
        }
        
        // --- DATA IMPORT/EXPORT ---
        
        /** –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ. */
        function exportData() {
             const theme = document.body.getAttribute('data-theme') || 'light';
             const dataToExport = {
                ...data,
                theme: theme
             };
             
             const dataStr = JSON.stringify(dataToExport, null, 2);
             const blob = new Blob([dataStr], { type: 'application/json' });
             const url = URL.createObjectURL(blob);
             
             const a = document.createElement('a');
             a.href = url;
             a.download = `CloudNotes_Backup_${new Date().toISOString().slice(0, 10)}.json`;
             document.body.appendChild(a);
             a.click();
             document.body.removeChild(a);
             URL.revokeObjectURL(url);
             showIndicator('exportSuccess');
        }

        /** –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ. */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm(translate('importConfirm'))) {
                        if (importedData.folders && Array.isArray(importedData.folders)) {
                            data = { 
                                ...data, 
                                ...importedData, 
                                folders: importedData.folders,
                                trash: importedData.trash || [],
                                currentLang: importedData.currentLang || 'ru',
                                nextFolderId: importedData.nextFolderId || data.folders.length + 1,
                                nextNoteId: importedData.nextNoteId || 1000 
                            };
                            
                            const theme = importedData.theme || 'light';
                            document.body.setAttribute('data-theme', theme);
                            document.getElementById('themeToggle').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                            
                            updateUI(data.currentLang); // Update UI after import and language set
                            saveData();
                            renderFolders();
                            renderNotes(data.currentFolder);
                            showIndicator('importSuccess', 'success');
                        } else {
                            alert(translate('importErrorFormat'));
                        }
                    }
                } catch (err) {
                    alert(translate('importErrorParse'));
                    console.error('Import error:', err);
                }
            };
            reader.readAsText(file);
        }
        
        // --- WHY US MODAL ---
        
        function openWhyUsModal() {
            document.getElementById('whyUsModal').classList.add('active');
        }

        function closeWhyUsModal() {
            document.getElementById('whyUsModal').classList.remove('active');
        }
        
        // --- HISTORY MODAL ---
        
        /** –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ—Ä—Å–∏–π. */
        function openHistoryModal() {
            const note = getNote(data.currentNote);
            if (!note || !note.history || note.history.length === 0) return;
            
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            note.history.forEach((version, index) => {
                const item = document.createElement('li');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-item-meta">
                        <strong>${index === 0 ? '–ü–æ—Å–ª–µ–¥–Ω—è—è' : (note.history.length - index) + '-—è'} ${translate('historyVersion')}</strong>
                        <br>
                        ${translate('sortUpdatedDesc').split(' ')[0]}: ${formatDate(version.updated)} 
                        ${version.attachments.length > 0 ? ' | üìé ' + version.attachments.length : ''}
                    </div>
                    <button class="btn btn-warning" onclick="restoreHistoryVersion(${index})" style="padding: 8px 12px;">${translate('noteRestoreBtn')}</button>
                `;
                list.appendChild(item);
            });
            
            document.getElementById('historyModal').classList.add('active');
        }

        /** –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏. */
        function restoreHistoryVersion(index) {
            if (confirm(translate('historyConfirmRestore'))) {
                const note = getNote(data.currentNote);
                if (!note || !note.history) return;
                
                const versionToRestore = note.history[index];
                
                // Add current state to history before overwriting (undo functionality)
                note.history.unshift({
                    title: note.title,
                    content: note.content,
                    updated: note.updated,
                    attachments: note.attachments ? JSON.parse(JSON.stringify(note.attachments)) : []
                });
                
                note.title = versionToRestore.title;
                note.content = versionToRestore.content;
                note.updated = Date.now(); // Update the updated timestamp
                note.attachments = versionToRestore.attachments;

                saveData();
                closeHistoryModal();
                closeNoteModal();
                openNote(data.currentNote); // Re-open note with restored content
                showIndicator('noteRestoreSuccess');
            }
        }

        /** –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏. */
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // --- SEARCH LOGIC ---

        function searchNotes() {
            renderNotes(data.currentFolder);
        }

        // --- INITIALIZATION ---
        
        function init() {
            loadData();
            updateUI(data.currentLang); // Initialize UI with the loaded language
            
            document.getElementById('sortSelect').value = data.sortOrder;
            
            if (data.folders.length > 0 && data.currentFolder === null) {
                data.currentFolder = data.folders[0].id;
            }
            
            renderFolders();
            renderNotes(data.currentFolder);
        }

        // Run initialization
        init();
    </script>
</body>
</html>
